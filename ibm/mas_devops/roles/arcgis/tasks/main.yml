---
# 1. Check for required facts
# -----------------------------------------------------------------------------
# - name: "Fail if AppConnect entitlement username has not been provided"
#   assert:
#     that:
#       - appconnect_entitlement_username is defined
#       - appconnect_entitlement_username != ""
#     fail_msg: "appconnect_entitlement_username property has not been set"

# - name: "Fail if AppConnect entitlement key has not been provided"
#   assert:
#     that:
#       - appconnect_entitlement_key is defined
#       - appconnect_entitlement_key != ""
#     fail_msg: "appconnect_entitlement_key property has not been set"

# - name: "Fail if AppConnect license ID has not been provided"
#   assert:
#     that:
#       - appconnect_license_id is defined
#       - appconnect_license_id != ""
#     fail_msg: "appconnect_license_id property has not been set"

# - name: "Fail if AppConnect dashboard instance name has not been provided"
#   assert:
#     that:
#       - appconnect_dashboard_name is defined
#       - appconnect_dashboard_name != ""
#     fail_msg: "appconnect_dashboard_name property has not been set"

# 2. Check if required operator catalog is installed and ready
# -----------------------------------------------------------------------------
- name: "Lookup ibm-operator-catalog"
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    name: ibm-operator-catalog
    namespace: openshift-marketplace
    kind: CatalogSource
  register: catalog_lookup

- name: "Assert that ibm-operator-catalog is available"
  assert:
    that:
      - catalog_lookup.resources is defined
      - catalog_lookup.resources | length == 1
      - catalog_lookup.resources[0].status.connectionState.lastObservedState is defined
      - catalog_lookup.resources[0].status.connectionState.lastObservedState == "READY"
    fail_msg: "The ibm-operator-catalog is not installed, or is not ready to use.  Run the ibm.mas_devops.ibm_catalogs role, or install the CatalogSource manually."

# 3. Provide Debug information
# -----------------------------------------------------------------------------
- name: "Debug information - IBM Maximo Location Services for Esri "
  debug:
    msg:
      - "Namespace ...................... {{ arcgis_namespace }}"
      - "Channel ........................ {{ arcgis_channel }}"
      - "MAS Instance Id ................ {{ mas_instance_id }}"
      - "MAS Config Dir ................. {{ mas_config_dir }}"

# 4. Create IBM Maximo Location Services project
# -----------------------------------------------------------------------------
- name: "Create IBM Maximo Location Services for Esri namespace"
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: '{{ arcgis_namespace }}'

# 5. Install the operator & create entitlement secret
# -----------------------------------------------------------------------------
- name: "Install IBM Maximo Location Services for Esri Operator"
  include_role:
    name: ibm.mas_devops.install_operator
  vars:
    namespace: "{{ arcgis_namespace }}"
    icr_username: "{{ mas_entitlement_username }}"
    icr_password: "{{ mas_entitlement_key }}"
    catalog_source: "{{ mas_catalog_source }}"
    operator_group: "{{ lookup('template', 'templates/operator-group.yml.j2') }}"
    subscription: "{{ lookup('template', 'templates/subscription.yml.j2') }}"

# 6. Wait until the IBM Maximo Location Services CRD is available
# -----------------------------------------------------------------------------
- name: "Wait until the IBM Maximo Location Services for Esri CRD is available"
  include_tasks: "{{ role_path }}/../../common_tasks/wait_for_crd.yml"
  vars:
    crd_name: arcgisapps.apps.mas.ibm.com

# 7. IBM Maximo Location Services installation
# -----------------------------------------------------------------------------
- name: Create ArcGISApp apps.mas.ibm.com/v1 CR
  vars:
    annotation_dict: "{{ mas_annotations | string | ibm.mas_devops.getAnnotations() }}"
  kubernetes.core.k8s:
    state: present
    namespace: "{{ arcgis_namespace }}"
    template: templates/arcgisapp.yml.j2
  register: arcgisAppResult

- name: debug arcgisAppResult
  debug:
    msg: "{{ arcgisAppResult }}"

# 8. Wait IBM Maximo Location Services custom resource to be complete
# -----------------------------------------------------------------------------
- name: "Wait for ArcGISApp custom resource to be ready (60s delay)"
  kubernetes.core.k8s_info:
    api_version: apps.mas.ibm.com/v1
    name: "{{ mas_instance_id }}"
    namespace: "{{ arcgis_namespace }}"
    kind: ArcGISApp
  register: arcgisapp_cr_result
  until:
    - arcgisapp_cr_result.resources is defined and arcgisapp_cr_result.resources | length == 1
    - arcgisapp_cr_result.resources[0].status is defined
    - arcgisapp_cr_result.resources | json_query('[*].status.conditions[?type==`Successful`][].status') | select ('match','True') | list | length == 1
  retries: 45 # approx 45 minutes before we give up
  delay: 60 # 1 minute

# 9. IBM Maximo Location Services workspace configuration
# -----------------------------------------------------------------------------
- name: Create ArcGISWorkspace apps.mas.ibm.com/v1 CR
  vars:
    annotation_dict: "{{ mas_annotations | string | ibm.mas_devops.getAnnotations() }}"
  kubernetes.core.k8s:
    state: present
    namespace: "{{ arcgis_namespace }}"
    template: templates/arcgisws.yml.j2
  register: arcgisWSResult

- name: debug arcgisWSResult
  debug:
    msg: "{{ arcgisWSResult }}"

# # 10. Retrieve ArcGIS dashboard route
# # -----------------------------------------------------------------------------
# - name: "Lookup '{{ arcgis_manager_ingress_name }}' route"
#   kubernetes.core.k8s_info:
#     kind: Route
#     api_version: route.openshift.io/v1
#     name: "{{ arcgis_ingress_controller_service_name }}"
#     namespace: "{{ arcgis_namespace }}"
#   register: arcgis_manager_route_lookup

# - assert:
#     that:
#       - arcgis_manager_route_lookup.resources is defined
#       - arcgis_manager_route_lookup.resources | length > 0
#       - arcgis_manager_route_lookup.resources[0].spec is defined
#       - arcgis_manager_route_lookup.resources[0].spec.host is defined
#     fail_msg: "Route '{{ arcgis_ingress_controller_service_name }}' was not found under '{{ arcgis_namespace }}' namespace!"

# - set_fact:
#     arcgis_manager_route: "https://{{ arcgis_manager_route_lookup.resources[0].spec.host }}"


# - name: "Arcgis installation finished successfully!"
#   debug:
#     msg:
#       - "Use the following URL to access the ArcGIS Enterprise 11.2 on Openshift and configure your organization:"
#       - ""
#       - "{{ arcgis_manager_route }}/arcgis/manager"
