---
- name: "Read jdbc config file"
  ansible.builtin.set_fact:
    jdbccfg: "{{ lookup('file', '{{ mas_config_dir }}/jdbc-{{ mas_app_id }}-db2u.yml') | from_yaml_all }}"

- name: "Set jdbc mandatory vars"
  ansible.builtin.set_fact:
    jdbccfg:
      username: "{{ jdbccfg[0].data.username }}"
      password: "{{ jdbccfg[0].data.password }}"
      url: "{{ jdbccfg[1].spec.config.url }}"
      sslenabled: "{{ jdbccfg[1].spec.config.sslEnabled }}"
      ca: "{{ jdbccfg[1].spec.certificates | map(attribute='crt') | join(',') | replace(',','\n') }}"

- name: "Debug: jdbc information" #TODO: remove before PR
  debug:
    msg:
      - "JDBC username encoded ..... {{ jdbccfg.username }}"
      - "JDBC password encoded ..... {{ jdbccfg.password }}"
      - "JDBC username ............. {{ jdbccfg.username | b64decode }}"
      - "JDBC password ............. {{ jdbccfg.password | b64decode }}"
      - "JDBC url .................. {{ jdbccfg.url }}"
      - "JDBC sslenabled ........... {{ jdbccfg.sslenabled }}"
      - "JDBC cert ca .............. {{ jdbccfg.ca }}"

- name: "Create secret for JDBC admin credentials"
  kubernetes.core.k8s:
    apply: yes
    template: "templates/jdbc/jdbc-admin-credentials.yml.j2"
