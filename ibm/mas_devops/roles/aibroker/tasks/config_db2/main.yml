---
- name: "Read jdbc config file"
  ansible.builtin.set_fact:
    jdbccfg: "{{ lookup('file', '{{ mas_config_dir }}/jdbc-{{ mas_app_id }}-db2u.yml') | from_yaml_all }}"

- name: "Set dro mandatory vars"
  ansible.builtin.set_fact:
    jdbccfg:
      username: "{{ jdbccfg[0].data.username }}"
      password: "{{ jdbccfg[0].data.password }}"
      url: "{{ jdbccfg[1].spec.config.url | b64encode }}"
      sslenabled: "{{ jdbccfg[1].spec.config.sslEnabled | b64encode }}"
      ca: "{{ jdbccfg[1].spec.certificates | map(attribute='crt') | join(',') | replace(',','\n') | b64encode }}"

- name: "Debug: jdbc information" #TODO: remove before PR
  debug:
    msg:
      - "JDBC username ............. {{ jdbccfg.username }}"
      - "JDBC password ............. {{ jdbccfg.password }}"
      - "JDBC url .................. {{ jdbccfg.url }}"
      - "JDBC cert ca .............. {{ jdbccfg.ca }}"

- name: "Create secret for JDBC admin credentials"
  kubernetes.core.k8s:
    apply: yes
    template: "templates/jdbc/jdbc-admin-credentials.yml.j2"
