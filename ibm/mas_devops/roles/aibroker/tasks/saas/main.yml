---
- name: "Check if API key secret exists in namespace: {{ mas_aibroker_provision_tenant }}"
  k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ mas_aibroker_provision_tenant }}----apikey-secret"
    namespace: "{{ aibroker_namespace }}"
  register: apikey_secret_info

- name: Create API Key
  script: "{{ role_path }}/files/create_apikey.sh {{ mas_aibroker_provision_tenant }} {{ aibroker_namespace }}"
  when:
    - apikey_secret_info.resources | length == 0

- name: "Lookup tenant {{ mas_aibroker_provision_tenant }} api key"
  shell: oc get secret {{ mas_aibroker_provision_tenant }}----apikey-secret -n {{ aibroker_namespace }} -o json | jq -r '.data.AIBROKER_APIKEY' | base64 -d
  register: provision_tenant_api_key_output

- name: "Set aibroker api key variable"
  set_fact:
    provision_tenant_api_key: "{{ provision_tenant_api_key_output.stdout }}"

# - name: Debug {{ mas_aibroker_provision_tenant }} api key #TODO: remove on final commit
#   debug:
#     msg: "Provision tenant api key: {{ provision_tenant_api_key }}"
