---
- name: Load variables (main)
  include_vars: "vars/main.yml"

# Get cluster domain
# -----------------------------------------------------------------------------
- name: "Get cluster domain"
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: DNS
    name: cluster
  register: _cluster_dns

- name: "Set fact: cluster domain"
  set_fact:
    cluster_domain: "{{ _cluster_dns.resources[0].spec.baseDomain }}"

- name: "Debug: cluster domain"
  debug:
    msg: "Cluster domain ........................ {{ cluster_domain }}"

# Create IBM Maximo IBM Maximo AI Broker
# -----------------------------------------------------------------------------
- name: "Create IBM Maximo AI Broker namespace"
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ aibroker_namespace }}"

# Create config for SLS
- include_tasks: tasks/config_sls/main.yml

# Create config for DRO
- include_tasks: tasks/config_dro/main.yml

# Create config for DB2
- include_tasks: tasks/config_db2/main.yml

# install AI Broker api
- include_tasks: tasks/aibroker/main.yml

# run api calls for aibroker saas
- include_tasks: tasks/saas/main.yml
  when: mas_aibroker_saas == true

# create AI Broker tenant
# - include_tasks: tasks/tenant/main.yml

# TODO: this is workaround for create tenant role - remove this once create AI Broker tenant task done and enabled
# Create tenant namespace
- name: "Check if tenant namespace: {{ tenantNamespace }} exists"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ tenantNamespace }}"
  register: namespace_info

# Create tenant namespace
- name: "Create a tenant namespace: {{ tenantNamespace }}"
  kubernetes.core.k8s:
    name: "{{ tenantNamespace }}"
    api_version: v1
    kind: Namespace
  when:
    - namespace_info.resources | length == 0

# create AI Broker api key
- include_tasks: tasks/apikey/main.yml

# create s3 api key
- include_tasks: tasks/s3/main.yml

# create wx api
- include_tasks: tasks/watsonx/main.yml
