---
# This checks if ibm-common-services-operator is installed and if so retrieves the channel that is installed i.e 'v4.3'
- name: "Check if ibm-common-service-operator is installed"
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    field_selector: metadata.name=ibm-common-service-operator
    all_namespaces: true
    host: "{{ ocp_auth_host | default(omit) }}"
    api_key: "{{ ocp_auth_api_key | default(omit) }}"
    validate_certs: "{{ ocp_auth_validate_certs | default(omit) }}"
  register: common_services_sub_info

- name: "Extract channel info"
  set_fact:
    common_services_sub_channel_info:
      stdout: "{{ common_services_sub_info.resources[0].spec.channel | default('') if common_services_sub_info.resources | length > 0 else '' }}"

- name: "Set existing ibm-common-service-operator channel"
  set_fact:
    cpfs_installed_channel: "{{ common_services_sub_channel_info.stdout | regex_search(regex) }}"
  vars:
    regex: "(?<=v)(.*)"

- debug:
    var: cpfs_installed_channel

- name: "Check if ibm-common-service-operator v4 is installed"
  set_fact:
    is_v4_installed: "{{ cpfs_installed_channel is defined and cpfs_installed_channel is version('4.0','>=') }}"
  when:
    - cpfs_installed_channel is defined
    - cpfs_installed_channel | length > 0

- name: "Debug - IBM Common Services action: {{ common_services_action }}"
  debug:
    msg:
      - "IBM Common Services current channel installed ................. {{ cpfs_installed_channel | default('None', true) }}"

# If common services is already installed with version equal/higher than v4, then skip common services v3 installation
- name: "Execute the chosen action"
  ansible.builtin.include_tasks:
    file: "tasks/actions/{{ common_services_action }}.yml"
  when:
    - common_services_action != "none"
    - not is_v4_installed
