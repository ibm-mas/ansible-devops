---
- name: Load variables (main)
  include_vars: "vars/main.yml"

# Get cluster domain
# -----------------------------------------------------------------------------
- name: "Get cluster subdomain"
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Ingress
    name: cluster
  register: _cluster_subdomain

- name: "Set default cluster subdomain from ingress"
  when: aiservice_domain | length == 0
  set_fact:
    aiservice_domain: "{{ _cluster_subdomain.resources[0].spec.domain }}"

- name: "Debug: cluster domain"
  debug:
    msg: "AI Service domain ........................ {{ aiservice_domain }}"

- name: "Debug: certificate issuer if defined"
  when: aiservice_certificate_issuer is defined and aiservice_certificate_issuer != ''
  debug:
    msg:
      - "AI Service Certificate Issuer ........................... {{ aiservice_certificate_issuer }}"
      - "AI Service Certificate Duration ......................... {{ aiservice_certificate_duration }}"
      - "AI Service Certificate Renew Before ..................... {{ aiservice_certificate_renew_before }}"

# Create IBM Maximo AI Service namespace
# -----------------------------------------------------------------------------
- name: "Create IBM Maximo AI Service namespace"
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ aiservice_namespace }}"

# Create secret for S3
- include_tasks: tasks/s3/main.yml

# Create config for DRO
- include_tasks: tasks/config_dro/main.yml

# Create config for DB2
- include_tasks: tasks/config_db2/main.yml

# Create config for WX
- include_tasks: tasks/config_wx/main.yml

# install AI Broker api
- include_tasks: tasks/aiservice/main.yml
