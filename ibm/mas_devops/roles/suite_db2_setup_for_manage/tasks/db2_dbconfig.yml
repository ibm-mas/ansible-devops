---
- name: "Fail if db2_instance_name is not provided"
  when: db2_instance_name is not defined or db2_instance_name == ""
  fail:
    msg: "db2_instance_name property is required"

- name: Set DB2 ConfigMap name
  set_fact:
    db2_config_name: "{{db2_instance_name | lower}}-enforce-config"

- name: Read versioned-config status from configmap
  set_fact:
    db2_cfg: "{{  query('k8s', kind='ConfigMap', api_version='v1', resource_name=db2_config_name, namespace=db2_namespace) }}"

- name: Get version of DB2 config we applied
  set_fact:
    db2_configured_version: "{{ db2_cfg | first | json_query('data.version') }}"
  when:
  - db2_cfg | length > 0

#In legacy mode this updates the CR which (apparently) didn't alter the database
#In helm mode we run a script which applies the settings but many don't take effect until a restart 
- include_tasks: tasks/apply-db2-versioned-config.yml
  when:
  - db2_config_version is defined
  - db2_config_version != ""
  - db2_cfg | length == 0 or db2_configured_version != db2_config_version

- include_tasks: tasks/legacy-apply-db2-config-settings.yml
  when:
  - not db2_helm_operator_mode
  - enforce_db2_config is defined
  - enforce_db2_config

- include_tasks: tasks/restart-db2-enforce-config.yml
  when:
  - db2_helm_operator_mode
  - enforce_db2_config is defined
  - enforce_db2_config
