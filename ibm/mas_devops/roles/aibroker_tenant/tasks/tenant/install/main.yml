---
- name: "Check if tenant namespace: {{ tenantNamespace }} exists"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ tenantNamespace }}"
  register: namespace_info

# Create tenant namespace
- name: "Create a tenant namespace: {{ tenantNamespace }}"
  kubernetes.core.k8s:
    name: "{{ tenantNamespace }}"
    api_version: v1
    kind: Namespace
  when:
    - namespace_info.resources | length == 0

- name: "Create tenant CR"
  vars:
    annotation_dict: "{{ mas_annotations | string | ibm.mas_devops.getAnnotations() }}"
  kubernetes.core.k8s:
    state: present
    namespace: "{{ aibroker_namespace }}"
    template: templates/aibroker/aibrokerworkspace.yml.j2

- name: "Wait for tenant CR to be ready"
  kubernetes.core.k8s_info:
    api_version: apps.mas.ibm.com/v1
    name: "{{ tenantNamespace }}"
    namespace: "{{ aibroker_namespace }}"
    kind: AiBrokerWorkspace
  register: aibrokerworkspace_cr_result
  until:
    - aibrokerworkspace_cr_result.resources is defined and aibrokerworkspace_cr_result.resources | length == 1
    - aibrokerworkspace_cr_result.resources[0].status is defined
    - aibrokerworkspace_cr_result.resources | json_query('[*].status.conditions[?type==`Successful`][].status') | select ('match','True') | list | length == 1
  retries: 45 # approx 45 minutes before we give up
  delay: 60 # 1 minute

# Copy secrets to tenant namespace
- name: "Copy secrets to namespace: {{ tenantNamespace }}"
  shell: 'oc get secret {{ item }} -n mas-{{ mas_instance_id }}-aibroker -o yaml | sed "s/namespace: .*/namespace: {{ tenantNamespace }}/" | oc apply --force -f -'
  with_items:
    - km-s3-secret
    - "{{ pullSecretName }}"

# Adding inference server runtimes
- name: "Create config map for connector config"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/connector-configmap.yml.j2') }}"

- name: "Create SA for server runtimes"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/km-s3-sa.yml.j2') }}"

- name: "Create huggingfaceserver server runtime"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/kserve-huggingfaceserver.yml.j2') }}"

- name: "Create lgbserver server runtime"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/kserve-lgbserver.yml.j2') }}"

- name: "Create sklearnserver server runtime"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/kserve-sklearnserver.yml.j2') }}"

- name: "Create xgbserver server runtime"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/kserve-xgbserver.yml.j2') }}"

# Applay RBAC roles
- name: "Apply RBAC for tenant"
  kubernetes.core.k8s:
    apply: yes
    definition: "{{ lookup('template', 'templates/tenant/rbac.yml.j2') }}"

- name: "Check if SLS key secret exists in namespace: {{ aibroker_namespace }}"
  k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ tenantNamespace }}----sls-secret"
    namespace: "{{ aibroker_namespace }}"
  register: sls_secret_info

# If sls secret does not exist then create one.
- when:
    - sls_secret_info.resources | length == 0
    - mas_aibroker_saas == true
  block:
    - name: "Create cert location {{ mas_aibroker_path_ca_crt }}"
      shell: mkdir -p '{{ mas_aibroker_path_ca_crt }}'

    - name: "Insert SLS cert ca to file located {{ mas_aibroker_path_ca_crt }}"
      shell: "echo '{{ slscfg.ca }}' > '{{ mas_aibroker_path_ca_crt }}/sls_ca.crt' "

    - name: debug #TODO: remove before final commit
      debug:
        msg:
          - "tenantNamespace ..... {{ tenantNamespace }} "
          - "mas_instance_id ..... {{ mas_instance_id }} "
          - "mas_aibroker_sls_url ..... {{ slscfg.url }} "
          - "mas_aibroker_sls_registration_key ..... {{ slscfg.registration_key }} "
          - "mas_aibroker_path_ca_crt ..... {{ mas_aibroker_path_ca_crt }} "

    - name: Create SLS secret
      script: "{{ role_path }}/files/create_sls_secret.sh {{ role_path }} {{ tenantNamespace }} {{ mas_instance_id }} {{ slscfg.url }} {{ slscfg.registration_key }} {{ mas_aibroker_path_ca_crt }}/sls_ca.crt"
      register: sls_secret_output

    - name: Debug Create sls secret for AI Broker
      debug:
        msg: "{{ sls_secret_output }}"

- name: Delete DRO secret
  command: oc delete secret "{{ tenantNamespace }}----dro-secret" -n {{ aibroker_namespace }}
  register: delete_result
  ignore_errors: yes
  failed_when: delete_result.rc != 0 and "NotFound" not in delete_result.stderr

- name: Create DRO token
  script: "{{ role_path }}/files/create_dro_token.sh {{ tenantNamespace }} {{ mas_instance_id }} {{ drocfg.registration_key }}"
  register: dro_token_output

- name: Debug Create DRO token
  debug:
    msg: "{{ dro_token_output }}"

# - name: Wait for service /service/rest/api/v1/tenant #need more accurate way to check if service working
#   pause:
#     minutes: 8
#     prompt: "Waiting for for service /service/rest/api/v1/tenant"

- name: Await to aibroker-api pod created
  pause:
    minutes: 3
    prompt: "Waiting for aibroker-api pod"

- name: "Wait for aibroker-api pod"
  shell: oc  wait --for=condition=ready pod -l app=aibroker-api -n {{ aibroker_namespace }}
  register: _is_not_exists
  until: _is_not_exists.stdout|int == 0
  retries: 60
  delay: 30

- name: "Wait for aibroker-api pod to be ready (30s delay)"
  shell: >
    oc get pod -l app=aibroker-api -n {{ aibroker_namespace }} --no-headers=true | grep -Evi "1/1|2/2|3/3|4/4|5/5|6/6|7/7|8/8|9/9|complete" | wc -l
  register: _is_not_ready
  until: _is_not_ready.stdout|int == 0
  retries: 60
  delay: 30

- name: Lookup the aibroker route
  kubernetes.core.k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: "{{ aibroker.name }}"
    namespace: "{{ aibroker_namespace }}"
    wait: yes
    wait_timeout: 30
  register: aibrokerRoute

- name: Set aibroker route host
  ansible.builtin.set_fact:
    aibrokerHostName: "{{ aibrokerRoute.resources[0].spec.host }}"

- name: Debug aibrokerRoute
  debug:
    msg: "{{ aibrokerHostName }}"

- name: Register DRO and SLS with AI Broker for tenant "{{ tenantNamespace }}"
  uri:
    url: "https://{{ aibrokerHostName }}/ibm/aibroker/service/rest/api/v1/tenant"
    validate_certs: no
    method: POST
    headers:
      apikey: "{{ provision_tenant_api_key }}"
      accept: "*/*"
      Content-Type: "application/json"
      tenantid: "{{ mas_aibroker_provision_tenant }}"
    body_format: "json"
    body: "{\"tenant_name\": \"{{ tenantNamespace }}\",
      \"sls_url\": \"{{ aibrokerworkspace_cr_result.resources[0].spec.settings.sls.url }}\",
       \"dro_url\": \"{{ aibrokerworkspace_cr_result.resources[0].spec.settings.dro.url }}\",
      \"subscription_id\": \"{{ mas_aibroker_sls_subscription_id }}\", \"dro_tenant_id\": \"{{ mas_aibroker_dro_tenant_id }}\"}"
    status_code: [204, 409]
    timeout: 30
  register: register_tenant

- name: Warn if tenant exists
  when: register_tenant.status == 409
  debug:
    msg: Warning - tenant {{ tenantNamespace }} is already registered with AI Broker

- name: Register entitlement to Similarity model for tenant "{{ tenantNamespace }}"
  uri:
    url: "https://{{ aibrokerHostName }}/ibm/aibroker/service/rest/api/v1/tenantEntitlements"
    validate_certs: no
    method: POST
    headers:
      apikey: "{{ provision_tenant_api_key }}"
      accept: "*/*"
      Content-Type: "application/json"
      tenantid: "{{ mas_aibroker_provision_tenant }}"
    body_format: "json"
    body: "{\"tenant_name\": \"{{ tenantNamespace }}\", \"entitlement_type\": \"standard\", \"model_type\": \"similarity\", \"entitlement_start_date\": \"2025-01-01\", \"entitlement_end_date\": \"2026-01-01\"}"
    status_code: [201]
    timeout: 30
  register: add_tenant_entitlements_to_db2

- name: Register entitlement to PCC model for tenant "{{ tenantNamespace }}"
  uri:
    url: "https://{{ aibrokerHostName }}/ibm/aibroker/service/rest/api/v1/tenantEntitlements"
    validate_certs: no
    method: POST
    headers:
      apikey: "{{ provision_tenant_api_key }}"
      accept: "*/*"
      Content-Type: "application/json"
      tenantid: "{{ mas_aibroker_provision_tenant }}"
    body_format: "json"
    body: "{\"tenant_name\": \"{{ tenantNamespace }}\", \"entitlement_type\": \"standard\", \"model_type\": \"pcc\", \"entitlement_start_date\": \"2025-01-01\", \"entitlement_end_date\": \"2026-01-01\"}"
    status_code: [201]
    timeout: 30
  register: add_tenant_entitlements_to_db2_pcc

- name: Register entitlement to MCC model for tenant "{{ tenantNamespace }}"
  uri:
    url: "https://{{ aibrokerHostName }}/ibm/aibroker/service/rest/api/v1/tenantEntitlements"
    validate_certs: no
    method: POST
    headers:
      apikey: "{{ provision_tenant_api_key }}"
      accept: "*/*"
      Content-Type: "application/json"
      tenantid: "{{ mas_aibroker_provision_tenant }}"
    body_format: "json"
    body: "{\"tenant_name\": \"{{ tenantNamespace }}\", \"entitlement_type\": \"standard\", \"model_type\": \"mcc\", \"entitlement_start_date\": \"2025-01-01\", \"entitlement_end_date\": \"2026-01-01\"}"
    status_code: [201]
    timeout: 30
  register: add_tenant_entitlements_to_db2_mcc

- name: Debug tenant entitlement #TODO: remove on final commit
  debug:
    msg: "{{ add_tenant_entitlements_to_db2_mcc }}"
