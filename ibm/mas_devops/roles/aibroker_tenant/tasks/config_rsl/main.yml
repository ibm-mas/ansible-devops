---
- name: Check if RSL CA certificate file exists
  stat:
    path: "{{ mas_config_dir }}/rsl/ca.crt"
  register: rsl_ca_file_result

- name: Read RSL CA cert from file
  ansible.builtin.set_fact:
    rsl_ca_crt: "{{ lookup('file', '{{ mas_config_dir }}/rsl/ca.crt') }}"
  when: rsl_ca_file_result.stat.exists

- name: Read RSL CA cert from environment
  ansible.builtin.set_fact:
    rsl_ca_crt: "{{ lookup('env', 'RSL_CA_CRT') }}"
  when: not rsl_ca_file_result.stat.exists

- name: "Check if all RSL config values are present"
  ansible.builtin.set_fact:
    rsl_config_valid: "{{ rsl_url | length > 0 and rsl_org_id | length > 0 and rsl_token | length > 0 and rsl_ca_crt | length > 0 }}"

- name: "Set RSL Secret name"
  ansible.builtin.set_fact:
    mas_aibroker_rsl_secret: ""
  when: not rsl_config_valid

- name: "warning about RSL config being incomplete"
  ansible.builtin.debug:
    msg: "WARNING: RSL config is incomplete. Skipping RSL secret creation."
  when: not rsl_config_valid

- name: Create RSL secret
  kubernetes.core.k8s:
    state: present
    namespace: "{{ aibroker_namespace }}"
    template: "templates/rsl/rsl-secret.yml.j2"
  when: rsl_config_valid
