---
- name: Read RSL config from environment
  ansible.builtin.set_fact:
    rslcfg:
      url: "{{ lookup('env', 'RSL_URL') | default('', true) }}"
      org_id: "{{ lookup('env', 'RSL_ORG_ID') | default('', true) }}"
      token: "{{ lookup('env', 'RSL_TOKEN') | default('', true) }}"

- name: "Debug: RSL information" # TODO: remove before PR
  ansible.builtin.debug:
    msg:
      - "rsl url ......... {{ rslcfg.url }}"
      - "rsl org_id ...... {{ rslcfg.org_id }}"

- name: "Check if all RSL config values are present"
  ansible.builtin.set_fact:
    rsl_config_valid: "{{ rslcfg.url | length > 0 and rslcfg.org_id | length > 0 and rslcfg.token | length > 0 }}"

- name: "warning about RSL config being incomplete"
  ansible.builtin.debug:
    msg: "WARNING: RSL configuration is incomplete. Secret will not be created."
    warn: yes
  when: not rsl_config_valid

- name: Create RSL secret
  kubernetes.core.k8s:
    state: present
    namespace: "{{ aibroker_namespace }}"
    template: "templates/rsl/rsl-secret.yml.j2"
  when: rsl_config_valid
