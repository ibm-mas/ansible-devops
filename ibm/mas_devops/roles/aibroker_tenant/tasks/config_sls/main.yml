---
- name: Check if SLS config file exists
  stat:
    path: "{{ mas_config_dir }}/sls.yml"
  register: sls_file_result

- name: Read SLS config from file
  vars:
    sls_file_cfg: "{{ lookup('file', '{{ mas_config_dir }}/sls.yml') | from_yaml_all }}"
  ansible.builtin.set_fact:
    slscfg:
      secret_name: "{{ sls_file_cfg[0].metadata.name }}"
      registration_key: "{{ sls_file_cfg[0].stringData.registrationKey }}"
      url: "{{ sls_file_cfg[1].spec.config.url }}"
      ca: "{{ sls_file_cfg[1].spec.certificates | map(attribute='crt') | join(',') | replace(',','\n') }}"
  when: sls_file_result.stat.exists

- name: Read SLS config from environment
  ansible.builtin.set_fact:
    slscfg:
      secret_name: "{{ lookup('env', 'MAS_AIBROKER_SLS_SECRET_NAME') }}"
      registration_key: "{{ lookup('env', 'MAS_AIBROKER_SLS_REGISTRATION_KEY') }}"
      url: "{{ lookup('env', 'MAS_AIBROKER_SLS_URL') }}"
      ca: "{{ lookup('env', 'MAS_AIBROKER_SLS_CA_CERT') }}"
  when: not sls_file_result.stat.exists

- name: "Debug: sls information" #TODO: remove before PR
  debug:
    msg:
      - "sls secret name ......... {{ slscfg.secret_name }}"
      - "sls registration key .... {{ slscfg.registration_key }}"
      - "sls url ................. {{ slscfg.url }}"
      - "sls cert ca ............. {{ slscfg.ca }}"

- name: "Validate SLS configuration"
  when: slscfg.secret_name | length == 0
  fail:
    msg: "slscfg.secret_name must not empty"

- name: "Validate SLS configuration"
  when: slscfg.registration_key | length == 0
  fail:
    msg: "slscfg.registration_key must not empty"

- name: "Validate SLS configuration"
  when: slscfg.url | length == 0
  fail:
    msg: "slscfg.url must not empty"

- name: "Validate SLS configuration"
  when: slscfg.ca | length == 0
  fail:
    msg: "slscfg.ca must not empty"

# - name: "Create secret for SLS registration key"
#   kubernetes.core.k8s:
#     apply: yes
#     template: "templates/sls/sls-tenant-details.yml.j2"
