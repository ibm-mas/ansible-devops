---
# Define known operand-related CR kinds that commonly block CP4D uninstall
- name: Define operand-related CR kinds to clean
  set_fact:
    operand_cr_kinds:
      - operandrequest
      - operandconfig
      - operandregistry
      - operandbindinfo

# Fetch all operand-related CR instances from operator namespace
- name: Fetch operand CRs for each kind
  kubernetes.core.k8s_info:
    api_version: operator.ibm.com/v1alpha1
    kind: "{{ item | capitalize }}"
    namespace: "{{ cp4d_namespaces[1] }}"
  loop: "{{ operand_cr_kinds }}"
  loop_control:
    label: "{{ item }}"
  register: operand_crs
  failed_when: false

# Force delete operand-related CRs to unblock dependent finalizers
- name: Delete operand-related CRs
  kubernetes.core.k8s:
    api_version: operator.ibm.com/v1alpha1
    kind: "{{ item.1.kind }}"
    namespace: "{{ cp4d_namespaces[1] }}"
    name: "{{ item.1.metadata.name }}"
    state: absent
    force: true
  loop: "{{ operand_crs.results | subelements('resources', skip_missing=True) }}"
  loop_control:
    label: "{{ item.1.metadata.name }}"
  failed_when: false
  register: delete_operands
