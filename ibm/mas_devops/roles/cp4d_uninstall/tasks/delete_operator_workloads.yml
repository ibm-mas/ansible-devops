---
# Discover all Deployments running in CP4D namespaces
- name: Get Deployments in CP4D namespaces
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ ns }}"
  loop: "{{ cp4d_namespaces }}"
  loop_control:
    loop_var: ns
    label: "{{ ns }}"
  register: cp4d_deployments
  failed_when: false
  changed_when: false

# Delete CP4D Deployments to stop running workloads
- name: Delete Deployments
  kubernetes.core.k8s:
    state: absent
    definition: "{{ item }}"
  loop: "{{ cp4d_deployments.results | map(attribute='resources') | list | flatten }}"
  loop_control:
    label: "{{ item.metadata.namespace }}/{{ item.metadata.name }}"
  failed_when: false

# Discover all StatefulSets running in CP4D namespaces
- name: Get StatefulSets in CP4D namespaces
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    namespace: "{{ ns }}"
  loop: "{{ cp4d_namespaces }}"
  loop_control:
    loop_var: ns
    label: "{{ ns }}"
  register: cp4d_statefulsets
  failed_when: false
  changed_when: false

# Delete CP4D StatefulSets to stop persistent workloads
- name: Delete StatefulSets
  kubernetes.core.k8s:
    state: absent
    definition: "{{ item }}"
  loop: "{{ cp4d_statefulsets.results | map(attribute='resources') | list | flatten }}"
  loop_control:
    label: "{{ item.metadata.namespace }}/{{ item.metadata.name }}"
  failed_when: false

# Discover all Jobs created by CP4D in target namespaces
- name: Get Jobs in CP4D namespaces
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    namespace: "{{ ns }}"
  loop: "{{ cp4d_namespaces }}"
  loop_control:
    loop_var: ns
    label: "{{ ns }}"
  register: cp4d_jobs
  failed_when: false
  changed_when: false

# Delete CP4D Jobs to prevent retrying or stuck batch executions
- name: Delete Jobs
  kubernetes.core.k8s:
    state: absent
    definition: "{{ item }}"
  loop: "{{ cp4d_jobs.results | map(attribute='resources') | list | flatten }}"
  loop_control:
    label: "{{ item.metadata.namespace }}/{{ item.metadata.name }}"
  failed_when: false
