---
# remove_operator_cr_finalizers.yml
# Discover CP4D CR instances, clear finalizers/ownerReferences, delete CRs, then delete CRDs.
# Defensive debug outputs and no block-level loops.

- name: Set CP4D target namespaces
  set_fact:
    cp4d_target_namespaces:
      - ibm-cpd
      - ibm-cpd-operators

- name: Load CP4D CRD whitelist from defaults if provided
  set_fact:
    cp4d_crd_whitelist: "{{ cp4d_crd_names | default([]) }}"

- name: Fetch all CustomResourceDefinitions
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
  register: all_crds
  failed_when: false
  changed_when: false

- name: Build cp4d_crds (whitelist if present, else pattern match)
  set_fact:
    cp4d_crds: >-
      {{
        (
          (all_crds.resources | default([]))
          | selectattr('metadata.name','in', cp4d_crd_whitelist)
          | list
        )
        if (cp4d_crd_whitelist | length) > 0
        else
        (all_crds.resources | default([]) | selectattr('metadata.name','search','(cpd|zen|ibm|common-service|operand|namespacescope|bindinfo|operandrequest)') | list)
      }}
  failed_when: false

- name: Debug - CP4D CRDs chosen (safe)
  debug:
    msg:
      - "cp4d_crds_count: {{ (cp4d_crds | default([])) | length }}"
      - "cp4d_crd_names: {{ (cp4d_crds | default([]) | map(attribute='metadata.name') | list) | to_nice_json }}"
  when: cp4d_crds is defined

# Gather CR instances: CRD x Namespace product
- name: Gather CR instances for each CRD x namespace
  kubernetes.core.k8s_info:
    api_version: "{{ (item.0.spec.group) ~ '/' ~ ((item.0.spec.versions | first).name) }}"
    kind: "{{ item.0.spec.names.kind }}"
    namespace: "{{ item.1 }}"
  loop: "{{ (cp4d_crds | default([])) | product(cp4d_target_namespaces) | list }}"
  loop_control:
    label: "{{ item.0.metadata.name }} @ {{ item.1 }}"
  register: crs_listing_raw
  failed_when: false
  changed_when: false

- name: Build cp4d_found_crs fact (flatten discovered resources)
  set_fact:
    cp4d_found_crs: >-
      {{
        (crs_listing_raw.results | default([]) | map(attribute='resources') | list | flatten(1) | default([]))
      }}
  failed_when: false

# - name: Debug - discovered CRs (safe)
#   debug:
#     msg:
#       - "discovered_cr_count: {{ (cp4d_found_crs | default([])) | length }}"
#       - "discovered_sample: >-
#           {{
#             (cp4d_found_crs | default([]))
#             | map(attribute='metadata') | map('extract',['namespace','name']) | list | slice(0,40) | to_nice_json
#           }}"
#   when: cp4d_found_crs is defined

- name: Log - no discovered CRs (moving to static fallback) (info)
  debug:
    msg: "No discovered CP4D CRs found; static fallback will run if configured."
  when: (cp4d_found_crs | length) == 0

# Patch discovered CRs to clear finalizers & ownerReferences (per-item)
- name: Patch discovered CRs to clear finalizers & ownerReferences
  kubernetes.core.k8s:
    api_version: "{{ item.apiVersion }}"
    kind: "{{ item.kind }}"
    name: "{{ item.metadata.name }}"
    namespace: "{{ item.metadata.namespace | default('') }}"
    merge_type: merge
    definition:
      metadata:
        finalizers: []
        ownerReferences: []
  loop: "{{ cp4d_found_crs | default([]) }}"
  loop_control:
    label: "{{ item.kind }} {{ item.metadata.namespace }}/{{ item.metadata.name }}"
  register: patch_results
  failed_when: false
  changed_when: false

- name: Debug - patch_results (safe dump)
  debug:
    msg: "{{ (patch_results | default({})) | to_nice_json }}"
  when: patch_results is defined

# Try normal delete (non-blocking) per discovered CR
- name: Try normal delete of discovered CRs (non-blocking)
  kubernetes.core.k8s:
    api_version: "{{ item.apiVersion }}"
    kind: "{{ item.kind }}"
    name: "{{ item.metadata.name }}"
    namespace: "{{ item.metadata.namespace | default('') }}"
    state: absent
    wait: no
  loop: "{{ cp4d_found_crs | default([]) }}"
  loop_control:
    label: "{{ item.kind }} {{ item.metadata.namespace }}/{{ item.metadata.name }}"
  register: delete_try_results
  failed_when: false
  changed_when: false

- name: Debug - delete_try_results (safe dump)
  debug:
    msg: "{{ (delete_try_results | default({})) | to_nice_json }}"
  when: delete_try_results is defined

# Poll each discovered CR until removed (per-item)
- name: Poll each discovered CR until it is gone (per-item)
  kubernetes.core.k8s_info:
    api_version: "{{ item.apiVersion }}"
    kind: "{{ item.kind }}"
    name: "{{ item.metadata.name }}"
    namespace: "{{ item.metadata.namespace | default('') }}"
  retries: 6
  delay: 8
  register: poll_check_results
  until: (poll_check_results.resources | default([]) | length) == 0
  loop: "{{ cp4d_found_crs | default([]) }}"
  loop_control:
    label: "{{ item.kind }} {{ item.metadata.namespace }}/{{ item.metadata.name }}"
  failed_when: false
  changed_when: false

# - name: Debug - poll_check_results (safe summary)
#   debug:
#     msg:
#       - "poll_check_items: {{ (poll_check_results.results | default([])) | length }}"
#       - "poll_check_sample: >-
#           {{
#             (poll_check_results.results | default([]))
#             | map(attribute='resources') | list | flatten(1)
#             | map(attribute='metadata') | map('extract',['namespace','name']) | list | to_nice_json
#           }}"
#   when: poll_check_results is defined

# Forced delete fallback (per-item)
- name: Force-delete discovered CRs (best-effort fallback)
  kubernetes.core.k8s:
    api_version: "{{ item.apiVersion }}"
    kind: "{{ item.kind }}"
    name: "{{ item.metadata.name }}"
    namespace: "{{ item.metadata.namespace | default('') }}"
    state: absent
    wait: yes
    wait_timeout: 60
    force: yes
  loop: "{{ cp4d_found_crs | default([]) }}"
  loop_control:
    label: "force-delete {{ item.kind }} {{ item.metadata.namespace }}/{{ item.metadata.name }}"
  register: forced_delete_results
  failed_when: false
  changed_when: false

- name: Debug - forced_delete_results (safe dump)
  debug:
    msg: "{{ (forced_delete_results | default({})) | to_nice_json }}"
  when: forced_delete_results is defined

# Static fallback list (explicit known-stuck items); can be overridden by defaults
- name: Ensure cp4d_static_fallback fact exists (default list)
  set_fact:
    cp4d_static_fallback: "{{ cp4d_static_fallback | default([
      {'api': 'namespacescopes.operator.ibm.com/v1', 'kind': 'NamespaceScope', 'name': 'common-service', 'namespace': 'ibm-cpd-operators'},
      {'api': 'operandbindinfos.operator.ibm.com/v1', 'kind': 'OperandBindInfo', 'name': 'ibm-zen-bindinfo', 'namespace': 'ibm-cpd-operators'},
      {'api': 'operandrequest.operator.ibm.com/v1', 'kind': 'OperandRequest', 'name': 'zen-ca-operand-request', 'namespace': 'ibm-cpd-operators'},
      {'api': 'operandrequest.operator.ibm.com/v1', 'kind': 'OperandRequest', 'name': 'zen-service', 'namespace': 'ibm-cpd-operators'}]) }}"

- name: Patch static fallback CRs to clear finalizers/ownerReferences
  kubernetes.core.k8s:
    api_version: "{{ item.api }}"
    kind: "{{ item.kind }}"
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    merge_type: merge
    definition:
      metadata:
        finalizers: []
        ownerReferences: []
  loop: "{{ cp4d_static_fallback }}"
  loop_control:
    label: "{{ item.kind }} {{ item.namespace }}/{{ item.name }}"
  register: fallback_patch_results
  failed_when: false
  changed_when: false

- name: Debug - fallback_patch_results (safe dump)
  debug:
    msg: "{{ (fallback_patch_results | default({})) | to_nice_json }}"
  when: fallback_patch_results is defined

- name: Attempt delete static fallback CRs (wait)
  kubernetes.core.k8s:
    api_version: "{{ item.api }}"
    kind: "{{ item.kind }}"
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    state: absent
    wait: yes
    wait_timeout: 60
  loop: "{{ cp4d_static_fallback }}"
  loop_control:
    label: "{{ item.kind }} {{ item.namespace }}/{{ item.name }}"
  register: fallback_delete_results
  failed_when: false
  changed_when: false

- name: Debug - fallback_delete_results (safe dump)
  debug:
    msg: "{{ (fallback_delete_results | default({})) | to_nice_json }}"
  when: fallback_delete_results is defined

- name: Check which static fallback CRs still exist (per-item)
  kubernetes.core.k8s_info:
    api_version: "{{ item.api }}"
    kind: "{{ item.kind }}"
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
  loop: "{{ cp4d_static_fallback }}"
  loop_control:
    label: "{{ item.kind }} {{ item.namespace }}/{{ item.name }}"
  register: fallback_check_results
  failed_when: false
  changed_when: false

- name: Debug - fallback_check_results (safe summary)
  debug:
    msg:
      - "fallback_check_count: {{ (fallback_check_results.results | default([])) | length }}"
      - "fallback_check_resources_sample: >-
          {{
            (fallback_check_results.results | default([]))
            | map(attribute='resources') | list | flatten(1)
            | map(attribute='metadata') | map('extract',['namespace','name']) | list | to_nice_json
          }}"
  when: fallback_check_results is defined

# If any static fallback still shows up, attempt force-delete them
# - name: Build cp4d_static_remaining (items still present)
#   set_fact:
#     cp4d_static_remaining: >-
#       {{
#         [ cp4d_static_fallback[i]
#           for i in range(0, (fallback_check_results.results | default([]) | length))
#           if (fallback_check_results.results[i].resources | default([]) | length) > 0
#         ]
#       }}
#   failed_when: false
#   when: fallback_check_results is defined

- name: Debug - cp4d_static_remaining (safe)
  debug:
    msg: "{{ (cp4d_static_remaining | default([])) | to_nice_json }}"
  when: cp4d_static_remaining is defined

- name: Force-delete static fallback CRs that remain
  kubernetes.core.k8s:
    api_version: "{{ item.api }}"
    kind: "{{ item.kind }}"
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    state: absent
    wait: yes
    wait_timeout: 60
    force: yes
  loop: "{{ cp4d_static_remaining | default([]) }}"
  loop_control:
    label: "{{ item.kind }} {{ item.namespace }}/{{ item.name }}"
  register: fallback_forced_delete_results
  failed_when: false
  changed_when: false

- name: Debug - fallback_forced_delete_results (safe dump)
  debug:
    msg: "{{ (fallback_forced_delete_results | default({})) | to_nice_json }}"
  when: fallback_forced_delete_results is defined

# Re-scan CRDs and build remaining list for final check
- name: Re-scan CRDs after cleanup attempts
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
  register: post_crds
  failed_when: false
  changed_when: false

- name: Collect remaining CR instances for CP4D CRDs (CRD x namespace)
  kubernetes.core.k8s_info:
    api_version: "{{ (item.0.spec.group) ~ '/' ~ ((item.0.spec.versions | first).name) }}"
    kind: "{{ item.0.spec.names.kind }}"
    namespace: "{{ item.1 }}"
  loop: "{{ (cp4d_crds | default([])) | product(cp4d_target_namespaces) | list }}"
  loop_control:
    label: "{{ item.0.metadata.name }} @ {{ item.1 }}"
  register: remaining_listing
  failed_when: false
  changed_when: false

- name: Consolidate remaining CP4D CRs into cp4d_remaining_crs
  set_fact:
    cp4d_remaining_crs: >-
      {{
        (remaining_listing.results | default([]) | map(attribute='resources') | list | flatten(1) | default([]))
      }}
  failed_when: false

# - name: Debug - cp4d_remaining_crs (safe summary)
#   debug:
#     msg:
#       - "cp4d_remaining_count: {{ (cp4d_remaining_crs | default([])) | length }}"
#       - "cp4d_remaining_sample: >-
#           {{
#             (cp4d_remaining_crs | default([]))
#             | map(attribute='metadata') | map('extract',['namespace','name']) | list | to_nice_json
#           }}"
#   when: cp4d_remaining_crs is defined

# If stuck CRs exist, fail so caller knows (but we keep failed_when default false here to not crash unexpectedly)
# - name: Fail if stuck CP4D CRs remain after sanitization attempts
#   fail:
#     msg: "Stuck CP4D CRs remain after sanitization: {{ cp4d_remaining_crs | map(attribute='metadata') | map('extract',['namespace','name']) | list }}"
#   when: cp4d_remaining_crs is defined and (cp4d_remaining_crs | length) > 0

# Delete CP4D-related CRDs (best-effort; force)
- name: Delete CP4D-related CRDs (best-effort; force)
  kubernetes.core.k8s:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "{{ item.metadata.name }}"
    state: absent
    wait: yes
    force: yes
  loop: "{{ cp4d_crds | default([]) }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  register: delete_crd_results
  failed_when: false

- name: Debug - CRD deletion summary (safe)
  debug:
    msg:
      - "attempted_crd_deletes: {{ (delete_crd_results.results | default([])) | length }}"
      - "delete_crd_results: {{ (delete_crd_results | default({})) | to_nice_json }}"
  when: delete_crd_results is defined
