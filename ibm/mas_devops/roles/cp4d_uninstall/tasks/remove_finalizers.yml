---
# remove_finalisers.yml
# Generic finalizer removal helper for problematic CR kinds using oc (safer on broken CRs)
# Also attempts to delete remaining CR instances forcibly after finalizer removal.

- name: Prepare cr kinds list for oc fallback
  set_fact:
    cr_kinds:
      - operandrequest
      - operandconfig
      - operandregistry
      - operandbindinfo
      - operandbindinfos
      - namespacescope
      - commonservice
      - operandregistries

- name: Remove finalizers from listed CR kinds (oc patch)
  shell: |
    set -e
    for k in {{ cr_kinds | to_json }}; do
      for obj in $(oc get $k -n ibm-cpd-operators -o name 2>/dev/null || true); do
        echo "patching finalizers for $obj"
        oc patch "$obj" -n ibm-cpd-operators --type=json -p='[{"op":"remove","path":"/metadata/finalizers"}]' || true
      done
    done
  register: patch_finalizers
  failed_when: false
  changed_when: false

- name: Debug finalizer patch stdout
  debug:
    msg:
      - "oc patch finalizers stdout: {{ patch_finalizers.stdout_lines | default([]) }}"

- name: Attempt to delete any remaining objects (force) for common CR kinds (oc delete)
  shell: |
    set -e
    for k in {{ cr_kinds | to_json }}; do
      for obj in $(oc get $k -n ibm-cpd-operators -o name 2>/dev/null || true); do
        echo "force-deleting $obj"
        oc delete "$obj" -n ibm-cpd-operators --ignore-not-found --force --grace-period=0 || true
      done
    done
  register: oc_force_delete
  failed_when: false
  changed_when: false

- name: Debug oc force-delete stdout
  debug:
    msg:
      - "oc force-delete stdout: {{ oc_force_delete.stdout_lines | default([]) }}"
