---
# Check if the cluster is in ZooKeeper mode and a migration is needed
- name: "Get the Kafka CR instance"
  kubernetes.core.k8s_info:
    api_version: kafka.strimzi.io/v1beta2
    kind: Kafka
    namespace: "{{ kafka_namespace }}"
    name: "{{ kafka_cluster_name }}"
  register: kafka_cluster_cr

- name: "Fail if Kafka CR not found"
  fail:
    msg: "Kafka instance '{{ kafka_cluster_name }}' not found"
    when: kafka_cluster_cr | length == 0

- name: "Verify that the Kafka instance is in ZooKeeper mode"
  include_tasks: tasks/provider/strimzi/migrate.yml
  when:
    - kafka_cluster_cr.resources[0].status.kafkaMetadataState == "ZooKeeper"


# To upgrade Strimzi, we'll reuse AMQ Streams upgrade code as essentially both use the same resources
- include_tasks: tasks/provider/redhat/upgrade.yml
