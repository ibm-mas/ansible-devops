apiVersion: db2u.databases.ibm.com/v1
kind: Db2uCluster
metadata:
  name: "{{ db2wh_instance_id | lower }}"
  namespace: "{{ cpd_meta_namespace }}"
spec:
  size: 1
  license:
    accept: true
  podConfig:
    db2u:
      resource:
        db2u:
          limits:
            cpu: "{{ db2wh_cpu_limits }}"
            memory: "{{ db2wh_memory_limits }}"
  account:
    privileged: true
  environment:
    database:
      name: "{{db2wh_dbname}}"
      settings:
        dftTableOrg: "{{ db2wh_table_org }}"
      ssl:
        secretName: "internal-tls"
        certLabel: "CN=zen-ca-cert"
    dbType: db2wh
    instance:
      dbmConfig:
        SRVCON_PW_PLUGIN: IBMIAMauthpwfile
        group_plugin: IBMIAMauthgroup
        srvcon_auth: GSS_SERVER_ENCRYPT
        srvcon_gssplugin_list: IBMIAMauth
      registry:
        DB2AUTH: 'OSAUTHDB,ALLOW_LOCAL_FALLBACK,PLUGIN_AUTO_RELOAD'
        DB2_FMP_RUN_AS_CONNECTED_USER: 'NO'
        DB2_WORKLOAD: ANALYTICS
    mln:
      total: 1
  addOns:
    graph: {}
    rest: {}
  advOpts:
    db2SecurityPlugin: cloud_gss_plugin
  version: "{{ db2wh_version }}"
  storage:
    - name: meta
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: "{{ db2wh_system_storage_size }}"
        storageClassName: "{{ db2wh_system_storage_class }}"
      type: create
    - name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "{{ db2wh_user_storage_size }}"
        storageClassName: "{{ db2wh_user_storage_class }}"
      type: template
    - name: backup
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: "{{ db2wh_user_storage_size }}"
        storageClassName: "{{ db2wh_user_storage_class }}"
      type: create
    - name: activelogs
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "{{ db2wh_logs_storage_size }}"
        storageClassName: "{{ db2wh_logs_storage_class }}"
      type: template
    - name: tempts
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: "{{ db2wh_temp_storage_size }}"
        storageClassName: "{{ db2wh_temp_storage_class }}"
      type: template
  volumeSources:
    - visibility:
        - db2u
      volumeSource:
        secret:
          secretName: zen-service-broker-secret
