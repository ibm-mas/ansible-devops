---

# 0. Lookup the version and flavour of OCP that we are targeting
# -----------------------------------------------------------------------------
# In Frye OCP 4.6 we find this configmap named as "openshift-install-manifests"
# In ROKS OCP 4.6 and 4.8 we find this configmap named as "openshift-install"

- name: Get OCP Install Information (openshift-install)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: openshift-install
    namespace: openshift-config
  register: openshift_config

- name: Register OCP install configuration variables (openshift-install)
  when:
    - openshift_config.resources is defined
    - openshift_config.resources | length > 0
  set_fact:
    ocp_install_invoker: "{{ openshift_config.resources[0].data.invoker }}" # Known values: "ROKS"
    ocp_install_version: "{{ openshift_config.resources[0].data.version }}"
    ocp_install_release: "{{ openshift_config.resources[0].data.version | regex_search('[^.]*.[^.]*') }}"

# If we didn't already set the new facts then it means we couldn't find the "openshift-install" configmap
- name: Get OCP Install Information (openshift-install-manifests)
  when: ocp_install_invoker is not defined
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    name: openshift-install-manifests
    namespace: openshift-config
  register: openshift_config

- name: Register OCP install configuration variables (openshift-install-manifests)
  when:
    - ocp_install_invoker is not defined
    - openshift_config.resources is defined
    - openshift_config.resources | length > 0
  set_fact:
    ocp_install_invoker: "{{ openshift_config.resources[0].data.invoker }}" # Known values: "user" (in Fyre)
    ocp_install_version: "{{ openshift_config.resources[0].data.version }}"
    ocp_install_release: "{{ openshift_config.resources[0].data.version | regex_search('[^.]*.[^.]*') }}"

# If we didn't already set the new facts then it means we couldn't find either of the expected configmaps
- name: Fail if we couldn't find the openshift-install or openshift-install-manifests configmaps
  when: ocp_install_invoker is not defined
  fail:
    msg: "We couldn't find either the openshift-install or openshift-install-manifests configmaps in the openshift-config namespace"

- name: Debug OCP install configuration variables
  debug:
    msg:
      - "OCP Install Invoker ................ {{ ocp_install_invoker }}"
      - "OCP Install Version ................ {{ ocp_install_version }}"
      - "OCP Install Release ................ {{ ocp_install_release }}"


# 1. Install Foundation Services
# -----------------------------------------------------------------------------
# This will result in the following operators being installed in the ibm-common-services namespace
# - IBM Cloud Pak Foundational Services
# - IBM NamespaceScope Operator
# - Operand Deployment Lifecycle Manager
#
# Also, an operator group will be created in the namespace if one does not already exist

- name: Check if operator group is present in ibm-common-services already
  k8s_info:
    namespace: ibm-common-services
    kind: OperatorGroup
  register: og_info

- name: "Install Foundation Services"
  kubernetes.core.k8s:
    definition: "{{ lookup('template', 'templates/foundation-services/subscription.yml.j2') }}"
    wait: yes
    wait_timeout: 120

- name: "Wait for Foundation Services resources to be ready (60s delay)"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    name: operand-deployment-lifecycle-manager
    namespace: ibm-common-services
    kind: Deployment
  register: _operand_deployment
  until: _operand_deployment.resources[0].status.availableReplicas is defined
  retries: 90 # Approximately 10 minutes before we give up
  delay: 60 # 1 minute


# 2. Install cert-manager
# -----------------------------------------------------------------------------
- name: Check if Cert Manager is already installed
  kubernetes.core.k8s_info:
    api_version: v1
    name: cert-manager
    namespace: "cert-manager"
    kind: Deployment
  register: _cert_manager_deployed

# Install foundation services cert-manager if MAS 8.7+, otherwise, install jetstack/standalone version
- name: Define which Cert Manager to install
  set_fact:
    cm_version: "{{ 'foundation-services' if (mas_channel not in mas_channels_old_releases) else 'standalone' }}"
  when:
    - (_cert_manager_deployed.resources | length) == 0
    - not airgap_install

- include_tasks: "tasks/certmanager/{{ cm_version }}.yml"
  when:
    - cm_version is defined and cm_version !=''
    - (_cert_manager_deployed.resources | length) == 0
    - not airgap_install


# 3. Install Service Binding Operator
# -----------------------------------------------------------------------------
# Install stable channel with automatic updates if MAS 8.7+, otherwise, install preview channel locked to v0.8

- name: Define which SBO to install
  when:
    - not airgap_install
  set_fact:
    sbo_channel: "{{ 'stable' if (mas_channel not in mas_channels_old_releases and ocp_install_release != '4.6') else 'preview' }}"

- include_tasks: "tasks/sbo/{{ sbo_channel }}.yml"
  when:
    - not airgap_install


# 4. Disable OCP Upgrade
# -----------------------------------------------------------------------------
- name: "Disable OCP Upgrade"
  include_tasks: "tasks/disable-ocp-upgrade.yml"
  when: ocp_disable_upgrade == true
