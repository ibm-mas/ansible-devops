---
# Create WatsonStudioCfg resource manually using provided CP4D credentials
# This is used when CP4D was installed manually without using cp4d_service role

- name: "Check if CP4D credentials are provided"
  assert:
    that:
      - cpd_admin_username is defined and cpd_admin_username != ""
      - cpd_admin_password is defined and cpd_admin_password != ""
      - cpd_admin_url is defined and cpd_admin_url != ""
    fail_msg: |
      ERROR: CP4D credentials are required to create WatsonStudioCfg resource.

      Please set the following environment variables:
      export CPD_ADMIN_USERNAME=<your-cp4d-admin-username>
      export CPD_ADMIN_PASSWORD=<your-cp4d-admin-password>
      export CPD_ADMIN_URL=<your-cp4d-url>

- name: "Create WatsonStudioCfg resource"
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'templates/watsonstudio-cfg.yml.j2') }}"

- name: "Wait for WatsonStudioCfg resource to be created"
  kubernetes.core.k8s_info:
    api_version: config.mas.ibm.com/v1
    kind: WatsonStudioCfg
    name: "{{ mas_instance_id }}-watsonstudio-system"
    namespace: "mas-{{ mas_instance_id }}-core"
  register: watsonstudio_cfg_result
  retries: 10
  delay: 5
  until:
    - watsonstudio_cfg_result.resources is defined
    - watsonstudio_cfg_result.resources | length > 0

- name: "Set watsonstudio_cfg_exists flag"
  set_fact:
    watsonstudio_cfg_exists: true

- name: "Debug WatsonStudioCfg creation"
  debug:
    msg: "WatsonStudioCfg resource created successfully"
