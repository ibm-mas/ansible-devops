---
# IMPORTANT:
# There are two parts to this secret (it really should be two seperate secrets)
# - Database encryption
# - AI Service Configuration
#
# The Database encryption properties will be auto-generated if not provided
# explicitly, and we do not want to replace them each time this runs, so we
# must persist them from an existing secret when updating the AI credentials
# if not also setting explicit values for the encryption fields


# 1. Basic Input Validation
# ------------------------------------------------------------------------
- name: "Validate both crypto and cryptox values are provided"
  when: mas_manage_encryptionsecret_crypto_key != ""
  assert:
    that: mas_manage_encryptionsecret_crypto_key != ""
    msg: "A value must also be provided for mas_manage_encryptionsecret_cryptox_key when setting mas_manage_encryptionsecret_crypto_key"

- name: "Validate both old crypto and cryptox values are provided"
  when: mas_manage_encryptionsecret_old_crypto_key != ""
  assert:
    that: mas_manage_encryptionsecret_old_crypto_key != ""
    msg: "A value must also be provided for mas_manage_encryptionsecret_old_cryptox_key when setting mas_manage_encryptionsecret_old_crypto_key"

- name: "Validate all necessary AI Service values are provided"
  when: mas_manage_encryptionsecret_aiservice_apikey != ""
  assert:
    that:
      - mas_manage_encryptionsecret_aiservice_url != ""
      - mas_manage_encryptionsecret_aiservice_fqn != ""
    msg: "A value must also be provided for mas_manage_encryptionsecret_aiservice_url and mas_manage_encryptionsecret_aiservice_fqn when setting mas_manage_encryptionsecret_aiservice_apikey"


# 2. Check if encryption secret name matches what is in use
# ------------------------------------------------------------------------
# The name of the secret will default to "masdev-manage-encryptionsecret" unless
# overridden in the workspace CR, we will support a user who isn't using the default
# but we will not support changing this on a running system in this role
- name: "Lookup ManageWorkspace CR to check if encryption secret is already setup"
  no_log: true
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ManageWorkspace
    name: "{{ mas_instance_id }}-{{ mas_workspace_id }}"
    namespace: "mas-{{ mas_instance_id }}-manage"
  register: managews_output

- name: "Validate that the encryption secret name is not being changed"
  when:
    - managews_output.resources is defined
    - managews_output.resources | length > 0
    - managews_output.resources[0].spec.settings.db.encryptionSecret is defined
    - managews_output.resources[0].spec.settings.db.encryptionSecret | length > 0
  assert:
    that: mas_manage_ws_db_encryptionsecret == managews_output.resources[0].spec.settings.db.encryptionSecret
    msg: "Changing the value of spec.settings.db.encryptionSecret from '{{ managews_output.resources[0].spec.settings.db.encryptionSecret}}' to '{{ mas_manage_ws_db_encryptionsecret }}' is not supported by this role"


# 3. Determine whether there is an existing secret to backup
# ------------------------------------------------------------------------
- name: "Lookup {{ mas_manage_ws_db_encryptionsecret }}"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ mas_manage_ws_db_encryptionsecret }}"
    namespace: "{{ mas_app_namespace }}"
  no_log: true
  register: encryption_secret_info

- name: "Record the existing crypto & crpytox values"
  set_fact:
    encryption_secret_exists: "{{ encryption_secret_info.resources is defined and encryption_secret_info.resources | length > 0 }}"
    existing_encryptionsecret_crypto_key: "{{ encryption_secret_info.resources[0].data['MXE_SECURITY_CRYPTO_KEY'] | default('') }}"
    existing_encryptionsecret_cryptox_key: "{{ encryption_secret_info.resources[0].data['MXE_SECURITY_CRYPTOX_KEY'] | default('') }}"
  no_log: true

- name: "Determine whether the crypo & cryptox values have been changed"
  set_fact:
    configure_encryption_keys: "{{ mas_manage_encryptionsecret_crypto_key != '' and mas_manage_encryptionsecret_crypto_key != '' }}"
    has_crypto_value_changed: "{{ mas_manage_encryptionsecret_crypto_key != '' and mas_manage_encryptionsecret_crypto_key != existing_encryptionsecret_crypto_key }}"
    has_cryptox_value_changed: "{{ mas_manage_encryptionsecret_cryptox_key != '' and mas_manage_encryptionsecret_cryptox_key != existing_encryptionsecret_cryptox_key }}"

- name: "Determine whether new AI settings have been provided"
  set_fact:
    configure_aiservice: "{{ mas_manage_encryptionsecret_aiservice_apikey != '' }}"

- name: Debug Manage Encryption Secret details
  debug:
    msg:
      - "Encryption secret name ................. {{ mas_manage_ws_db_encryptionsecret }}"
      - "Encryption secret exists ............... {{ encryption_secret_exists }}"
      - "Configure encryption keys? ............. {{ configure_encryption_keys }}"
      - "- Crypto key changed? .................. {{ has_crypto_value_changed }}"
      - "- Cryptox key changed? ................. {{ has_cryptox_value_changed }}"
      - "Configure AI Service? .................. {{ configure_aiservice }}"


# 3. Backup existing encryption secret
# ------------------------------------------------------------------------
- name: "Backup the existing encryption key secret"
  when:
    - configure_encryption_keys or configure_aiservice
    - encryption_secret_exists
  vars:
    encryption_secret_backup_name: "{{ mas_manage_ws_db_encryptionsecret }}-bkp-{{ ansible_facts['date_time'].iso8601_basic_short | lower }}"
  block:
    - name: "Backup {{ mas_manage_ws_db_encryptionsecret }} secret"
      vars:
        data: "{{ encryption_secret_info.resources[0] }}"
      kubernetes.core.k8s:
        state: present
        namespace: "{{ mas_app_namespace }}"
        template: "templates/manage/encryption-secret-backup.yml.j2"
      no_log: true
    - debug:
        msg:
          - "Encryption secret '{{ mas_manage_ws_db_encryptionsecret }}' backup created: '{{ encryption_secret_backup_name }}'"


# 4. Update the encryption secret
# ------------------------------------------------------------------------
# Due to the template, this update will conditionally modify the secret
# data based on the inputs to this role:
# - If the user has set mas_manage_encryptionsecret_crypto_key we will
#   update the database encryption keys
# - If the user has set mas_manage_encryptionsecret_aiservice_apikey we will
#   update the aiservice configuration
- name: "Configure encryption secret"
  when: configure_encryption_keys or configure_aiservice
  no_log: true
  kubernetes.core.k8s:
    template: "templates/manage/encryption-secret.yml.j2"
