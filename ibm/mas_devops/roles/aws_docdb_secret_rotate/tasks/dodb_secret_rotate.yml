# 1. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
- name: "Fail if mas_instance_id is not provided"
  when: mas_instance_id is not defined or mas_instance_id == ""
  fail:
    msg: "mas_instance_id property is required"

# 2. Get the secret of documentdb from vault
# -----------------------------------------------------------------------------
- name: "Download Amazon DocumentDB Certificate Authority (CA) certificate"
  shell: |
    wget https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem -O /tmp/rds-combined-ca-bundle.pem

- name: "check if user already exists"
  ignore_errors: true
  shell: |
    mongo --ssl --host {{ docdb_host }}:{{ docdb_port }} --sslCAFile /tmp/rds-combined-ca-bundle.pem --username {{ docdb_instance_username }}  --password {{ docdb_instance_password_old }}
  register: check_docdb_user

- name: "Fail if docdb user does not exists"
  when: check_docdb_user.rc != 0
  fail:
    msg: "The docdb user does not exists, please check the docdb username."

# 4. Change docdb user password if it exist
# -----------------------------------------------------------------------------
- name: Generate Mongo instance user password
  no_log: true
  set_fact:
    docdb_final_instance_password: "{{ lookup('password', '/dev/null length=20 chars=ascii_lowercase,ascii_uppercase,digits') }}"

- name: create js file from template
  template:
    src: change_password.js.j2
    dest: "/tmp/change_password.js"

- name: Change docdb user for MAS instance
  shell: |
    mongo --ssl --host {{ docdb_host }}:{{ docdb_port }} --sslCAFile /tmp/rds-combined-ca-bundle.pem --username {{ docdb_master_username }}  --password {{ docdb_master_password }} /tmp/change_password.js
  register: change_password_output

# 5. Test that the newly created user can connect to docdb
# -----------------------------------------------------------------------------
- name: "Test that the newly created user can connect to docdb"
  shell: |
    mongo --ssl --host {{ docdb_host }}:{{ docdb_port }} --sslCAFile /tmp/rds-combined-ca-bundle.pem --username {{ docdb_instance_username }}  --password {{ docdb_final_instance_password }}
  register: docdb_connect_result
  retries: 6
  delay: 20
  until: docdb_connect_result.rc == 0

# 7. Update new password to Cluster Secret
# -----------------------------------------------------------------------------
- name: update k8s Secret for docdb user credentials
  no_log: false
  ansible.builtin.template:
    src: docdb_instance_user_credentials_secret.yaml.j2
    dest: "{{ mas_config_dir }}/mongodb-{{mongocfg.instance_name}}-credentials.yml"
  when:
    - docdb_connect_result is defined
    - docdb_connect_result.rc is defined
    - docdb_connect_result.rc == 0

# 8. Restart the pod entitymgr-coreidp
# -----------------------------------------------------------------------------
- name: "Lookup entitymgr-coreidp pods"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    label_selectors:
      - mas.ibm.com/appType=entitymgr
      - control-plane=ibm-mas-coreidp
    namespace: "mas-{{mas_instance_id}}-core"
  register: entity_pod_lookup

- name: "Restart the pod entitymgr-coreidp"
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Pod
    name: "{{ entity_pod_lookup.resources[0].metadata.name }}"
    namespace: "mas-{{mas_instance_id}}-core"
