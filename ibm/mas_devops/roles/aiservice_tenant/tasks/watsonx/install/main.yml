---
- name: Delete WatsonX secret if exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    name: "{{ aiservice_watsonxai_secret }}"
    state: absent
    namespace: "{{ item }}"
  loop:
    - "{{ aiservice_namespace }}"
    - "{{ tenantNamespace }}"
  ignore_errors: true

- name: Read WX CA Cert from environment
  ansible.builtin.set_fact:
    wxCaCert: "lookup('env', 'AISERVICE_WATSONXAI_CA_CRT') | regex_replace('BEGIN CERTIFICATE', 'BEGIN_CERTIFICATE') | regex_replace('END CERTIFICATE', 'END_CERTIFICATE') | regex_replace('\\s+', '\n') | replace('BEGIN_CERTIFICATE', 'BEGIN CERTIFICATE')| replace('END_CERTIFICATE', 'END CERTIFICATE') }}"
  when: '" " in aiservice_watsonxai_ca_crt'
  register: wxcacert_output

- name: debug WX Ca Cert content
  debug: 
    msg: "Ca Certificate .............. {{ wxcacert_output }}"

- name: Create WatsonX secret
  kubernetes.core.k8s:
    state: present
    template: "templates/watsonx/secret.yml.j2"
  loop:
    - "{{ aiservice_namespace }}"
    - "{{ tenantNamespace }}"
