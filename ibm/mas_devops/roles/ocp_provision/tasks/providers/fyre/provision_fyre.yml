---
# 1. Failure conditions
# -----------------------------------------------------------------------------
- name: "fyre : Fail if required properties are not provided"
  assert:
    that:
      - fyre_quota_type is defined and fyre_quota_type != ""
      - fyre_quota_type is in ['quick_burn', 'product_group']
      - fyre_product_id is defined and fyre_product_id != ""
      - fyre_username is defined and fyre_username != ""
      - fyre_password is defined and fyre_password != ""
      - fyre_site is defined and fyre_site != ""
      - fyre_site is in ['svl','rtp']

- name: "fyre : Fail if required properties are not provided (quickburn)"
  when: fyre_quota_type == "quick_burn"
  assert:
    that: fyre_cluster_size is defined and fyre_cluster_size != ""


# 2. Debug Info
# -----------------------------------------------------------------------------
- name: "fyre : Debug information"
  debug:
    msg:
      - "Cluster name ................. {{ cluster_name }}"
      - "Cluster type ................. {{ cluster_type }}"
      - "Cluster platform ............. {{ cluster_platform }}"
      - "Cluster description .......... {{ fyre_cluster_description }}"
      - "OCP version .................. {{ ocp_version }}"

      - "OCP storage provider ......... {{ ocp_storage_provider | default('<none>', true) }}"
      - "Fyre NFS setup (deprecated) .. {{ fyre_nfs_setup }}"

      - "Fyre Username ................ {{ fyre_username }}"
      - "Fyre Site .................... {{ fyre_site }}"
      - "Fyre Quota Type .............. {{ fyre_quota_type }}"
      - "Fyre product ID .............. {{ fyre_product_id }}"
      - "FIPS enabled ................. {{ ocp_fips_enabled }}"
      - "IPv6 enabled ................. {{ enable_ipv6 }}"

      # Quickburn specific
      - "Fyre cluster size ............ {{ fyre_cluster_size | default('<undefined>', true) }}"

      # Product Group specific
      - "Worker count ................. {{ fyre_worker_count | default('<undefined>', true) }}"
      - "Worker CPU ................... {{ fyre_worker_cpu | default('<undefined>', true) }}"
      - "Worker memory ................ {{ fyre_worker_memory | default('<undefined>', true) }}"
      - "Worker additional disks ...... {{ fyre_worker_additional_disks | default('<undefined>', true) }}"


# 3. Determine whether there is already an environment running
# -----------------------------------------------------------------------------
- name: "fyre : Check if cluster already exists"
  ibm.mas_devops.fyre_check_hostname:
    username: "{{ fyre_username }}"
    apikey: "{{ fyre_password }}"
    cluster_name: "{{ cluster_name }}"
    fyre_site: "{{ fyre_site }}"
  register: _hostname_check

# 4. Deploy the OCP+ cluster
# -----------------------------------------------------------------------------
- name: "fyre : Generate cluster provision json body"
  when: _hostname_check.available
  set_fact:
    fyre_payload: "{{ lookup('template', 'templates/fyre/' ~ fyre_quota_type ~ '.json.j2') }}"

# Note: FYRE rate limits this API globally - we are competing with all other FYRE users for limited "slots" to
# provision new OCP+ clusters, when this happens we will see an error like this with a RC of 429:
#
# > overall (across all product groups and users) rate limit (3 in 5 minutes) exceeded
#
# To mitigate this we have a retry in place that only retries on 429 (rate limit) errors.
# We will retry for approximately 20 minutes (10 retries * 2 minutes) before giving up.
- name: "fyre : Create new OCP+ cluster"
  when: _hostname_check.available
  uri:
    url: https://ocpapi.svl.ibm.com/v1/ocp/
    user: "{{ fyre_username }}"
    password: "{{ fyre_password }}"
    method: POST
    body: "{{ fyre_payload }}"
    force_basic_auth: yes
    body_format: json
    validate_certs: false
    timeout: 300
    use_proxy: no
    status_code: [200, 201, 429]
  register: _cluster_create
  until: _cluster_create.status != 429
  delay: 120  # Every 2 minutes
  retries: 10

- name: "fyre : Debug cluster provision"
  debug:
    var: _cluster_create


# 5. Track the progress of the deployment
# -----------------------------------------------------------------------------
- name: "fyre : Follow deployment status (2 minute intervals)"
  ibm.mas_devops.fyre_watch_provision:
    username: "{{ fyre_username }}"
    apikey: "{{ fyre_password }}"
    cluster_name: "{{ cluster_name }}"
    fyre_site: "{{ fyre_site }}"


# 6. Reconfigure the cluster for NFS
# -----------------------------------------------------------------------------
# In previous versions of the role fyre_nfs_setup was used instead of
# ocp_storage_provider, this step ensures backwards compatibility with
# existing usage
- name: "Backwards compatibility"
  when:
    - ocp_storage_provider == ""
    - fyre_nfs_setup == True
  set_fact:
    ocp_storage_provider: "nfs"

- name: "Install NFS"
  include_tasks: "tasks/providers/fyre/nfs/install_nfs.yml"
  when: ocp_storage_provider == "nfs"
