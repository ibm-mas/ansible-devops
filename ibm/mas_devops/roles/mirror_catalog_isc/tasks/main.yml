---
# 1. Check for undefined properties that do not have a default
# -----------------------------------------------------------------------------
- name: "{{ image_name }} : Fail if required properties are not provided"
  assert:
    that:
      - image_name is defined and image_name != ""
      - mirror_mode is defined and mirror_mode != ""
      - mirror_working_dir is defined and mirror_working_dir != ""
    fail_msg: "One or more required properties are missing"

- name: "{{ image_name }} : Debug"
  debug:
    msg:
      - "Catalog Name .......................... {{ image_name }}"
      - "Mirror Single Architecture ............. {{ mirror_single_arch | default('<not set>', True) }}"
      - "Working Directory ...................... {{ mirror_working_dir }}"
      - "Mode ................................... {{ mirror_mode }}"
      - "Auth File .............................. {{ auth_file }}"
      - "REGISTRY_PASSWORD .................... {{ registry_password | default('<not set>', True) }}"
      - "Artifactory .............................. {{ artifactory_token | default('', True) }}"

# 2. Set up auth secret
# -----------------------------------------------------------------------------
- name: "{{ image_name }} : Create working directory"
  file:
    path: "{{ ansible_env.HOME }}/.ibm-mas"
    state: directory

# 2. Create directory for auth.json
# -----------------------------------------------------------------------------
- name: "{{ image_name }} : Create working directory"
  file:
    path: "{{ ansible_env.HOME }}/containers"
    state: directory

# 2. Configure credentials in auth.json
# -----------------------------------------------------------------------------
- name: "{{ image_name }} : Create auth secret"
  ansible.builtin.template:
    src: templates/auth.json.j2
    dest: "{{ ansible_env.HOME }}/containers/auth.json"
  no_log: true

# 3. Modify the manifest
# -----------------------------------------------------------------------------
- name: Validate that mirror_single_arch is correctly set
  assert:
    that: mirror_single_arch in ["", "amd64", "ppc64le", "s390x"]

- name: "{{ image_name }} : Determine registry type"
  set_fact:
    is_artifactory: "{{ 'artifactory' in isc_registry | lower }}"
    is_github: "{{ 'github' in isc_registry | lower or 'raw.githubusercontent.com' in isc_registry | lower }}"

- include_tasks: "{{ mirror_images }}.yml"
  when: mirror_images in ['cataogs', 'packages']
