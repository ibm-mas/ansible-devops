- name: "{{ image_name }} : Debug registry type"
  debug:
    msg:
      - "ISC Registry ........................... {{ isc_registry }}"
      - "ISC File Path ......................... {{ isc_file_path }}"
      - "Is Artifactory ........................ {{ is_artifactory }}"
      - "Is GitHub ............................. {{ is_github }}"


- name: "{{ image_name }} : Download ISC file from Artifactory with token"
  when: is_artifactory | bool
  get_url:
    url: "{{ isc_file_path }}"
    dest: "{{ ansible_env.HOME }}/.ibm-mas/{{ image_name }}.yaml"
    mode: '755'
    headers:
      Authorization: "Bearer {{ artifactory_token }}"
  #no_log: true

- name: "{{ image_name }} : Download ISC file from GitHub"
  when: is_github | bool
  get_url:
    url: "{{ isc_file_path }}"
    dest: "{{ ansible_env.HOME }}/.ibm-mas/{{ image_name }}.yaml"
    mode: '0755'
    headers:
      Authorization: "token {{ github_token }}"
      Accept: "application/vnd.github.v3.raw"
    validate_certs: yes
  no_log: true

- name: "{{ image_name }} : Verify ISC file was downloaded"
  stat:
    path: "{{ ansible_env.HOME }}/.ibm-mas/{{ image_name }}.yaml"
  register: isc_file_stat
  failed_when: not isc_file_stat.stat.exists

# 4A. Execute the mirror (to filesystem)
# -----------------------------------------------------------------------------
- name: "{{ image_name }} : Mirror Images to local filesystem"
  when: mirror_mode == "to-filesystem"
  block:
    - name: "{{ image_name }}: Run mirror command"
      shell: |
        oc mirror \
          -c "{{ ansible_env.HOME }}/.ibm-mas/{{ image_name }}.yaml" \
          --authfile "{{ ansible_env.HOME }}/containers/auth.json" \
          file://{{ mirror_working_dir }} --v2
      register: ocimagemirror_result
      ignore_errors: true

    - name: "{{ image_name }} : Debug mirror command"
      debug:
        msg:
          - "Source: {{ mirror_working_dir }}/manifests/to-filesystem/{{ manifest_name }}_{{ manifest_version }}.txt"
          - "Auth: {{ auth_file }}"
          - "{{ (ocimagemirror_result.rc == 0) | ternary(ocimagemirror_result.stdout_lines, ocimagemirror_result.stderr_lines) }}"

    - name: "{{ image_name }} : Fail if mirror is not successful"
      assert:
        that: ocimagemirror_result.rc == 0
        fail_msg: "Image mirroring failed (see debug information above)."

# 4B. Create AWS ECR Repositories if required
# -----------------------------------------------------------------------------
- name: "Create AWS ECR Repositories - direct mode"
  when:
    - mirror_mode == "direct"
    - registry_is_ecr == true
  block:
    - name: "{{ manifest_name }} : dry mode mirror command - direct"
      shell: |
        oc mirror \
          -c "{{ ansible_env.HOME }}/.ibm-mas/isc-{{ image_name }}-{{ package_version }}-amd64.yaml" \
          --authfile "{{ ansible_env.HOME }}/containers/auth.json" \
          --workspace file://{{ ansible_env.HOME }}/.ibm-mas \
          docker://051826726580.dkr.ecr.us-east-1.amazonaws.com/testisc \
          --dest-tls-verify false \
          --src-tls-verify false \
          --dry-run --v2
      register: ocimagemirror_dryrun_result
      ignore_errors: true
      when: mirror_mode == "direct"

    - name: "{{ manifest_name }} : Debug dry mode mirror command - direct"
      debug:
        msg: "{{ (ocimagemirror_dryrun_result.rc == 0) | ternary(ocimagemirror_dryrun_result.stdout_lines, ocimagemirror_dryrun_result.stderr_lines) }}"

    - name: "{{ manifest_name }} : Fail if dry mode mirror is not successful - direct"
      assert:
        that: ocimagemirror_dryrun_result.rc == 0
        fail_msg: "mirror command in dry mode failed."


    - name: Set image mapping file path
      set_fact:
        image_map_file: "{{ ansible_env.HOME }}/.ibm-mas/working-dir/dry-run/mapping.txt"

    - name: Debug image mapping file path
      debug:
        msg: "Image mapping file: {{ image_map_file }}"

    - name: Filter out repository names that must be created in ECR - direct
      set_fact:
        repos_to_add: "{{ image_map_file | ibm.mas_devops.get_ecr_repositories_v2('051826726580.dkr.ecr.us-east-1.amazonaws.com') }}"

    - name: Repositories that will be created in ECR - direct
      debug:
        msg: "{{ repos_to_add }}"

    - name: Create ECR Repositories - direct
      ansible.builtin.shell: "aws ecr create-repository --repository-name {{ item }} --region {{ registry_ecr_aws_region }}"
      ignore_errors: true
      loop: "{{ repos_to_add }}"
