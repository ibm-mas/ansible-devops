---
# Configure AI Service properties in Manage encryption secret
# This task retrieves AI Service connection details and patches them into the Manage encryption secret
# -----------------------------------------------------------------------------

- name: "Step 1: Retrieve AI Service API key from secret"
  block:
    - name: "Get AI Service API key secret"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "aiservice-{{ aiservice_instance_id }}-user----apikey-secret"
        namespace: "{{ aiservice_namespace }}"
      register: aiservice_apikey_secret_output

    - name: "Fail if AI Service API key secret not found"
      fail:
        msg: "Could not find AI Service API key secret: aiservice-{{ aiservice_instance_id }}-user----apikey-secret in namespace {{ aiservice_namespace }}"
      when: aiservice_apikey_secret_output.resources | length == 0

    - name: "Extract AI Service API key"
      set_fact:
        aiservice_api_key: "{{ aiservice_apikey_secret_output.resources[0].data.AIBROKER_APIKEY | b64decode }}"

    - name: "Verify API key was retrieved"
      fail:
        msg: "Could not retrieve AI Service API key from secret"
      when: aiservice_api_key is not defined or aiservice_api_key == ""


# Step 2: Retrieve AI Service URL from aibroker route
# -----------------------------------------------------------------------------
- name: "Step 2: Retrieve AI Service URL from aibroker route"
  block:
    - name: "Get aibroker route"
      kubernetes.core.k8s_info:
        api_version: route.openshift.io/v1
        kind: Route
        name: aibroker
        namespace: "{{ aiservice_namespace }}"
      register: aibroker_route_output

    - name: "Fail if aibroker route not found"
      fail:
        msg: "Could not find aibroker route in namespace {{ aiservice_namespace }}"
      when: aibroker_route_output.resources | length == 0

    - name: "Extract aibroker host"
      set_fact:
        aibroker_host: "{{ aibroker_route_output.resources[0].spec.host }}"

    - name: "Construct AI Service URL"
      set_fact:
        aiservice_url: "https://{{ aibroker_host }}/ibm/aibroker/service/rest/api/v1"


# Step 3: Retrieve AI Service tenant ID from AIServiceTenant custom resource
# -----------------------------------------------------------------------------
- name: "Step 3: Retrieve AI Service tenant ID from AIServiceTenant CR"
  block:
    - name: "Get AIServiceTenant custom resource"
      kubernetes.core.k8s_info:
        api_version: aiservice.ibm.com/v1
        kind: AIServiceTenant
        namespace: "{{ aiservice_namespace }}"
      register: aiservice_tenant_output

    - name: "Fail if AIServiceTenant not found"
      fail:
        msg: "Could not find AIServiceTenant custom resource in namespace {{ aiservice_namespace }}"
      when: aiservice_tenant_output.resources | length == 0

    - name: "Extract AI Service tenant ID from first resource"
      set_fact:
        aiservice_tenant_id: "{{ aiservice_tenant_output.resources[0].metadata.name }}"

    - name: "Verify tenant ID was retrieved"
      fail:
        msg: "Could not retrieve AI Service tenant ID from AIServiceTenant CR"
      when: aiservice_tenant_id is not defined or aiservice_tenant_id == ""


# Step 4: Patch AI Service properties into Manage encryption secret
# -----------------------------------------------------------------------------
- name: "Step 4: Patch AI Service properties into Manage encryption secret"
  block:
    - name: "Verify Manage encryption secret exists"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
      register: manage_secret_output

    - name: "Fail if Manage encryption secret not found"
      fail:
        msg: "Could not find Manage encryption secret: {{ manage_encryption_secret_name }} in namespace {{ manage_namespace }}"
      when: manage_secret_output.resources | length == 0


    - name: "Encode AI Service properties to base64"
      set_fact:
        encoded_apikey: "{{ aiservice_api_key | b64encode }}"
        encoded_url: "{{ aiservice_url | b64encode }}"
        encoded_tenantid: "{{ aiservice_tenant_id | b64encode }}"

    - name: "Remove existing AI Service properties (if any)"
      kubernetes.core.k8s_json_patch:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
        patch:
          - op: remove
            path: /data/mxe.int.aibrokerapikey
      ignore_errors: true

    - name: "Remove existing AI Service URL property (if any)"
      kubernetes.core.k8s_json_patch:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
        patch:
          - op: remove
            path: /data/mxe.int.aibrokerapiurl
      ignore_errors: true

    - name: "Remove existing AI Service tenant ID property (if any)"
      kubernetes.core.k8s_json_patch:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
        patch:
          - op: remove
            path: /data/mxe.int.aibrokertenantid
      ignore_errors: true

    - name: "Add AI Service properties to secret"
      kubernetes.core.k8s_json_patch:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
        patch:
          - op: add
            path: /data/mxe.int.aibrokerapikey
            value: "{{ encoded_apikey }}"
          - op: add
            path: /data/mxe.int.aibrokerapiurl
            value: "{{ encoded_url }}"
          - op: add
            path: /data/mxe.int.aibrokertenantid
            value: "{{ encoded_tenantid }}"


# Step 5: Verify the secret was updated
# -----------------------------------------------------------------------------
- name: "Step 5: Verify AI Service properties in secret"
  block:
    - name: "Get updated secret"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ manage_encryption_secret_name }}"
        namespace: "{{ manage_namespace }}"
      register: updated_secret_output

    - name: "Verify mxe.int.aibrokerapikey is present"
      assert:
        that: "'mxe.int.aibrokerapikey' in updated_secret_output.resources[0].data"
        success_msg: "Verified: mxe.int.aibrokerapikey is present in secret"
        fail_msg: "Failed: mxe.int.aibrokerapikey is not present in secret"

    - name: "Verify mxe.int.aibrokerapiurl is present"
      assert:
        that: "'mxe.int.aibrokerapiurl' in updated_secret_output.resources[0].data"
        success_msg: "Verified: mxe.int.aibrokerapiurl is present in secret"
        fail_msg: "Failed: mxe.int.aibrokerapiurl is not present in secret"

    - name: "Verify mxe.int.aibrokertenantid is present"
      assert:
        that: "'mxe.int.aibrokertenantid' in updated_secret_output.resources[0].data"
        success_msg: "Verified: mxe.int.aibrokertenantid is present in secret"
        fail_msg: "Failed: mxe.int.aibrokertenantid is not present in secret"

# Step 6: Import AI Service TLS certificate into Manage truststore
# -----------------------------------------------------------------------------
- name: "Step 6: Import AI Service TLS certificate into Manage"
  block:
    - name: "Get AI Service TLS certificate from secret"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        name: "{{ aiservice_instance_id }}-public-aibroker-tls"
        namespace: "{{ aiservice_namespace }}"
      register: aiservice_tls_secret_output

    - name: "Fail if AI Service TLS secret not found"
      fail:
        msg: "Could not find AI Service TLS secret: {{ aiservice_instance_id }}-public-aibroker-tls in namespace {{ aiservice_namespace }}"
      when: aiservice_tls_secret_output.resources | length == 0

    - name: "Extract TLS certificate from secret"
      set_fact:
        aiservice_tls_cert: "{{ aiservice_tls_secret_output.resources[0].data['ca.crt'] | b64decode }}"

    - name: "Verify TLS certificate was retrieved"
      fail:
        msg: "Could not retrieve AI Service TLS certificate from secret"
      when: aiservice_tls_cert is not defined or aiservice_tls_cert == ""

    - name: "Build certificate entry for ManageWorkspace"
      set_fact:
        aiservice_cert_entry:
          - alias: "aiservice-{{ aiservice_instance_id }}-tls1"
            crt: "{{ aiservice_tls_cert }}"

    - name: "Import AI Service TLS certificate into ManageWorkspace"
      kubernetes.core.k8s_json_patch:
        api_version: apps.mas.ibm.com/v1
        kind: ManageWorkspace
        name: "{{ mas_instance_id }}-{{ mas_workspace_id }}"
        namespace: "mas-{{ mas_instance_id }}-manage"
        patch:
          - op: add
            path: /spec/settings/deployment/importedCerts
            value: "{{ aiservice_cert_entry }}"

# Step 7: Verify AI Service health
# -----------------------------------------------------------------------------
- name: "Step 7: Verify AI Service is running and healthy"
  block:
    - name: "Get aibroker route host"
      kubernetes.core.k8s_info:
        api_version: route.openshift.io/v1
        kind: Route
        name: aibroker
        namespace: "{{ aiservice_namespace }}"
      register: aibroker_route_output

    - name: "Fail if aibroker route not found"
      fail:
        msg: "Could not find aibroker route in namespace {{ aiservice_namespace }}"
      when: aibroker_route_output.resources | length == 0

    - name: "Extract aibroker host"
      set_fact:
        aibroker_host: "{{ aibroker_route_output.resources[0].spec.host }}"

    - name: "Set AI Service health URL"
      set_fact:
        aiservice_health_url: "https://{{ aibroker_host }}/ibm/aibroker/service/rest/api/v1/health"

    - name: "Check AI Service health endpoint"
      uri:
        url: "{{ aiservice_health_url }}"
        method: GET
        validate_certs: false
        return_content: true
        status_code: [200, 503]
      register: aiservice_health_response
      retries: 5
      delay: 10
      until:
        - aiservice_health_response.status == 200
        - aiservice_health_response.json is defined
      failed_when: false

    - name: "Fail if health endpoint never returned 200"
      fail:
        msg: "AI Service health endpoint failed to return HTTP 200 after 5 attempts. Last status: {{ aiservice_health_response.status }}"
      when: aiservice_health_response.status != 200

    - name: "Parse AI Service health response"
      set_fact:
        aiservice_kmodel_status: "{{ aiservice_health_response.json.kmodel | default('unknown') }}"
        aiservice_healthy_status: "{{ aiservice_health_response.json.healthy | default(false) }}"

    - name: "Display AI Service health status"
      debug:
        msg:
          - "AI Service Health Check:"
          - "  URL: {{ aiservice_health_url }}"
          - "  kmodel: {{ aiservice_kmodel_status }}"
          - "  healthy: {{ aiservice_healthy_status }}"

    - name: "Verify AI Service is fully healthy"
      assert:
        that:
          - aiservice_kmodel_status == 'running'
          - aiservice_healthy_status == true
        success_msg: "AI Service is running and healthy"
        fail_msg: |
            AI Service is not fully healthy:
            - kmodel: {{ aiservice_kmodel_status }} (expected: running)
            - healthy: {{ aiservice_healthy_status }} (expected: true)

- name: "AI Service configuration completed successfully"
  debug:
    msg:
      - "AI Service properties configured in Manage encryption secret successfully"
      - "AI Service TLS certificate imported into Manage truststore"
      - "AI Service health verified - service is running and healthy"
      - "Note: Manage will automatically restart to apply these changes"
