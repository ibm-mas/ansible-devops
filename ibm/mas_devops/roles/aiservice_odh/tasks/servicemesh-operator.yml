---

- name: Get service mesh operator package manifest
  kubernetes.core.k8s_info:
    api_version: packages.operators.coreos.com/v1
    kind: PackageManifest
    name: servicemeshoperator
    namespace: openshift-marketplace  # Note: A namespace must be provided when calling packages.operators.coreos.com/v1
  register: service_mesh_operator_manifest

- name: Assert that PackageManifest exists
  ansible.builtin.assert:
    that:
      - service_mesh_operator_manifest is defined
      - service_mesh_operator_manifest.resources is defined
      - service_mesh_operator_manifest.resources | length == 1
    fail_msg: "PackageManifest not found: servicemeshoperator"

- name: Set the subscription information
  set_fact:
    service_mesh_operator_source: "{{ service_mesh_operator_manifest.resources[0].status.catalogSource }}"
    service_mesh_operator_source_namespace: "{{ service_mesh_operator_manifest.resources[0].status.catalogSourceNamespace }}"
    service_mesh_operator_default_channel: "{{ service_mesh_operator_manifest.resources[0].status.defaultChannel }}"

# 1. Install Operator & create entitlement openshift-service-mesh
# -----------------------------------------------------------------------------
- name: "Install Openshift ServiceMesh Operator"
  ibm.mas_devops.apply_subscription:
    namespace: "{{ service_mesh_namespace }}"
    package_name: "servicemeshoperator"
    package_channel: "{{ service_mesh_operator_default_channel }}"
    catalog_source: "{{ service_mesh_operator_source }}"
    install_mode: AllNamespaces
  register: subscription


# 2. Wait until the ServiceMesh CRD is available
# -----------------------------------------------------------------------------
- name: "Wait until the ServiceMesh CRD is available"
  include_tasks: "{{ role_path }}/../../common_tasks/wait_for_crd.yml"
  vars:
    crd_name: servicemeshcontrolplanes.maistra.io

# 3. Create Service account
# -----------------------------------------------------------------------------
- name: "Create Service account"
  kubernetes.core.k8s:
    template: "templates/servicemesh/service-account.yml.j2"
