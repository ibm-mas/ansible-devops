---
# 1. Update the Subscription
# -----------------------------------------------------------------------------
- name: "upgrade : Update ibm-aiservice subscription channel"
  kubernetes.core.k8s:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: "{{ aiservice_sub_info.resources[0].metadata.name }}"
    namespace: "{{ aiservice_namespace }}"
    definition:
      spec:
        channel: "{{ aiservice_channel }}"
        name: "{{ aiservice_sub_info.resources[0].spec.name }}"
        source: "{{ aiservice_sub_info.resources[0].spec.source }}"
        sourceNamespace: "{{ aiservice_sub_info.resources[0].spec.sourceNamespace }}"
    apply: true


# 2. Check the Subscription
# -----------------------------------------------------------------------------
- name: "upgrade : Get updated subscription for ibm-aiservice"
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ aiservice_namespace }}"
    label_selectors:
      - "operators.coreos.com/ibm-aiservice.{{ aiservice_namespace }}"
  register: updated_aiservice_sub_info
  retries: 20 # about 10 minutes
  delay: 30 # seconds
  until:
    - updated_aiservice_sub_info.resources[0].status.installPlanGeneration > aiservice_sub_info.resources[0].status.installPlanGeneration
    - updated_aiservice_sub_info.resources[0].status.state == "AtLatestKnown"

- name: "upgrade : Debug Subscription"
  debug:
    var: updated_aiservice_sub_info

# # No easy way to determine the end of the installPlanGeneration as it depends on if we have a patch versions of the
# # new version in the catalog. No patch versions means just one installPlanGeneration increase. Catalog has patches means
# # two installPlanGenerateion increase. Wait for 5 minutes like we do for apps
- name: "Pause for 5 minutes before checking upgrade status..."
  pause:
    minutes: 5

# 3. Lookup the OperatorCondition
# -----------------------------------------------------------------------------
- name: "upgrade : Lookup OperatorCondition for ibm-aiservice"
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v2
    kind: OperatorCondition
    namespace: "{{ aiservice_namespace }}"
    label_selectors:
      - "operators.coreos.com/ibm-aiservice.{{ aiservice_namespace }}"
  register: updated_opcon
  retries: 10
  delay: 60 # 1 minute
  until:
    - updated_opcon.resources is defined
    - updated_opcon.resources | length == 1
    - updated_opcon.resources[0].metadata.name is defined

- name: "upgrade : Debug OperatorCondition"
  debug:
    var: updated_opcon


# 4. Set the operator version
# -----------------------------------------------------------------------------
# OperatorCondition names are in the format {packageName}.{packageVersion}
# We want to strip off the "v" prefix from the version while we do this
- name: "upgrade : Lookup operator version for ibm-aiservice"
  set_fact:
    updated_opcon_version: "{{ updated_opcon.resources[0].metadata.name.split('.v')[1] | ibm.mas_devops.format_pre_version_with_plus }}"

- name: "upgrade : Debug Operator Version"
  debug:
    msg:
      - "Operator condition ..................... {{ updated_opcon.resources[0].metadata.name }}"
      - "Operator version (before) .............. {{ opcon_version }}"
      - "Operator version (after) ............... {{ updated_opcon_version }}"


# 5. Check that the AI Service CR meets the required state
# -----------------------------------------------------------------------------
- name: "upgrade : Get Suite CR for for ibm-aiservice"
  kubernetes.core.k8s_info:
    api_version: aiservice.ibm.com/v1
    name: "{{ aiservice_instance_id }}"
    namespace: "{{ aiservice_namespace }}"
    kind: AIServiceApp
  retries: 20 # about 40 minutes
  delay: 120 # 2 minutes
  until:
    - updated_aiservice_info.resources[0].status.versions.reconciled == updated_opcon_version
    - updated_aiservice_info.resources | json_query('[*].status.conditions[?type==`Ready`][].reason') | select ('match','Ready') | list | length == 1
  register: updated_aiservice_info

- name: "upgrade : Debug Suite CR"
  debug:
    var: updated_aiservice_info

- name: "Find existing AIServiceTenant CRs in namespace {{ aiservice_namespace }}"
  kubernetes.core.k8s_info:
    api_version: aiservice.ibm.com/v1
    kind: AIServiceTenant
    namespace:  "{{ aiservice_namespace }}"
  register: search_result

- name: Set target resources
  ansible.builtin.set_fact:
    tenant_crs: "{{ search_result.results | map(attribute='resources') | list | flatten }}"

- when: tenant_crs | length > 0
  block:
    - name: Read AIServiceTenant CR
      kubernetes.core.k8s_info:
        api_version: aiservice.ibm.com/v1
        kind: AIServiceTenant
        namespace: "{{ aiservice_namespace }}"
        name: "{{ item.metadata.name }}"
      register: tenant_cr
    
    - name: "Create tenant CR"
      vars:
        annotation_dict: "{{ mas_annotations | string | ibm.mas_devops.getAnnotations() }}"
      kubernetes.core.k8s:
        state: present
        namespace: "{{ tenantNamespace }}"
        template: templates/aiservice/aiservicetenant.yml.j2
      loop: "{{ target_resources }}"
