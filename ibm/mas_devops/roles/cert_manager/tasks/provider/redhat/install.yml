---
# The following Red Hat Certificate subscription/operator will be installed in the 'cert-manager-operator' namespace:
# - cert-manager-operator-controller-manager
#
# The following Red Hat Certificate deployment and pods will be installed in the 'cert-manager' namespace:
# - cert-manager
# - cert-manager-cainjector
# - cert-manager-webhook

# 1. Create RHCM Subscription
# -----------------------------------------------------------------------------
- name: "install : Create Red Hat Certificate Manager Subscription"
  ibm.mas_devops.apply_subscription:
    namespace: "{{ cert_manager_operator_namespace }}"
    package_name: openshift-cert-manager-operator
    package_channel: stable-v1
  register: subscription


# 2. Wait for Subscription to be processed
# -----------------------------------------------------------------------------
- name: "install: Wait for Red Hat cert-manager-operator-controller-manager to be ready (60s delay)"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    name: cert-manager-operator-controller-manager
    namespace: "{{ cert_manager_operator_namespace }}"
    kind: Deployment
  register: certmanager_deployment
  until:
    - certmanager_deployment.resources is defined
    - certmanager_deployment.resources | length > 0
    - certmanager_deployment.resources[0].status is defined
    - certmanager_deployment.resources[0].status.replicas is defined
    - certmanager_deployment.resources[0].status.readyReplicas is defined
    - certmanager_deployment.resources[0].status.readyReplicas == certmanager_deployment.resources[0].status.replicas
  retries: 30 # Approximately 1/2 hour before we give up
  delay: 60 # 1 minute


# 3. Create the CertManager instance
# -----------------------------------------------------------------------------
- name: "install: Wait for CertManager Cluster Custom Resource to be created"
  kubernetes.core.k8s_info:
    api_version: operator.openshift.io/v1alpha1
    name: cluster
    kind: CertManager
  register: certmanager_cluster_cr
  until:
    - certmanager_cluster_cr.resources is defined
    - certmanager_cluster_cr.resources | length > 0
  retries: 10 # Approximately 5 minutes before we give up
  delay: 30 # 30 seconds


# 4. Wait for Cert Manager's webhook to be ready
# -----------------------------------------------------------------------------
- name: "install: Wait for Red Hat cert-manager-webhook deployment to be ready (60s delay)"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    name: cert-manager-webhook
    namespace: "{{ cert_manager_namespace }}"
    kind: Deployment
  register: certmanager_webhook_deployment
  until:
    - certmanager_webhook_deployment.resources is defined
    - certmanager_webhook_deployment.resources | length > 0
    - certmanager_webhook_deployment.resources[0].status is defined
    - certmanager_webhook_deployment.resources[0].status.replicas is defined
    - certmanager_webhook_deployment.resources[0].status.readyReplicas is defined
    - certmanager_webhook_deployment.resources[0].status.readyReplicas == certmanager_webhook_deployment.resources[0].status.replicas
  retries: 60 # Approximately 1/2 hour before we give up
  delay: 60 # 1 minute
