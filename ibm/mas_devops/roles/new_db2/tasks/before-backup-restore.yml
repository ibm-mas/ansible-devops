---
# Before backup/restore tasks for new_db2 role
# Handles both in-cluster DB2 and RDS DB2

# Route to appropriate before tasks based on db2_type
# -----------------------------------------------------------------------------
- name: "Run before tasks for in-cluster DB2"
  when: db2_type == 'incluster'
  block:
    # Get db2 version and status
    # -------------------------------------------------------------------------
    - name: "Get Db2uCluster"
      kubernetes.core.k8s_info:
        api_version: db2u.databases.ibm.com/v1
        kind: Db2uCluster
        name: "{{ masbr_job_component.instance }}"
        namespace: "{{ db2_namespace }}"
      register: _db2ucluster_output

    - name: "Set fact: db2 version"
      set_fact:
        db2_version: "{{ _db2ucluster_output.resources[0].spec.version }}"
      when:
        - _db2ucluster_output is defined
        - _db2ucluster_output.resources[0] is defined
        - _db2ucluster_output.resources[0].spec.version is defined

    - name: "Fail if db2 does not exists"
      assert:
        that: db2_version is defined
        fail_msg: "Db2 does not exists!"

    - name: "Set fact: db2 running status"
      set_fact:
        db2_running: true
      when:
        - _db2ucluster_output is defined
        - _db2ucluster_output.resources[0] is defined
        - _db2ucluster_output.resources[0].status is defined
        - _db2ucluster_output.resources[0].status.state is defined
        - _db2ucluster_output.resources[0].status.state == "Ready"

    - name: "Fail if db2 is not running"
      assert:
        that: db2_running is defined and db2_running
        fail_msg: "Db2 is not running!"

    # Get db2 pod name
    # -------------------------------------------------------------------------
    - name: "Get db2 pod name"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ db2_namespace }}"
        label_selectors:
          - "{{ db2_incluster_pod_label_selector }}"
          - app={{ masbr_job_component.instance }}
      register: _db2_pod_output
      failed_when:
        - _db2_pod_output.resources is not defined
        - _db2_pod_output.resources | length == 0

    - name: "Set fact: db2 pod name"
      set_fact:
        db2_pod_name: "{{ _db2_pod_output.resources[0].metadata.name }}"
        db2_container_name: "{{ db2_incluster_container_name }}"

    - name: "Set fact: exec command in db2 pod"
      set_fact:
        exec_in_pod_begin: >-
          oc exec {{ db2_pod_name }} -c {{ db2_container_name }} -n {{ db2_namespace }} -- su -lc '
        exec_in_pod_end: "' {{ db2_jdbc_username }}"

    # Set db2 backup/restore variables
    # -------------------------------------------------------------------------
    - name: "Set fact: db2 pod copy file variables"
      set_fact:
        masbr_cf_namespace: "{{ db2_namespace }}"
        masbr_cf_pod_name: "{{ db2_pod_name }}"
        masbr_cf_container_name: "{{ db2_container_name }}"
        masbr_cf_pvc_name: "{{ db2_incluster_pvc_name | default('c-' + db2_instance_name + '-backup', true) }}"
        masbr_cf_pvc_mount_path: "{{ db2_incluster_pvc_mount_path }}"
        masbr_cf_pvc_sub_path: ""
        masbr_cf_are_pvc_paths: true
        masbr_cf_affinity: false

    - name: "Set fact: temporary folders"
      set_fact:
        db2_pod_temp_folder: "{{ masbr_pod_temp_folder }}/{{ masbr_job_name }}"
        db2_pvc_temp_folder: "{{ masbr_cf_pvc_mount_path }}/{{ masbr_job_name }}"

    - name: "Set fact: db2 keystore folder"
      set_fact:
        db2_keystore_folder: "{{ db2_incluster_keystore_folder }}"

    # Output db2 information
    # -------------------------------------------------------------------------
    - name: "Debug: in-cluster db2 information"
      debug:
        msg:
          - "Db2 version ............................ {{ db2_version }}"
          - "Db2 is running ......................... {{ db2_running }}"
          - "Db2 pod name ........................... {{ db2_pod_name }}"

    # Check if an exiting job is running
    # -------------------------------------------------------------------------
    - name: "Try to find job lock file in pod"
      when: not masbr_allow_multi_jobs
      changed_when: false
      shell: >
        {{ exec_in_pod_begin }}
        [ -f {{ masbr_pod_lock_file }} ] && echo exist; exit 0
        {{ exec_in_pod_end }}
      register: _get_lock_file_output

    - name: "Fail if found job lock file in pod"
      when: not masbr_allow_multi_jobs
      assert:
        that: _get_lock_file_output.stdout != "exist"
        fail_msg: "A backup/restore job is running now, please try to run job later!"

    - name: "Create job lock file in pod"
      changed_when: true
      shell: >-
        {{ exec_in_pod_begin }}
        mkdir -p {{ masbr_pod_lock_file | dirname }};
        touch {{ masbr_pod_lock_file }}
        {{ exec_in_pod_end }}

    # Check storage usage
    # -------------------------------------------------------------------------
    - name: "Get storage usage of pod temporary folder"
      changed_when: false
      shell: >
        {{ exec_in_pod_begin }}
        mkdir -p {{ db2_pod_temp_folder }};
        df -h {{ db2_pod_temp_folder }}
        {{ exec_in_pod_end }}
      register: _df_temp_output

    - name: "Debug: storage usage of pod temporary folder"
      debug:
        msg: "{{ _df_temp_output.stdout_lines }}"

    - name: "Get storage usage of pvc temporary folder"
      changed_when: false
      shell: >
        {{ exec_in_pod_begin }}
        mkdir -p {{ db2_pvc_temp_folder }};
        df -h {{ db2_pvc_temp_folder }}
        {{ exec_in_pod_end }}
      register: _df_pvc_output

    - name: "Debug: storage usage of pvc temporary folder"
      debug:
        msg: "{{ _df_pvc_output.stdout_lines }}"

# RDS DB2 before tasks
# -----------------------------------------------------------------------------
- name: "Run before tasks for RDS DB2"
  when: db2_type == 'rds'
  block:
    - name: "Debug: RDS DB2 information"
      debug:
        msg:
          - "DB2 Type ............................... RDS"
          - "RDS Host ............................... {{ db2_rds_host }}"
          - "RDS Port ............................... {{ db2_rds_port }}"
          - "RDS SSL Enabled ........................ {{ db2_rds_ssl_enabled }}"
          - "Database Name .......................... {{ db2_dbname }}"

    - name: "Verify DB2 client is available"
      shell: which db2
      register: _db2_client_check
      failed_when: _db2_client_check.rc != 0
      changed_when: false

    - name: "Debug: DB2 client found"
      debug:
        msg: "DB2 client is available at: {{ _db2_client_check.stdout }}"

# Made with Bob
