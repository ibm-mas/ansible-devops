---
# Download backup files from S3
# This task downloads the backup archive from S3 bucket

- name: "Validate S3 configuration"
  assert:
    that:
      - masbr_storage_s3_bucket is defined and masbr_storage_s3_bucket != ""
      - masbr_storage_s3_access_key is defined and masbr_storage_s3_access_key != ""
      - masbr_storage_s3_secret_key is defined and masbr_storage_s3_secret_key != ""
    fail_msg: "S3 bucket, access key, and secret key are required for S3 storage"

- name: "Set fact: S3 configuration"
  set_fact:
    s3_bucket: "{{ masbr_storage_s3_bucket }}"
    s3_region: "{{ masbr_storage_s3_region | default('us-east-1', true) }}"
    s3_endpoint: "{{ masbr_storage_s3_endpoint | default('', true) }}"

- name: "Set fact: S3 object key"
  set_fact:
    s3_object_key: "{{ masbr_job_component.name }}/{{ masbr_job_component.instance }}/{{ _s3_src_folder }}/{{ _s3_file_name }}"

- name: "Debug: S3 download information"
  debug:
    msg:
      - "S3 Bucket .......................... {{ s3_bucket }}"
      - "S3 Region .......................... {{ s3_region }}"
      - "S3 Object Key ...................... {{ s3_object_key }}"
      - "Local Destination .................. {{ _s3_local_dest }}"

# Check if AWS CLI is installed
- name: "Check if AWS CLI is installed"
  shell: which aws
  register: _aws_cli_check
  failed_when: false
  changed_when: false

- name: "Fail if AWS CLI is not installed"
  assert:
    that: _aws_cli_check.rc == 0
    fail_msg: "AWS CLI is not installed. Please install it first."

# Create local destination directory
- name: "Create local destination directory"
  file:
    path: "{{ _s3_local_dest | dirname }}"
    state: directory
    mode: '0755'

# Verify file exists in S3
- name: "Verify file exists in S3"
  shell: |
    export AWS_ACCESS_KEY_ID="{{ masbr_storage_s3_access_key }}"
    export AWS_SECRET_ACCESS_KEY="{{ masbr_storage_s3_secret_key }}"
    export AWS_DEFAULT_REGION="{{ s3_region }}"
    {% if s3_endpoint != '' %}
    aws s3 ls "s3://{{ s3_bucket }}/{{ s3_object_key }}" --endpoint-url "{{ s3_endpoint }}"
    {% else %}
    aws s3 ls "s3://{{ s3_bucket }}/{{ s3_object_key }}"
    {% endif %}
  no_log: true
  register: _s3_check_output
  failed_when: _s3_check_output.rc != 0

- name: "Debug: S3 file found"
  debug:
    msg: "{{ _s3_check_output.stdout_lines }}"

# Download file from S3
- name: "Download file from S3"
  shell: |
    export AWS_ACCESS_KEY_ID="{{ masbr_storage_s3_access_key }}"
    export AWS_SECRET_ACCESS_KEY="{{ masbr_storage_s3_secret_key }}"
    export AWS_DEFAULT_REGION="{{ s3_region }}"
    {% if s3_endpoint != '' %}
    aws s3 cp "s3://{{ s3_bucket }}/{{ s3_object_key }}" "{{ _s3_local_dest }}" --endpoint-url "{{ s3_endpoint }}"
    {% else %}
    aws s3 cp "s3://{{ s3_bucket }}/{{ s3_object_key }}" "{{ _s3_local_dest }}"
    {% endif %}
  no_log: true
  register: _s3_download_output

- name: "Debug: S3 download result"
  debug:
    msg: "File downloaded successfully from S3 to: {{ _s3_local_dest }}"

# Verify download
- name: "Verify downloaded file"
  stat:
    path: "{{ _s3_local_dest }}"
  register: _downloaded_file_stat

- name: "Fail if file was not downloaded"
  assert:
    that: _downloaded_file_stat.stat.exists
    fail_msg: "File was not downloaded successfully from S3"

- name: "Debug: Downloaded file size"
  debug:
    msg: "Downloaded file size: {{ (_downloaded_file_stat.stat.size / 1024 / 1024) | round(2) }} MB"

# Made with Bob
