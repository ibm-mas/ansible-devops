---
# Upload backup files to S3
# This task uploads the backup archive to S3 bucket

- name: "Validate S3 configuration"
  assert:
    that:
      - masbr_storage_s3_bucket is defined and masbr_storage_s3_bucket != ""
      - masbr_storage_s3_access_key is defined and masbr_storage_s3_access_key != ""
      - masbr_storage_s3_secret_key is defined and masbr_storage_s3_secret_key != ""
    fail_msg: "S3 bucket, access key, and secret key are required for S3 storage"

- name: "Set fact: S3 configuration"
  set_fact:
    s3_bucket: "{{ masbr_storage_s3_bucket }}"
    s3_region: "{{ masbr_storage_s3_region | default('us-east-1', true) }}"
    s3_endpoint: "{{ masbr_storage_s3_endpoint | default('', true) }}"

- name: "Set fact: S3 object key"
  set_fact:
    s3_object_key: "{{ masbr_job_component.name }}/{{ masbr_job_component.instance }}/{{ _s3_dest_folder }}/{{ _s3_file_name }}"

- name: "Debug: S3 upload information"
  debug:
    msg:
      - "S3 Bucket .......................... {{ s3_bucket }}"
      - "S3 Region .......................... {{ s3_region }}"
      - "S3 Object Key ...................... {{ s3_object_key }}"
      - "Local File ......................... {{ _s3_local_file }}"

# Install AWS CLI if not present (for S3 operations)
- name: "Check if AWS CLI is installed"
  shell: which aws
  register: _aws_cli_check
  failed_when: false
  changed_when: false

- name: "Install AWS CLI"
  when: _aws_cli_check.rc != 0
  block:
    - name: "Download AWS CLI installer"
      get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: "/tmp/awscliv2.zip"
        mode: '0644'

    - name: "Unzip AWS CLI installer"
      unarchive:
        src: "/tmp/awscliv2.zip"
        dest: "/tmp"
        remote_src: yes

    - name: "Install AWS CLI"
      shell: /tmp/aws/install
      become: yes

# Configure AWS credentials
- name: "Configure AWS credentials"
  shell: |
    export AWS_ACCESS_KEY_ID="{{ masbr_storage_s3_access_key }}"
    export AWS_SECRET_ACCESS_KEY="{{ masbr_storage_s3_secret_key }}"
    export AWS_DEFAULT_REGION="{{ s3_region }}"
  no_log: true
  changed_when: false

# Upload file to S3
- name: "Upload file to S3"
  shell: |
    export AWS_ACCESS_KEY_ID="{{ masbr_storage_s3_access_key }}"
    export AWS_SECRET_ACCESS_KEY="{{ masbr_storage_s3_secret_key }}"
    export AWS_DEFAULT_REGION="{{ s3_region }}"
    {% if s3_endpoint != '' %}
    aws s3 cp "{{ _s3_local_file }}" "s3://{{ s3_bucket }}/{{ s3_object_key }}" --endpoint-url "{{ s3_endpoint }}"
    {% else %}
    aws s3 cp "{{ _s3_local_file }}" "s3://{{ s3_bucket }}/{{ s3_object_key }}"
    {% endif %}
  no_log: true
  register: _s3_upload_output

- name: "Debug: S3 upload result"
  debug:
    msg: "File uploaded successfully to S3: s3://{{ s3_bucket }}/{{ s3_object_key }}"

# Verify upload
- name: "Verify S3 upload"
  shell: |
    export AWS_ACCESS_KEY_ID="{{ masbr_storage_s3_access_key }}"
    export AWS_SECRET_ACCESS_KEY="{{ masbr_storage_s3_secret_key }}"
    export AWS_DEFAULT_REGION="{{ s3_region }}"
    {% if s3_endpoint != '' %}
    aws s3 ls "s3://{{ s3_bucket }}/{{ s3_object_key }}" --endpoint-url "{{ s3_endpoint }}"
    {% else %}
    aws s3 ls "s3://{{ s3_bucket }}/{{ s3_object_key }}"
    {% endif %}
  no_log: true
  register: _s3_verify_output

- name: "Debug: S3 file verification"
  debug:
    msg: "{{ _s3_verify_output.stdout_lines }}"

# Made with Bob
