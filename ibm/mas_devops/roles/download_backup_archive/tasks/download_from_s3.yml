---
# Download backup archive from S3
- name: "Display S3 download information"
  ansible.builtin.debug:
    msg:
      - "Downloading from S3 bucket: {{ s3_bucket_name }}"
      - "Region: {{ s3_region }}"
      - "Archive: {{ backup_archive_name }}"
      - "Download to: {{ backup_temp_dir }}"

- name: "Download archive from S3"
  ibm.mas_devops.download_from_s3:
    aws_access_key_id: "{{ aws_access_key_id }}"
    aws_secret_access_key: "{{ aws_secret_access_key }}"
    bucket_name: "{{ s3_bucket_name }}"
    object_name: "{{ backup_archive_name }}"
    local_dir: "{{ backup_temp_dir }}"
    region_name: "{{ s3_region }}"
    endpoint_url: "{{ s3_endpoint_url | default(omit) }}"
  register: s3_download_result
  poll: 10

- name: "Verify downloaded archive exists"
  ansible.builtin.stat:
    path: "{{ backup_temp_dir }}/{{ backup_archive_name }}"
  register: downloaded_archive_stat

- name: "Display S3 download result"
  ansible.builtin.debug:
    msg:
      - "Successfully downloaded {{ backup_archive_name }} from S3 bucket {{ s3_bucket_name }}"
      - "Archive size: {{ (downloaded_archive_stat.stat.size / 1024 / 1024) | round(2) }} MB"
  when:
    - s3_download_result.success | bool
    - downloaded_archive_stat.stat.exists

- name: "Fail if S3 download failed"
  ansible.builtin.fail:
    msg: "Failed to download archive from S3: {{ s3_download_result.msg | default('Unknown error') }}"
  when: not s3_download_result.success | bool

- name: "Fail if downloaded archive does not exist"
  ansible.builtin.fail:
    msg: "Downloaded archive {{ backup_temp_dir }}/{{ backup_archive_name }} does not exist"
  when: not downloaded_archive_stat.stat.exists
