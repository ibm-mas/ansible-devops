---
apiVersion: mongodbcommunity.mongodb.com/v1
kind: MongoDBCommunity
metadata:
  name: mas-mongo-mck
  namespace: "{{mongodb_namespace}}"

spec:
  members: {{mongodb_replicas}}
  type: ReplicaSet
  version: "{{target_mongodb_version}}"

  security:
    tls:
      enabled: true
      certificateKeySecretRef:
        name: mongo-server-cert
      caConfigMapRef:
        name: mas-mongo-mck-cert-map
    authentication:
      modes:
        - SCRAM-SHA-256
        - SCRAM-SHA-1

  prometheus:
    username: metrics-endpoint-user
    passwordSecretRef:
      name: mas-mongo-mck-metrics-endpoint-secret

  users:
    - name: admin
      db: admin
      passwordSecretRef:
        name: mas-mongo-mck-admin-password
      roles:
        - name: clusterAdmin
          db: admin
        - name: userAdminAnyDatabase
          db: admin
        - name: dbOwner
          db: admin
        - name: readWriteAnyDatabase
          db: admin
      scramCredentialsSecretName: mas-mongo-mck-scram

  additionalMongodConfig:
    storage.wiredTiger.engineConfig.journalCompressor: snappy
    net.tls.allowInvalidCertificates: true
    net.tls.allowInvalidHostnames: true

  statefulSet:
    spec:
      serviceName: mas-mongo-mck-svc
      selector: {}
      template:
        spec:
          securityContext:
            fsGroup: 2000
            runAsUser: 2000
          containers:
            - name: mongod
              image: "{{target_mongodb_image}}"
              resources:
                limits:
                  cpu: "{{mongodb_cpu_limits}}"
                  memory: "{{mongodb_mem_limits}}"
                requests:
                  cpu: "{{mongodb_cpu_requests}}"
                  memory: "{{mongodb_mem_requests}}"
      volumeClaimTemplates:
        - metadata:
            name: data-volume
          spec:
            accessModes: [ "ReadWriteOnce" ]
            storageClassName: "{{mongodb_storage_class}}"
            resources:
              requests:
                storage: "{{mongodb_storage_capacity_data}}"
        - metadata:
            name: logs-volume
          spec:
            accessModes: [ "ReadWriteOnce" ]
            storageClassName: "{{mongodb_storage_class}}"
            resources:
              requests:
                storage: "{{mongodb_storage_capacity_logs}}"