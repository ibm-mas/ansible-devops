---
# MongoDB Atlas Provider - Remove Route Tables for VPC Peering
# This task removes routes from AWS route tables for MongoDB Atlas VPC peering during deprovision

# 1. Retrieve Atlas API credentials from AWS Secrets Manager (if configured)
# -----------------------------------------------------------------------------
- name: "Retrieve Atlas credentials from AWS Secrets Manager"
  when:
    - atlas_aws_secret_name is defined
    - atlas_aws_secret_name != ""
    - atlas_aws_secret_region is defined
  block:
    - name: "Check if AWS CLI is available"
      command: which aws
      register: aws_cli_check
      failed_when: false
      changed_when: false

    - name: "Fail if AWS CLI is not installed"
      fail:
        msg: |
          AWS CLI is not installed or not in PATH.
          Please install AWS CLI: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html
      when: aws_cli_check.rc != 0

    - name: "Verify AWS credentials are configured"
      command: aws sts get-caller-identity
      register: aws_identity_check
      failed_when: false
      changed_when: false
      no_log: true

    - name: "Fail if AWS credentials are not configured"
      fail:
        msg: |
          AWS credentials are not configured or invalid.
          Please configure AWS CLI: aws configure
          Or set environment variables: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
      when: aws_identity_check.rc != 0

    - name: "Get Atlas API credentials from AWS Secrets Manager"
      shell: |
        aws secretsmanager get-secret-value \
          --secret-id "{{ atlas_aws_secret_name }}" \
          --region "{{ atlas_aws_secret_region }}" \
          --query SecretString \
          --output text
      register: atlas_secret_output
      failed_when: atlas_secret_output.rc != 0
      no_log: true

    - name: "Parse Atlas credentials from secret"
      set_fact:
        atlas_credentials: "{{ atlas_secret_output.stdout | from_json }}"
      no_log: true

    - name: "Set Atlas API credentials from AWS Secrets Manager"
      set_fact:
        atlas_public_key: "{{ atlas_credentials.public_key }}"
        atlas_private_key: "{{ atlas_credentials.private_key }}"
      no_log: true

  rescue:
    - name: "Display AWS Secrets Manager error details"
      debug:
        msg:
          - "=========================================="
          - "Failed to retrieve Atlas credentials from AWS Secrets Manager"
          - "=========================================="
          - "Secret Name: {{ atlas_aws_secret_name }}"
          - "Region: {{ atlas_aws_secret_region }}"
          - "=========================================="
          - "Common issues:"
          - "1. AWS CLI not configured (run: aws configure)"
          - "2. Secret doesn't exist in the specified region"
          - "3. Insufficient IAM permissions (need secretsmanager:GetSecretValue)"
          - "4. Secret name is incorrect (case-sensitive)"
          - "=========================================="
          - "To troubleshoot, run:"
          - "  aws secretsmanager describe-secret --secret-id {{ atlas_aws_secret_name }} --region {{ atlas_aws_secret_region }}"
          - "=========================================="

    - name: "Fail with helpful error message"
      fail:
        msg: "Failed to retrieve Atlas API credentials from AWS Secrets Manager. See debug output above for troubleshooting steps."

# 2. Validate required variables
# -----------------------------------------------------------------------------
- name: "Fail if Atlas API credentials are not provided"
  assert:
    that:
      - atlas_public_key is defined and atlas_public_key != ""
      - atlas_private_key is defined and atlas_private_key != ""
    fail_msg: "Atlas API credentials (atlas_public_key and atlas_private_key) are required"

- name: "Fail if Atlas project information is not provided"
  assert:
    that:
      - atlas_project_id is defined and atlas_project_id != ""
    fail_msg: "Atlas project ID is required"

# Set the working variable - handle both string and array formats
- name: "Convert route table IDs to array if needed"
  set_fact:
    atlas_aws_route_table_ids_working: "{{ atlas_aws_route_table_ids if atlas_aws_route_table_ids is not string else atlas_aws_route_table_ids.split(',') }}"
  when: atlas_aws_route_table_ids is defined

- name: "Fail if required configuration is not provided"
  assert:
    that:
      - atlas_vpc_id is defined and atlas_vpc_id != ""
      - atlas_aws_region is defined and atlas_aws_region != ""
      - atlas_aws_route_table_ids_working is defined and atlas_aws_route_table_ids_working | length > 0
      - atlas_provider_name is defined and atlas_provider_name != ""
    fail_msg: "Required configuration (vpc_id, aws_region, route_table_ids, provider_name) is missing"

# 3. Convert region format for AWS CLI (Atlas uses US_EAST_1, AWS CLI uses us-east-1)
# -----------------------------------------------------------------------------
- name: "Convert Atlas region format to AWS CLI format"
  set_fact:
    aws_cli_region: "{{ atlas_aws_region | lower | replace('_', '-') }}"

# 4. Display initial configuration
# -----------------------------------------------------------------------------
- name: "MongoDB Atlas Route Table Removal Configuration"
  debug:
    msg:
      - "=========================================="
      - "MongoDB Atlas Route Table Removal"
      - "=========================================="
      - "Atlas Project ID ............ {{ atlas_project_id }}"
      - "Provider Name ............... {{ atlas_provider_name }}"
      - "Atlas Region (API format) ... {{ atlas_aws_region }}"
      - "AWS Region (CLI format) ..... {{ aws_cli_region }}"
      - "VPC ID ...................... {{ atlas_vpc_id }}"
      - "Route Table IDs ............. {{ atlas_aws_route_table_ids_working | length }} tables"
      - "=========================================="

# 5. Get MongoDB Atlas network containers
# -----------------------------------------------------------------------------
- name: "Get Atlas network containers"
  uri:
    url: "{{ atlas_api_base_url }}/groups/{{ atlas_project_id }}/containers"
    method: GET
    user: "{{ atlas_public_key }}"
    password: "{{ atlas_private_key }}"
    force_basic_auth: no
    status_code: [200]
    timeout: "{{ atlas_api_timeout }}"
  register: atlas_containers_response
  retries: 3
  delay: 5
  failed_when: false

- name: "Display network containers"
  debug:
    msg: "Found {{ atlas_containers_response.json.results | length }} network containers"
  when: atlas_containers_response.status == 200

# 6. Find the container for the specified region and provider
# -----------------------------------------------------------------------------
- name: "Find container for region {{ atlas_aws_region }} and provider {{ atlas_provider_name }}"
  set_fact:
    atlas_container: "{{ atlas_containers_response.json.results | selectattr('regionName', 'equalto', atlas_aws_region) | selectattr('providerName', 'equalto', atlas_provider_name) | first }}"
  when:
    - atlas_containers_response.status == 200
    - atlas_containers_response.json.results | selectattr('regionName', 'equalto', atlas_aws_region) | selectattr('providerName', 'equalto', atlas_provider_name) | list | length > 0

- name: "No container found for region"
  debug:
    msg: "No Atlas network container found for region {{ atlas_aws_region }} and provider {{ atlas_provider_name }}. Skipping route removal."
  when: atlas_container is not defined

- name: "Display container information"
  debug:
    msg:
      - "Container ID ................ {{ atlas_container.id }}"
      - "Region Name ................. {{ atlas_container.regionName }}"
      - "Atlas CIDR Block ............ {{ atlas_container.atlasCidrBlock }}"
      - "Provider Name ............... {{ atlas_container.providerName }}"
  when: atlas_container is defined

# 7. Remove routes from AWS route tables
# -----------------------------------------------------------------------------
- name: "Remove routes from route tables"
  when: atlas_container is defined
  block:
    - name: "Check if route exists in route table"
      shell: |
        aws ec2 describe-route-tables \
          --route-table-ids {{ item }} \
          --region {{ aws_cli_region }} \
          --query "RouteTables[0].Routes[?DestinationCidrBlock=='{{ atlas_container.atlasCidrBlock }}'].DestinationCidrBlock" \
          --output text
      register: existing_route_check
      loop: "{{ atlas_aws_route_table_ids_working }}"
      changed_when: false
      failed_when: false

    - name: "Delete route from each route table"
      shell: |
        aws ec2 delete-route \
          --route-table-id {{ item.item }} \
          --destination-cidr-block {{ atlas_container.atlasCidrBlock }} \
          --region {{ aws_cli_region }}
      loop: "{{ existing_route_check.results }}"
      when: item.stdout != ""
      register: route_deletion_result
      failed_when: false

    - name: "Display route deletion results"
      debug:
        msg:
          - "Route Table ID: {{ item.item.item }}"
          - "Status: {{ 'Deleted' if item.changed else 'Not found' }}"
      loop: "{{ route_deletion_result.results }}"
      when: route_deletion_result.results is defined

# 8. Verify routes were removed
# -----------------------------------------------------------------------------
- name: "Verify routes removed from route tables"
  when: atlas_container is defined
  block:
    - name: "Check routes in route tables"
      shell: |
        aws ec2 describe-route-tables \
          --route-table-ids {{ item }} \
          --region {{ aws_cli_region }} \
          --query "RouteTables[0].Routes[?DestinationCidrBlock=='{{ atlas_container.atlasCidrBlock }}']" \
          --output json
      register: route_verification
      loop: "{{ atlas_aws_route_table_ids_working }}"
      changed_when: false
      failed_when: false

    - name: "Display route verification"
      debug:
        msg:
          - "Route Table: {{ item.item }}"
          - "Remaining Routes: {{ (item.stdout | from_json) | length }}"
      loop: "{{ route_verification.results }}"

# 9. Display removal results
# -----------------------------------------------------------------------------
- name: "Route table removal completed successfully"
  debug:
    msg:
      - "=========================================="
      - "MongoDB Atlas Route Tables Removed!"
      - "=========================================="
      - "Atlas CIDR Block ............ {{ atlas_container.atlasCidrBlock if atlas_container is defined else 'N/A' }}"
      - "Routes Removed .............. {{ atlas_aws_route_table_ids_working | length }} route tables"
      - "AWS Region .................. {{ atlas_aws_region }}"
      - "Provider Name ............... {{ atlas_provider_name }}"
      - "=========================================="