---
# Check mongodb backup variables
# -----------------------------------------------------------------------------
- name: "Fail if MAS_INSTANCE_ID is not provided"
  assert:
    that: mas_instance_id is defined and mas_instance_id != ""
    fail_msg: "MAS_INSTANCE_ID is required"

- name: "Fail if MAS_BACKUP_DIR is not provided"
  assert:
    that: mas_backup_dir is defined and mas_backup_dir != ""
    fail_msg: "MAS_BACKUP_DIR is required"

- name: "Check if MONGODB_BACKUP_VERSION is provided, if not set to default 'YYMMDD-HHMMSS' format"
  set_fact:
    mongodb_backup_version: "{{ ibm.mas_devops.generate_backup_version }}"
  when: mongodb_backup_version is not defined or mongodb_backup_version == ""

- name: "Set fact: Create Mongodb backup base directory path"
  set_fact:
    mongodb_backup_path: "{{ mas_backup_dir }}/{{ mongodb_action }}-{{ mongodb_backup_version }}-mongoce"

- name: "Set fact: Create Resources and Data backup paths"
  include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/create_backup_dirs.yml"
  vars:
    backup_base_path: "{{ mongodb_backup_path }}"


# Backup Mongodb Kubernetes Resources
# -------------------------------------------------------------------------

- name: "Debug information - Mongodb Cluster Instance backup"
  debug:
    msg:
      - "MongoCE namespace .......................... {{ mongodb_namespace }}"
      - "MongoCE instance name ...................... {{ mongodb_instance_name }}"
      - "MongoCE version ............................ {{ mongodb_version }}"

- name: "Start Mongo Instance backup process."
  include_role:
    name: ibm.mas_devops.backup_mongo_instance_resources
  vars:
    mongodb_backup_resource_path: "{{ backup_resources_path }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    mongodb_provider: "{{ mongodb_provider }}"


# Backup Mongodb database Data using mondodump
# -------------------------------------------------------------------------

- name: "Debug information - Mongodb database Data backup"
  debug:
    msg:
      - "MongoCE namespace .......................... {{ mongodb_namespace }}"
      - "MongoCE instance name ...................... {{ mongodb_instance_name }}"
      - "MongoCE version ............................ {{ mongodb_version }}"

# - name: "Start Database backup process."
#   include_tasks: "{{ role_path }}/tasks/providers/{{ mongodb_provider }}/backup-restore/backup-database.yml"
