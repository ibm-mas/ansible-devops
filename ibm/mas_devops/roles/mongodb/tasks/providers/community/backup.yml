---
# Check mongodb backup variables
# -----------------------------------------------------------------------------

- name: "Fail if require variables for Mongodb backup are not provided"
  ibm.mas_devops.verify_backup_restore_vars:
    mas_instance_id: "{{ mas_instance_id }}"
    mas_backup_dir: "{{ mas_backup_dir }}"
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    action: "{{ mongodb_action }}"
    component: "mongodb"


- name: "Check if MONGODB_BACKUP_VERSION is provided, if not set to default 'YYMMDD-HHMMSS' format"
  set_fact:
    mongodb_backup_version: "{{ lookup('pipe', 'date +%y%m%d-%H%M%S') }}"
  when: mongodb_backup_version is not defined or mongodb_backup_version == ""

- name: "Set fact: Create Mongodb backup base directory path"
  set_fact:
    mongodb_backup_path: "{{ mas_backup_dir }}/{{ mongodb_action }}-{{ mongodb_backup_version }}-mongoce"

- name: "Set fact: Create Resources and Data backup paths"
  include_tasks: "{{ role_path }}/../../common_tasks/backup_restore/create_backup_dirs.yml"
  vars:
    backup_base_path: "{{ mongodb_backup_path }}"


# Backup Mongodb Kubernetes Resources
# -------------------------------------------------------------------------

- name: "Start Mongo Instance backup process."
  ibm.mas_devops.backup_mongo_instance:
    mongodb_backup_resource_path: "{{ backup_resources_path }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
    mongodb_instance_name: "{{ mongodb_instance_name }}"
  register: mongo_instance_backup_result
  when: not skip_instance_backup_restore

- name: "Assert Mongo Instance backup success"
  assert:
    that:
      - mongo_instance_backup_result is defined
      - mongo_instance_backup_result.success == true
    fail_msg: "MongoDB Instance resources backup failed."
  when: mongo_instance_backup_result is defined


# Backup Mongodb database Data using mondodump
# -------------------------------------------------------------------------

- name: "Debug information - Mongodb database Data backup"
  debug:
    msg:
      - "MongoCE namespace .......................... {{ mongodb_namespace }}"
      - "MongoCE instance name ...................... {{ mongodb_instance_name }}"
      - "{{ 'MongoCE version ............................ ' ~ mongodb_version if mongodb_version is defined else omit }}"

- name: "Start Database backup process."
  include_tasks: "{{ role_path }}/tasks/providers/{{ mongodb_provider }}/backup-restore/backup-database.yml"
