---
# Check mongodb restore required variables
# -----------------------------------------------------------------------------
- name: "Fail if require variables for Mongodb {{ mongodb_action }} are not provided"
  ibm.mas_devops.verify_backup_restore_vars:
    mas_instance_id: "{{ mas_instance_id }}"
    mas_backup_dir: "{{ mas_backup_dir }}"
    mongodb_backup_version: "{{ mongodb_backup_version }}"
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    action: "{{ mongodb_action }}"
    component: "mongodb"

- name: "Set fact: backup dir paths"
  set_fact:
    mongodb_backup_dir: "{{ mas_backup_dir }}/backup-{{ mongodb_backup_version }}-mongoce"
    mongodb_resource_path: "{{ mas_backup_dir }}/backup-{{ mongodb_backup_version }}-mongoce/resources"
    mongodb_data_path: "{{ mas_backup_dir }}/backup-{{ mongodb_backup_version }}-mongoce/data"

# Check for existing MongoDb install
# -----------------------------------------------------------------------------
- name: "Check for existing MongoDB installation in namespace {{ mongodb_namespace }}"
  ibm.mas_devops.verify_mongoce_version:
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
  register: existing_mongo_info

# Start MongoCE Cluster instance restore
# When the existing mongo instance is not running or not present
# -----------------------------------------------------------------------------
- name: "Start MongoCE cluster instance restore"
  when:
    - not br_skip_instance
    - existing_mongo_info is defined
    - not existing_mongo_info.running
  include_tasks: "{{ role_path }}/tasks/providers/{{ mongodb_provider }}/backup-restore/restore-cluster-from-backup.yml"

# Recheck for existing MongoDb state
# Just make sure the restore-cluster-from-backup task has created the instance and is running
# -----------------------------------------------------------------------------
- name: "Recheck for existing MongoDB installation in namespace {{ mongodb_namespace }}"
  ibm.mas_devops.verify_mongoce_version:
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
  register: existing_mongo_info_2
  when:
    - not br_skip_instance
    - existing_mongo_info is defined
    - not existing_mongo_info.running

- name: "Start Database restore process."
  include_tasks: "{{ role_path }}/tasks/providers/{{ mongodb_provider }}/backup-restore/restore-database.yml"
  when: (existing_mongo_info is defined and existing_mongo_info.running) or (existing_mongo_info_2 is defined and existing_mongo_info_2.running)
