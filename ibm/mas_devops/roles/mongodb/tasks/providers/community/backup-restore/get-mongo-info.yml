---
# Get mongodb version and status
# -----------------------------------------------------------------------------
- name: "Get MongoDBCommunity"
  kubernetes.core.k8s_info:
    api_version: mongodbcommunity.mongodb.com/v1
    kind: MongoDBCommunity
    name: "{{ mongodb_instance_name }}"
    namespace: "{{ mongodb_namespace }}"
  register: mongodbcommunity_output

- name: "Set fact: mongodb version"
  set_fact:
    mongodb_version: "{{ mongodbcommunity_output.resources[0].spec.version }}"
  when:
    - mongodbcommunity_output is defined
    - mongodbcommunity_output.resources[0] is defined
    - mongodbcommunity_output.resources[0].spec.version is defined

- name: "Fail if mongodb does not exists"
  assert:
    that: mongodb_version is defined
    fail_msg: "Mongodb does not exists!"

- name: "Set fact: mongodb running status"
  set_fact:
    mongodb_running: true
  when:
    - mongodbcommunity_output is defined
    - mongodbcommunity_output.resources[0] is defined
    - mongodbcommunity_output.resources[0].status is defined
    - mongodbcommunity_output.resources[0].status.phase is defined
    - mongodbcommunity_output.resources[0].status.phase == "Running"

- name: "Fail if mongodb is not running"
  assert:
    that: mongodb_running is defined and mongodb_running
    fail_msg: "Mongodb is not running!"

- name: "Set MongoDBCommunity Backup output"
  set_fact:
    mongodbcommunity_backup_output: "{{ mongodbcommunity_output.resources[0] }}"



