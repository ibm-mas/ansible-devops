#!/bin/bash

MONGODB_BACKUP_USER="bradmin"

ALL_DATABASES_FILTER="^(mas|iot)(_|-){{ mas_instance_id }}(_|-)(?!.*monitor$)"

tlsCAFile=$(ls /var/lib/tls/ca/*.pem)
echo "Using TLS CA file: $tlsCAFile"
primary_host=""

is_primary=$(mongosh --quiet -u {{ mongodb_admin_user }} -p {{ mongodb_admin_password }} --host {{ mongodb_host }} --tlsCAFile $tlsCAFile --authenticationDatabase=admin --tls --eval 'db.isMaster().ismaster')
cmdrc=$?
if [ $cmdrc -ne 0 ]; then
    echo "Error checking if node is primary. Exiting."
    exit 1
fi

if [ "$is_primary" != "true" ]; then
    echo "This node is not primary. Get Primary from server status."
    primary_host=$(mongosh --quiet -u {{ mongodb_admin_user }} -p {{ mongodb_admin_password }} --tlsCAFile $tlsCAFile --host {{ mongodb_host }} --authenticationDatabase=admin --tls --eval 'rs.isMaster().primary')
    cmdrc=$?
    if [ $cmdrc -ne 0 ]; then
        echo "Error getting primary node. Exiting."
        exit 1
    fi
    echo "Primary host is: $primary_host"
fi

if [ -n "$primary_host" ]; then
    echo "Connecting to primary host: $primary_host to create user."
    mongo_cmd="mongosh --quiet -u {{ mongodb_admin_user }} -p {{ mongodb_admin_password }} --tlsCAFile $tlsCAFile --authenticationDatabase=admin --tls --host $primary_host"
else
    echo "Creating user on current primary node."
    mongo_cmd="mongosh --quiet -u {{ mongodb_admin_user }} -p {{ mongodb_admin_password }} --tlsCAFile $tlsCAFile --authenticationDatabase=admin --tls --host {{ mongodb_host }}"
fi

# Create temporary directory for backup

tmp_backup_dir="/tmp/masbr"
mkdir -p $tmp_backup_dir
if [ $? -ne 0 ]; then
    echo "Error creating temporary backup directory $tmp_backup_dir. Exiting."
    exit 1
fi

# Take a full backup of mongodb databases"

echo "Taking full backup of MongoDB databases to $tmp_backup_dir"
mongodb_db_names=$($mongo_cmd --quiet --eval "db.adminCommand( { listDatabases: 1, nameOnly: true, filter: { name: /{{ mongodb_db_filter }}/ }} );")


