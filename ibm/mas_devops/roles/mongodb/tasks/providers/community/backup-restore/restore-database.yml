---

- name: "Set fact: mongodb restore paths and filename"
  set_fact:
    mongodb_backup_data_filename: "mongodump-{{ mongodb_backup_version }}.tar.gz"
    mongodb_tmp_restore_dir: "/tmp/masbr/{{ mongodb_backup_version }}"

- name: "Check if backup data files exists"
  stat:
    path: "{{ item }}"
  register: backup_data_files
  loop:
    - "{{ mongodb_data_path }}/{{ mongodb_backup_data_filename }}"
    - "{{ mongodb_data_path }}/mongodb-info.yaml"

- name: "Assert backup data files exist"
  assert:
    that:
      - backup_data_files.results[0].stat.exists
      - backup_data_files.results[1].stat.exists
    fail_msg: "Required backup data files are missing in {{ mongodb_data_path }}. Ensure that the backup process completed successfully."

- name: include vars from mongodb-info.yaml
  include_vars:
    file: "{{ mongodb_data_path }}/mongodb-info.yaml"
    name: mongodb_backup_info

- name: "Set facts: from mongodb cr and resources"
  ibm.mas_devops.get_mongoce_info:
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
  register: mongodb_info_result

- name: "Assert mongodb_info_result"
  assert:
    that:
      - mongodb_info_result.success

- name: "Set fact: mongodb info"
  set_fact:
    mongoce_pod_name: "{{ mongodb_info_result.mongoce_pod_name }}"
    mongodb_version: "{{ mongodb_info_result.mongodb_version }}"
    mongodb_service_name: "{{ mongodb_info_result.mongodb_service_name }}"
    mongodb_host: "{{ mongodb_info_result.mongodb_host }}"
    mongodb_admin_user: "{{ mongodb_info_result.mongodb_admin_user }}"
    mongodb_admin_password: "{{ mongodb_info_result.mongodb_admin_password }}"

- name: "Assert if target mongoce version match backup mongoce version"
  assert:
    that:
      - mongodb_version.split('.')[:2] == mongodb_backup_info.source_mongodb_version.split('.')[:2]
    fail_msg: "MongoDB major.minor version mismatch.. Target MongoCE version {{ mongodb_version }} does NOT match backup MongoCE version {{ mongodb_backup_info.source_mongodb_version }}. Restore cannot proceed."

- name: "debug facts"
  debug:
    msg:
      - "mongoce_pod_name .................................. {{ mongoce_pod_name }}"
      - "mongodb_version ................................... {{ mongodb_version }}"
      - "mongodb_service_name .............................. {{ mongodb_service_name }}"
      - "mongodb_host ...................................... {{ mongodb_host }}"
      - "mongodb_backup_version ............................ {{ mongodb_backup_version }}"

# Prepare shell scripts for restore and transfer scripts to mongo pod
# -----------------------------------------------------------------------------
- block:
  - name: Create create-role-user.sh script in local /tmp
    ansible.builtin.template:
      src: community/backup-restore/create-role-user.sh.j2
      dest: /tmp/create-role-user.sh
      mode: '777'

  - name: Create database-restore.sh script in local /tmp
    ansible.builtin.template:
      src: community/backup-restore/database-restore.sh.j2
      dest: /tmp/database-restore.sh
      mode: '777'

  - name: Copy the create-role-user.sh script into the mongodb pod
    shell: "oc cp --retries=50 /tmp/create-role-user.sh {{ mongodb_namespace }}/{{ mongoce_pod_name }}:/tmp/create-role-user.sh -c mongod"
    register: copy_result
    retries: 2
    delay: 15 # seconds
    until: copy_result.rc == 0

  - name: Copy the database-restore.sh script into the mongodb pod
    shell: "oc cp --retries=50 /tmp/database-restore.sh {{ mongodb_namespace }}/{{ mongoce_pod_name }}:/tmp/database-restore.sh -c mongod"
    register: copy_result
    retries: 2
    delay: 15 # seconds
    until: copy_result.rc == 0

# The log file will also be available inside the pod /tmp/create-role-user.log
- name: Exec into mongo pod and run create-role-user.sh to setup restore role and user in Mongodb.
  shell: |
    oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -- bash /tmp/create-role-user.sh
  register: create_roleuser_output

- name: "Debug create-role-user logs"
  debug:
    msg: "{{ create_roleuser_output.stdout_lines }}"

- name: "Assert Create role user"
  assert:
    that:
      - create_roleuser_output.rc == 0
      - create_roleuser_output.stdout | regex_search('ROLEUSERstatus-SUCCESS', multiline=True) is not none
    fail_msg: "Failed to create role and user for restore"

# Create temporary restore directory
- name: "Create temporary restore directory in mongodb pod and clean up any existing files"
  shell: oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -c mongod -- bash -c 'rm -rf {{ mongodb_tmp_restore_dir }}; mkdir -p {{ mongodb_tmp_restore_dir }}'
  register: create_tmpdir_output

- name: "Copy backup data file into mongodb pod"
  shell: |
    oc cp --retries=50 {{ mongodb_data_path }}/{{ mongodb_backup_data_filename }} {{ mongodb_namespace }}/{{ mongoce_pod_name }}:{{ mongodb_tmp_restore_dir }}/{{ mongodb_backup_data_filename }} -c mongod
  register: copy_backupdata_output

- name: "Running restore script in pod, check logs in /tmp/database-restore.log in pod"
  shell: |
    oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -c mongod -- bash -c '/tmp/database-restore.sh | tee /tmp/database-restore.log'
  register: database_restore_output

- name: Assert database restore
  assert:
    that:
      - database_restore_output.rc == 0
      - database_restore_output.stdout | regex_search('DATABASERESTOREstatus-SUCCESS', multiline=True) is not none
    fail_msg: "Failed to restore database from backup"

- name: "Debug database-restore logs"
  debug:
    msg: "{{ database_restore_output.stdout_lines }}"
