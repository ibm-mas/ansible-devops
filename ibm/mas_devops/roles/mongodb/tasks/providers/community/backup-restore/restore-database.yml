---

- name: "Set fact: mongodb restore paths and filename"
  set_fact:
    mongodb_backup_data_filename: "mongodump-{{ mongodb_backup_version }}.tar.gz"
    mongodb_tmp_restore_dir: "/tmp/masbr/{{ mongodb_backup_version }}"

- name: "Check if backup data file exists"
  stat:
    path: "{{ mongodb_data_path }}/{{ mongodb_backup_data_filename }}"
  register: backup_data_file_check

- name: Assert backup data file exists
  assert:
    that:
      - backup_data_file_check.stat.exists | default(False)
    fail_msg: "Backup data file {{ mongodb_data_path }}/{{ mongodb_backup_data_filename }} does NOT exist!"

- name: "Set facts: from mongodb cr and resources"
  ibm.mas_devops.get_mongoce_info:
    mongodb_instance_name: "{{ mongodb_instance_name }}"
    mongodb_namespace: "{{ mongodb_namespace }}"
  register: mongodb_info_result

- name: "Assert mongodb_info_result"
  assert:
    that:
      - mongodb_info_result.success

- name: "debug facts"
  debug:
    msg:
      - "mongoce_pod_name .................................. {{ mongoce_pod_name }}"
      - "mongodb_version ................................... {{ mongodb_version }}"
      - "mongodb_service_name .............................. {{ mongodb_service_name }}"
      - "mongodb_host ...................................... {{ mongodb_host }}"
      - "mongodb_backup_version ............................ {{ mongodb_backup_version }}"

# Prepare shell scripts for restore and transfer scripts to mongo pod
# -----------------------------------------------------------------------------
- block:
  - name: Create create-role-user.sh script in local /tmp
    ansible.builtin.template:
      src: create-role-user.sh.j2
      dest: /tmp/create-role-user.sh
      mode: '777'

  - name: Create database-backup.sh script in local /tmp
    ansible.builtin.template:
      src: database-restore.sh.j2
      dest: /tmp/database-restore.sh
      mode: '777'

  - name: Copy the create-role-user.sh script into the mongodb pod
    shell: "oc cp /tmp/create-role-user.sh {{ mongodb_namespace }}/{{ mongoce_pod_name }}:/tmp/create-role-user.sh -c mongod"
    register: copy_result
    retries: 2
    delay: 15 # seconds
    until: copy_result.rc == 0

  - name: Copy the database-restore.sh script into the mongodb pod
    shell: "oc cp /tmp/database-restore.sh {{ mongodb_namespace }}/{{ mongoce_pod_name }}:/tmp/database-restore.sh -c mongod"
    register: copy_result
    retries: 2
    delay: 15 # seconds
    until: copy_result.rc == 0

# The log file will also be available inside the pod /tmp/create-role-user.log
- name: Exec into mongo pod and run create-role-user.sh to setup backup role and user in Mongodb.
  shell: |
    oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -- bash /tmp/create-role-user.sh
  register: create_roleuser_output
  ignore_errors: true
  retries: 1
  delay: 10 # seconds
  until:
    - create_roleuser_output.rc == 0
    - create_roleuser_output.stdout | regex_search('ROLEUSERstatus-SUCCESS', multiline=True)

- name: "Debug create-role-user logs"
  debug:
    msg: "{{ create_roleuser_output.stdout_lines }}"

# Create temporary restore directory
- name: "Create temporary restore directory in mongodb pod and clean up any existing files"
  shell: |
    oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -c mongod -- mkdir -p {{ mongodb_tmp_restore_dir }} && rm -rf {{ mongodb_tmp_restore_dir }}/*
  register: create_tmpdir_output
  retries: 2
  delay: 15 # seconds
  until: create_tmpdir_output.rc == 0

- name: "Copy backup data file into mongodb pod"
  shell: |
    oc cp {{ mongodb_data_path }}/{{ mongodb_backup_data_filename }} {{ mongodb_namespace }}/{{ mongoce_pod_name }}:{{ mongodb_tmp_restore_dir }}/{{ mongodb_backup_data_filename }} -c mongod
  register: copy_backupdata_output
  retries: 2
  delay: 15 # seconds
  until: copy_backupdata_output.rc == 0

- name: "Exec into mongo pod and run database-restore.sh to restore the database from backup."
  shell: |
    oc exec -n {{mongodb_namespace}} {{mongoce_pod_name}} -- bash /tmp/database-restore.sh
  register: database_restore_output
  ignore_errors: true
  retries: 1
  delay: 10 # seconds
  until:
    - database_restore_output.rc == 0
    - database_restore_output.stdout | regex_search('DATABASERESTOREstatus-SUCCESS', multiline=True)

- name: "Debug database-restore logs"
  debug:
    msg: "{{ database_restore_output.stdout_lines }}"
