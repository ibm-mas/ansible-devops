---
# Backup kubernetes configmaps
# -----------------------------------------------------------------------------

- name: Get Kubernetes configmaps
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Configmap
    name: "{{ item }}"
    namespace: "{{ mongodb_namespace}}"
  register: configmap_data

- name: Filter configmap metadata (remove specified fields)
  set_fact:
    metadata_filtered: >-
      {{
        (configmap_data.resources[0].metadata | default({})) 
        | dict2items 
        | rejectattr('key', 'in', ['annotations' , 'creationTimestamp', 'managedFields', 'resourceVersion', 'selfLink', 'uid']) 
        | items2dict
      }}
  when:
    - configmap_data.resources[0] is defined
    - configmap_data.resources[0].metadata is defined

- name: Update metadata in the configmap_data
  set_fact:
    configmap_data: "{{ configmap_data.resources[0] | combine({'metadata': metadata_filtered}) }}"
  when:
    - configmap_data.resources[0] is defined
    - configmap_data.resources[0].metadata is defined

- name: "Save configmap resource to file"
  copy:
    content: "{{ configmap_data | to_nice_yaml }}"
    dest: "{{ mongodb_backup_configmaps_path }}/{{ item }}.yaml"
  when:
    - mongodb_backup_configmaps_path is defined
    - configmap_data is defined
