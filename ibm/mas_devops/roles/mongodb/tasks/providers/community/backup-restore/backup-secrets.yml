---
# Backup kubernetes secrets
# -----------------------------------------------------------------------------

- name: Get Kubernetes secrets
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ item.name }}"
    namespace: "{{ mongodb_namespace}}"
  register: secret_data

- name: Filter secret metadata (remove specified fields)
  set_fact:
    metadata_filtered: >-
      {{
        (secret_data.resources[0].metadata | default({})) 
        | dict2items 
        | rejectattr('key', 'in', ['annotations' , 'creationTimestamp', 'managedFields', 'resourceVersion', 'selfLink', 'uid']) 
        | items2dict
      }}

- name: "Debug metadata_filtered"
  debug:
    msg: "{{ metadata_filtered }}"

- name: Update metadata in the secret_data
  set_fact:
    secret_data: "{{ secret_data.resources[0] | combine({'metadata': metadata_filtered}) }}"

- name: "Debug secret_data"
  debug:
    msg: "{{ secret_data }}"

- name: "Save Secret resource to file"
  copy:
    content: "{{ secret_data | to_nice_yaml }}"
    dest: "{{ mongodb_backup_secrets_path }}/secret-{{ item.name }}.yaml"
  when:
    - mongodb_backup_resources_path is defined
    - secret_data is defined
