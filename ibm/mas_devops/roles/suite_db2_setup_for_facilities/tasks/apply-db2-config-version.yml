---
# Step 1: Detect CR type
- name: "Detect Db2 CR type"
  include_tasks: tasks/detect-db2-cr-type.yml

# Step 2: Validate detection results
- name: "Validate CR detection"
  include_tasks: tasks/validate-db2-cr.yml

# Step 3: Lookup and wait for Db2 Pod (already done in main.yml, but verify)
- name: "Lookup db2 Pod"
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ db2_namespace }}"
    label_selectors:
      - type=engine
      - app={{ db2_instance_name }}
    wait: yes
    wait_sleep: 30
    wait_timeout: 300
    wait_condition:
      type: Ready
      status: "True"
  register: db2_pod

- name: Configure facts
  set_fact:
    db2_pod_name: "{{ db2_pod.resources[0].metadata.name }}"

- name: "Debug information"
  debug:
    msg:
      - "Pod name ............................... {{ db2_pod_name }}"
      - "CR Type ................................ {{ db2_cr_type }}"
      - "DB2 Schema ............................. {{ db2_schema }}"
      - "DB2 Username ........................... {{ db2_username }}"

# Step 4: Load and transform configuration
- name: "Load configuration variables"
  include_vars: vars/main.yml

- name: "Transform configuration for CR type"
  include_tasks: tasks/transform-db2-config.yml

# Step 5: Update CR with configuration
- name: "Update {{ db2_cr_type }} configuration"
  kubernetes.core.k8s:
    merge_type: merge
    definition:
      apiVersion: "{{ db2_cr_api_version }}"
      kind: "{{ db2_cr_type }}"
      metadata:
        name: "{{ db2_instance_name | lower }}"
        namespace: "{{ db2_namespace }}"
      spec: "{{ db2_config_transformed | from_yaml }}"
  register: _config_update_result

- name: "Debug configuration update result"
  debug:
    msg:
      - "Configuration update status: {{ _config_update_result.changed }}"
      - "CR Type: {{ db2_cr_type }}"
  when: ansible_verbosity >= 1

# Step 6: Set db2_instance_uid for ConfigMap ownership reference
- name: "Set db2_instance_uid variable"
  set_fact:
    db2_instance_uid: "{{ db2_cr_resource.metadata.uid }}"

# Step 7: Create ConfigMap to track version
- name: Create k8s configmap for DB2 config version
  kubernetes.core.k8s:
    state: present
    namespace: "{{ db2_namespace }}"
    template: "templates/db2_enforce_config.yaml.j2"
