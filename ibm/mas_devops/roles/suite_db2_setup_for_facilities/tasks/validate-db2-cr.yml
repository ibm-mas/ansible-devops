---
# Validate CR detection results and Facilities-specific requirements

- name: "Validate CR detection results"
  assert:
    that:
      - db2_cr_type is defined
      - db2_cr_type in ['Db2uCluster', 'Db2uInstance']
      - db2_cr_exists | bool
      - db2_cr_resource is defined
      - db2_cr_resource | length > 0
    fail_msg: |
      CR detection validation failed:
      - CR Type: {{ db2_cr_type | default('undefined') }}
      - CR Exists: {{ db2_cr_exists | default('undefined') }}
      - CR Resource: {{ 'defined' if db2_cr_resource is defined else 'undefined' }}
    success_msg: "CR validation successful: {{ db2_cr_type }} detected"

- name: "Validate CR is in Ready state"
  assert:
    that:
      - db2_cr_resource.status is defined
      - db2_cr_resource.status.state is defined
      - db2_cr_resource.status.state == "Ready"
    fail_msg: |
      Db2 instance '{{ db2_instance_name }}' is not in Ready state.
      Current state: {{ db2_cr_resource.status.state | default('Unknown') }}
      Please wait for the instance to be ready before applying configuration.
    success_msg: "Db2 instance is Ready"

- name: "Validate required configuration version"
  assert:
    that:
      - db2_config_version is defined
      - db2_config_version != ""
      - db2_config_version in db2_configs.keys()
    fail_msg: |
      Invalid or missing db2_config_version: {{ db2_config_version | default('undefined') }}
      Available versions: {{ db2_configs.keys() | list }}
    success_msg: "Configuration version {{ db2_config_version }} is valid"

- name: "Validate Facilities-specific variables"
  assert:
    that:
      - db2_schema is defined and db2_schema != ""
      - db2_username is defined and db2_username != ""
      - db2_tablespace_data_size is defined and db2_tablespace_data_size != ""
      - db2_tablespace_index_size is defined and db2_tablespace_index_size != ""
    fail_msg: |
      Missing required Facilities-specific variables:
      - db2_schema: {{ db2_schema | default('undefined') }}
      - db2_username: {{ db2_username | default('undefined') }}
      - db2_tablespace_data_size: {{ db2_tablespace_data_size | default('undefined') }}
      - db2_tablespace_index_size: {{ db2_tablespace_index_size | default('undefined') }}
    success_msg: "All Facilities-specific variables are valid"

# Made with Bob
