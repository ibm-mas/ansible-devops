---
# Detect which Db2 CR type exists in the namespace
# This task is called after DB2 installation and before configuration

- name: "Lookup Db2uCluster instance"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    kind: Db2uCluster
    name: "{{ db2_instance_name | lower }}"
    namespace: "{{ db2_namespace }}"
  register: _db2_cluster_lookup
  failed_when: false

- name: "Lookup Db2uInstance instance"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    kind: Db2uInstance
    name: "{{ db2_instance_name | lower }}"
    namespace: "{{ db2_namespace }}"
  register: _db2_instance_lookup
  failed_when: false

- name: "Determine CR type and validate"
  set_fact:
    db2_cr_type: >-
      {%- if _db2_cluster_lookup.resources | default([]) | length > 0 and _db2_instance_lookup.resources | default([]) | length > 0 -%}
        both
      {%- elif _db2_cluster_lookup.resources | default([]) | length > 0 -%}
        Db2uCluster
      {%- elif _db2_instance_lookup.resources | default([]) | length > 0 -%}
        Db2uInstance
      {%- else -%}
        none
      {%- endif -%}
    db2_cr_exists: >-
      {{ (_db2_cluster_lookup.resources | default([]) | length > 0) or 
         (_db2_instance_lookup.resources | default([]) | length > 0) }}

- name: "Fail if both CR types exist"
  fail:
    msg: |
      ERROR: Both Db2uCluster and Db2uInstance resources exist for '{{ db2_instance_name }}'.
      This is an invalid state. Please ensure only one CR type exists.
      - Db2uCluster: {{ _db2_cluster_lookup.resources | length }} found
      - Db2uInstance: {{ _db2_instance_lookup.resources | length }} found
  when: db2_cr_type == "both"

- name: "Fail if no CR exists"
  fail:
    msg: |
      ERROR: No Db2 instance found with name '{{ db2_instance_name }}' in namespace '{{ db2_namespace }}'.
      Expected either Db2uCluster or Db2uInstance resource to exist.
      This may indicate that the DB2 installation did not complete successfully.
  when: db2_cr_type == "none"

- name: "Set CR-specific facts"
  set_fact:
    db2_cr_resource: >-
      {{ _db2_cluster_lookup.resources[0] if db2_cr_type == 'Db2uCluster' 
         else _db2_instance_lookup.resources[0] }}
    db2_cr_api_version: "db2u.databases.ibm.com/v1"
    db2_cr_is_ready: >-
      {{ (db2_cr_type == 'Db2uCluster' and _db2_cluster_lookup.resources[0].status.state | default('') == 'Ready') or
         (db2_cr_type == 'Db2uInstance' and _db2_instance_lookup.resources[0].status.state | default('') == 'Ready') }}

- name: "Display detected CR type"
  debug:
    msg:
      - "Detected Db2 CR Type .................. {{ db2_cr_type }}"
      - "CR Name ............................... {{ db2_instance_name | lower }}"
      - "CR Namespace .......................... {{ db2_namespace }}"
      - "CR Status ............................. {{ db2_cr_resource.status.state | default('Unknown') }}"
      - "CR Ready .............................. {{ db2_cr_is_ready }}"

# Made with Bob
