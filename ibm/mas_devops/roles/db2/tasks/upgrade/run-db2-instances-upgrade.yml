# Db2 Instance Upgrade Tasks
# =============================================================================
# This file handles the upgrade of Db2 instances based on the instanceKind parameter.
# Supports both Db2uCluster (deprecated) and Db2uInstance (current).
# =============================================================================

# 1. Get the list of all Db2u instances
# -----------------------------------------------------------------------------
- name: "Get {{ instanceKind }} instances list"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    kind: "{{ instanceKind }}"
    namespace: "{{ db2_namespace }}"
  register: db2_instance_list

- name: "Debug list of {{ instanceKind }} instances"
  debug:
    msg:
      - "Instance Kind ............................ {{ instanceKind }}"
      - "Db2u Instance Names ...................... {{ db2_instance_list.resources | map(attribute='metadata.name') | list }}"
      - "Db2u Instance Namespace .................. {{ db2_namespace }}"
      - "Db2u Instance Versions ................... {{ db2_instance_list.resources | map(attribute='spec.version') | list }}"
      - "Number of Instances ...................... {{ db2_instance_list.resources | length }}"

- name: "Skip upgrade if no {{ instanceKind }} instances found"
  when: db2_instance_list.resources | length == 0
  debug:
    msg: "No {{ instanceKind }} instances found in namespace {{ db2_namespace }}. Skipping upgrade."

- name: "Get and set variables to store the lists"
  when: db2_instance_list.resources | length > 0
  set_fact:
    db2Instance_names: "{{ db2_instance_list.resources | map(attribute='metadata.name') | list }}"
    db2Instance_versions: "{{ db2_instance_list.resources | map(attribute='spec.version') | list }}"

# 2. Determine if upgrade is needed and perform it
# -----------------------------------------------------------------------------
# if db2_version is not set, then we define it based on the latest version supported by the db2u-license-keys secret
# Starting with s11.5.8.0-cn3, the 's' prefix is removed in db2u-license-keys, we are recommeded to use db2u-release configmap.
- block:
    - name: "Wait until the db2u-release configmap is available"
      no_log: true
      kubernetes.core.k8s_info:
        api_version: v1
        name: db2u-release
        namespace: "{{ db2_namespace }}"
        kind: ConfigMap
      register: db2_release_info
      retries: 20 # ~approx 10 minutes before we give up waiting for the CRD to be created
      delay: 30 # seconds
      until:
        - db2_release_info.resources is defined
        - db2_release_info.resources | length > 0
        - db2_release_info.resources[0].data is defined
        - db2_release_info.resources[0].data | length > 0

    - name: Set db2u-release configmap content
      no_log: true
      set_fact:
        db2_releases_content: "{{ db2_release_info.resources[0].data.json | from_json }}"

    - name: Filter out s12* versions and pick latest s11*
      set_fact:
        db2_version: >-
          {{
            (db2_releases_content.databases.db2u.keys()
            | select('match', '^s11')
            | sort)
            | last
          }}

  when: db2_version is not defined or db2_version == ""

- name: Debug target DB2 channel and engine version
  when: db2_instance_list.resources | length > 0
  ansible.builtin.debug:
    msg:
      - "Instance Kind .......................... {{ instanceKind }}"
      - "Current Db2 Channel .................... {{ old_db2_channel }}"
      - "Target Db2 Channel ..................... {{ db2_channel }}"
      - "Target Db2 Engine Version .............. {{ db2_version }}"
      - "Target Db2 instance namespace .......... {{ db2_namespace }}"

# 3. Check which instances need upgrade
# -----------------------------------------------------------------------------
- name: "Check if {{ instanceKind }} instance is at version {{ db2_version }}"
  when:
    - db2_instance_list.resources | length > 0
    - item.1 != db2_version
  debug:
    msg: "Upgrade required for {{ instanceKind }} {{ item.0 }} in namespace {{ db2_namespace }}. DB2 version {{ item.1 }} to {{ db2_version }}"
  loop: "{{ db2Instance_names | zip(db2Instance_versions) | list }}"

# 4. Perform the upgrade
# -----------------------------------------------------------------------------
- name: "Update {{ instanceKind }} version when required"
  when:
    - db2_instance_list.resources | length > 0
    - item.1 != db2_version
  kubernetes.core.k8s_json_patch:
    api_version: db2u.databases.ibm.com/v1
    name: "{{ item.0 }}"
    namespace: "{{ db2_namespace }}"
    kind: "{{ instanceKind }}"
    patch:
      - op: replace
        path: /spec/version
        value: "{{ db2_version }}"
  loop: "{{ db2Instance_names | zip(db2Instance_versions) | list }}"

# 5. Wait for upgrade to complete
# -----------------------------------------------------------------------------
- name: "Wait for {{ instanceKind }} instance to be ready (1m delay)"
  when:
    - db2_instance_list.resources | length > 0
    - item.1 != db2_version
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    name: "{{ item.0 }}"
    namespace: "{{ db2_namespace }}"
    kind: "{{ instanceKind }}"
  register: db2_instance_lookup
  until:
    - db2_instance_lookup.resources is defined
    - db2_instance_lookup.resources | length > 0
    - db2_instance_lookup.resources[0].status is defined
    - db2_instance_lookup.resources[0].status.state is defined
    - db2_instance_lookup.resources[0].status.state == "Ready"
    - db2_instance_lookup.resources[0].status.version == db2_version
  retries: 30 # Approximately 30 minutes before we give up
  delay: 60 # 1 minute
  loop: "{{ db2Instance_names | zip(db2Instance_versions) | list }}"
