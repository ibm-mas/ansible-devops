---
- name: "Assert required properties are not empty"
  assert:
    that:
      - db2_instance_name is defined and db2_instance_name != ""
      - db2_namespace is defined and db2_namespace != ""
      - db2_instance_password is defined and db2_instance_password != ""

- name: "Patch secret with Db2 instance password"
  no_log: true
  shell: |
    oc patch -n {{ db2_namespace }} $(oc get -n {{ db2_namespace }} secret c-{{ db2_instance_name }}-instancepassword -oname) -p "{\"data\":{\"password\": \"$(echo -n {{ db2_instance_password }} | base64)\"}}"
  register: secret_patch_output

- name: "Restart Db2 engine pods"
  shell: |
    oc delete -n {{ db2_namespace }} $(oc get po -n {{ db2_namespace }} -o name | grep -E "{{ db2_instance_name }}-db2u-[0-9]")
  register: pod_delete_output

- name: "Wait for Db2 Stateful set to be ready"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    name: "c-{{ db2_instance_name | lower }}-db2u"
    namespace: "{{ db2_namespace }}"
  register: db2_sts
  until:
    - db2_sts.resources is defined
    - db2_sts.resources | length > 0
    - db2_sts.resources[0].status is defined
    - db2_sts.resources[0].status.replicas is defined
    - db2_sts.resources[0].status.readyReplicas is defined
    - db2_sts.resources[0].status.readyReplicas == db2_sts.resources[0].status.replicas
  retries: 20 # approx 10 minutes before we give up
  delay: 30 # seconds

