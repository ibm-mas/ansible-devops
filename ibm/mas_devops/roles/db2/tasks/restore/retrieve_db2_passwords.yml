---
# Retrieving instance password from secret to restore via Db2uCluster CR
- name: "Check instance password secret is present in /secrets/ dir"
  no_log: true
  stat:
    path: "{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-instancepassword.yaml"
  register: instancepassword_stat

- name: Read YAML file and get password value
  no_log: true
  set_fact:
    _db2_instance_password: "{{ lookup('file', '{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-instancepassword.yaml') | from_yaml | json_query('data.password') | b64decode }}"
  when: instancepassword_stat.stat.exists

# Retrieving ldapblueadminpassword from secrets to restore via Db2uCluster CR
- name: "Check ldapblueadminpassword password secret is present in /secrets/ dir"
  no_log: true
  stat:
    path: "{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-ldapblueadminpassword.yaml"
  register: ldapblueadminpassword_stat

- name: Read YAML file and get password value
  no_log: true
  set_fact:
    _db2_ldapblueadmin_password: "{{ lookup('file', '{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-ldapblueadminpassword.yaml') | from_yaml | json_query('data.password') | b64decode }}"
  when: ldapblueadminpassword_stat.stat.exists


# Retrieving ldappassword from secrets to restore via Db2uCluster CR
- name: "Check ldappassword password secret is present in /secrets/ dir"
  no_log: true
  stat:
    path: "{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-ldappassword.yaml"
  register: ldappassword_stat

- name: Read YAML file and get password value
  no_log: true
  set_fact:
    _db2_ldappassword: "{{ lookup('file', '{{ db2_resources_path }}/secrets/c-{{ db2_instance_name }}-ldappassword.yaml') | from_yaml | json_query('data.password') | b64decode }}"
  when: ldappassword_stat.stat.exists

# Retrieving jdbc username/password from secrets to restore via Db2uCluster CR
- name: "Check jdbc-{{ db2_instance_name }}-credentials password secret is present in /secrets/ dir"
  no_log: true
  stat:
    path: "{{ db2_resources_path }}/secrets/jdbc-{{ db2_instance_name }}-credentials.yaml"
  register: jdbcsecret_stat

- name: Read YAML file and get username value
  no_log: true
  set_fact:
    _jdbc_username: "{{ lookup('file', '{{ db2_resources_path }}/secrets/jdbc-{{ db2_instance_name }}-credentials.yaml') | from_yaml | json_query('data.username') | b64decode }}"
  when: jdbcsecret_stat.stat.exists

- name: Read YAML file and get password value
  no_log: true
  set_fact:
    db2_ldap_username: "{{ _jdbc_username}}"
    db2_ldap_password: "{{ lookup('file', '{{ db2_resources_path }}/secrets/jdbc-{{ db2_instance_name }}-credentials.yaml') | from_yaml | json_query('data.password') | b64decode }}"
  when:
    - _jdbc_username is defined and _jdbc_username != ""
    - _jdbc_username != "db2inst1"
    - jdbcsecret_stat.stat.exists



