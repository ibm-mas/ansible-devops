---
# Check db2 Restore required variables
# -----------------------------------------------------------------------------
- name: Verify DB2 restore variables
  ibm.mas_devops.verify_backup_restore_vars:
    component: "db2"
    action: "restore_instance"
    db2_backup_version: "{{ db2_backup_version }}"
    mas_backup_dir: "{{ mas_backup_dir }}"

# Set backup path facts
- name: "Set fact: backup dir paths"
  set_fact:
    db2_backup_path: "{{ mas_backup_dir }}/backup-{{ db2_backup_version }}-db2u"
    db2_resources_path: "{{ mas_backup_dir }}/backup-{{ db2_backup_version }}-db2u/resources"

- name: "Check Db2u resource path exist"
  stat:
    path: "{{ db2_resources_path }}"
  register: resources_backup_path_stat

- name: "Fail if backup archive does not exist"
  fail:
    msg: "Db2 backup resources archive not found at: {{ db2_resources_path }}"
  when: not resources_backup_path_stat.stat.exists or not resources_backup_path_stat.stat.isdir

# Verify cert-manager exists
# -----------------------------------------------------------------------------
- name: Detect Certificate Manager installation
  include_tasks: "{{ role_path }}/../../common_tasks/detect_cert_manager.yml"

# Verify only one db2ucluster instance file is present in backup archive
# -----------------------------------------------------------------------------
- name: Get files from {{ db2_resources_path }}/db2uclusters directory
  set_fact:
    instance_files: "{{ lookup('fileglob', '{{ db2_resources_path }}/db2uclusters/*', wantlist=True) }}"

- name: Assert exactly one Db2uCluster CR exists
  assert:
    that:
      - instance_files | length == 1
    fail_msg: "Db2uCluster Directory must contain exactly one file"

- name: Set fact db2ucluster cr
  set_fact:
    db2ucluster_cr_cfg: "{{ lookup('file', '{{ instance_files[0] }}') | from_yaml }}"

# Get Db2u details from backup CR
# -----------------------------------------------------------------------------
- name: Set fact db2u namespace and instance name from backup CR
  set_fact:
    db2_namespace: "{{ db2ucluster_cr_cfg.metadata.namespace }}"
    db2_instance_name: "{{ db2ucluster_cr_cfg.metadata.name }}"
    db2_version: "{{ db2ucluster_cr_cfg.spec.version }}"
    db2_dbname: "{{ db2ucluster_cr_cfg.spec.environment.database.name }}"
    db2_type: "{{ db2ucluster_cr_cfg.spec.environment.dbType }}"

- name: "Db2uCluster restore information"
  debug:
    msg:
      - "Db2u Namespace ................. {{ db2_namespace }}"
      - "Db2u Instance Name ............. {{ db2_instance_name }}"
      - "Db2u version ................... {{ db2_version }}"
      - "Db2u Database Name ............. {{ db2_dbname }}"
      - "Db2u Database Type ............. {{ db2_type }}"
      - "MAS Instance ID ................ {{ mas_instance_id | default('undefined') }}"
      - "Backup Version ................. {{ db2_backup_version }}"
      - "Backup Path .................... {{ db2_backup_path }}"

# 1. Restore Namespace
# -----------------------------------------------------------------------------
- name: Restore namespace
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Project
    replace_resource: false
  register: namespace_result

# 2. Restore Secrets & configmaps
# -----------------------------------------------------------------------------
- name: Restore Secrets and configmaps
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Secret
      - ConfigMap
    replace_resource: false
  register: secrets_configmaps_result
  when:
    - namespace_result.success


# 3. Restore Operatorgroups
# -----------------------------------------------------------------------------
- name: Restore Operatorgroups
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - OperatorGroup
    replace_resource: false
  register: operatorgroups_result
  when:
    - namespace_result.success
    - secrets_configmaps_result is defined and secrets_configmaps_result.success

# 4. Restore Subscription
# -----------------------------------------------------------------------------
- name: Restore Subscriptions
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Subscription
    replace_resource: false
  register: subscriptions_result
  when:
    - namespace_result.success
    - operatorgroups_result is defined and operatorgroups_result.success

# 5. Restore Certs and Issuers
# -----------------------------------------------------------------------------
- name: "Restore Certificate Manager resources"
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Issuer
      - Certificate
  register: certmanager_result
  when:
    - namespace_result.success
    - subscriptions_result is defined and subscriptions_result.success

# 6. Wait until the Db2uCluster CRD is available
# -----------------------------------------------------------------------------
- name: "Wait until the Db2uCluster CRD is available"
  include_tasks: "{{ role_path }}/../../common_tasks/wait_for_crd.yml"
  vars:
    crd_name: "db2uclusters.db2u.databases.ibm.com"

# 7. Restore Db2uCluster
# -----------------------------------------------------------------------------

- name: "Retrieve db2 passwords from secrets to restore via Db2uCluster CR"
  include_tasks: "tasks/restore/retrieve_db2_passwords.yml"
  no_log: true

- name: "Restore Db2uCluster resources"
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Db2uCluster
    override_values:
      Db2uCluster: >-
        {{
          [
            {
              'spec.environment.database.ssl.secretName':
                'db2u-certificate-' ~ db2_instance_name
            }
          ]
          + (
              [
                {
                  'spec.environment.ldap.password':
                    db2_ldap_password
                }
              ]
              if db2_ldap_password is defined and db2_ldap_password | length > 0
              else []
            )
          + (
              [
                {
                  'spec.environment.ldap.blueAdminPassword':
                    db2_ldapblueadmin_password
                }
              ]
              if db2_ldapblueadmin_password is defined and db2_ldapblueadmin_password | length > 0
              else []
            )
          + (
              [
                {
                  'spec.environment.instance.password':
                    db2_instance_password
                }
              ]
              if db2_instance_password is defined and db2_instance_password | length > 0
              else []
            )
        }}
  register: cr_result
  when:
    - namespace_result.success

# 8. Set timezone
# -----------------------------------------------------------------------------

- name: "Determine if timezone is set in the CR"
  set_fact:
    db2_timezone: "{{ db2ucluster_cr_cfg.spec.advOpts.timezone | default('') }}"

- name: "Set db2 instance timezone"
  include_tasks: "tasks/install/setup_timezone.yml"
  when:
    - db2_timezone is defined
    - db2_timezone != ""

# 9. Wait for the cluster to be ready
# -----------------------------------------------------------------------------
- name: "Wait for db2u instance to be ready (5m delay)"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    name: "{{ db2_instance_name | lower }}"
    namespace: "{{db2_namespace}}"
    kind: Db2uCluster
  register: db2_cluster_lookup
  until:
    - db2_cluster_lookup.resources is defined
    - db2_cluster_lookup.resources | length == 1
    - db2_cluster_lookup.resources[0].status is defined
    - db2_cluster_lookup.resources[0].status.state is defined
    - db2_cluster_lookup.resources[0].status.state == "Ready"
  retries: 24 # Approximately 2 hours before we give up
  delay: 300 # 5 minutes
  when:
    - namespace_result.success
    - cr_result.success
  no_log: true # no_log because spits out big json object

# 10. Restore route
- name: "Get cluster subdomain"
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: Ingress
    name: cluster
  register: _cluster_subdomain
  no_log: true # no_log because spits out big json object

# Apply cluster domain in tls route
- name: "Restore routes"
  ibm.mas_devops.restore_resource:
    backup_path: "{{ db2_backup_path }}"
    resource_kinds:
      - Route
    override_values:
      Route:
        - spec.host: "{{db2_instance_name | lower }}-{{db2_namespace}}.{{_cluster_subdomain.resources[0].spec.domain}}"
  register: routes_result
  when:
    - namespace_result.success
    - subscriptions_result is defined and subscriptions_result.success

# TODO 11. Restore LDAP user


# 12. Wait for the statefulset to be ready
# -----------------------------------------------------------------------------
- name: "Wait for Db2 Stateful set to be ready"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    name: "c-{{ db2_instance_name | lower }}-db2u"
    namespace: "{{ db2_namespace }}"
  register: db2_sts
  until:
    - db2_sts.resources is defined
    - db2_sts.resources | length > 0
    - db2_sts.resources[0].status is defined
    - db2_sts.resources[0].status.replicas is defined
    - db2_sts.resources[0].status.readyReplicas is defined
    - db2_sts.resources[0].status.readyReplicas == db2_sts.resources[0].status.replicas
  retries: 20 # approx 10 minutes before we give up
  delay: 30 # seconds
  no_log: true # no_log because spits out big json object
