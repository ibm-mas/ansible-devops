---
- name: "Set fact: DB2 universal operator backup resources"
  set_fact:
    db2_backup_resources:
      - namespace: "{{ db2_namespace }}"
        resources:
          # db2u.databases.ibm.com
          - kind: Db2uCluster
            api_version: db2u.databases.ibm.com/v1
            name: "{{ db2_instance_name }}"
          # support for db2uinstance migration
          - kind: Db2uInstance
            api_version: db2u.databases.ibm.com/v1
            name: "{{ db2_instance_name }}"
          # subscription
          - kind: Subscription
            api_version: operators.coreos.com/v1alpha1
            name: db2u-operator
          # operatorgroup
          - kind: OperatorGroup
            api_version: operators.coreos.com/v1
          # secrets
          - kind: Secret
            api_version: v1
            name: ibm-registry
          - kind: Secret
            api_version: v1
            name: "c-{{ db2_instance_name }}-instancepassword"
          # Issuers
          - kind: Issuer
            api_version: cert-manager.io/v1
            name: db2u-issuer
          - kind: Issuer
            api_version: cert-manager.io/v1
            name: db2u-ca-issuer
          # Certificates
          - kind: Certificate
            api_version: cert-manager.io/v1
            name: "db2u-certificate-{{ db2_instance_name }}"
          - kind: Certificate
            api_version: cert-manager.io/v1
            name: db2u-ca-certificate
      - namespace: "mas-{{ mas_instance_id }}-core"
        resources:
          # secrets
          - kind: Secret
            api_version: v1
            name: "jdbc-{{ db2_instance_name }}-credentials"

# Call the backup_resources plugin to execute the backup to the path provided
# -----------------------------------------------------------------------------
- name: "Backup DB2 resources (referenced secrets are auto-discovered)"
  ibm.mas_devops.backup_resource:
    backup_resources: "{{ db2_backup_resources }}"
    backup_path: "{{ db2_backup_path }}"
  register: backup_result

# Show the results
# -----------------------------------------------------------------------------
- name: "Display backup results"
  debug:
    msg:
      - "Backup completed{{ ' with failures' if backup_result.failed_count > 0 else ' successfully' }}"
      - "Total resources backed up: {{ backup_result.backed_up_count }}"
      - "Total resources failed: {{ backup_result.failed_count }}"
      - "Resources not found: {{ backup_result.not_found_count }}"
      - "Secrets auto-discovered: {{ backup_result.discovered_secrets_count }}"
      - "Backup location: {{ db2_backup_path }}"

# Fail task if any errors occurred.
# -----------------------------------------------------------------------------
- name: "Display failed resources"
  debug:
    msg:
      - "Failed resources:"
      - "{{ backup_result.failed_resources | to_nice_yaml }}"
  when: backup_result.failed_count > 0

- name: "Fail if backup had errors"
  fail:
    msg: |
      Backup failed for {{ backup_result.failed_count }} resource(s):
      {% for resource in backup_result.failed_resources %}
      - {{ resource.description }} in {{ resource.scope }}
      {% endfor %}
  when: backup_result.failed_count > 0


