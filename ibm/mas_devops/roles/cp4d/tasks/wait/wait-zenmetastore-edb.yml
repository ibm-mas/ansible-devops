---
# 1. Wait for zen metastore cluster to start
# -----------------------------------------------------------------------------
- name: "wait-zenmetastore-edb : Wait for Zen Metastore EDB Cluster to be created"
  kubernetes.core.k8s_info:
    api_version: postgresql.k8s.enterprisedb.io/v1
    kind: Cluster
    namespace: "{{ cpd_instance_namespace }}"
    name: "zen-metastore-edb"
  register: zenmetastoreCluster
  retries: 120 # Give 60 minutes for the zenService to start Zen Metastore Pods (Logs show this taking ~20 minutes in a good run)
  delay: 30
  until: zenmetastoreCluster.resources[0].status is defined

# 2. Wait for zen metastore replica pods to become ready
# -----------------------------------------------------------------------------
- name: "wait-zenmetastore-edb : Wait for ZenMetastore pods to be become ready"
  kubernetes.core.k8s_info:
    api_version: postgresql.k8s.enterprisedb.io/v1
    kind: Cluster
    namespace: "{{ cpd_instance_namespace }}"
    name: "zen-metastore-edb"
  register: zenmetastoreCluster
  retries: 40 # Give 20 minutes for the pods to become ready
  delay: 30
  until: >-
    zenmetastoreCluster.resources[0].spec.instances is defined
    and zenmetastoreCluster.resources[0].status.readyInstances is defined
    and zenmetastoreCluster.resources[0].spec.instances == zenmetastoreCluster.resources[0].status.readyInstances

# 3. Wait for common-service since OperandRegistry/Config get created after Zen MetastoreEDB stage
# -----------------------------------------------------------------------------
- name: "Wait for CommonService instance to be ready in {{ cpd_operators_namespace }}"
  kubernetes.core.k8s_info:
    api_version: operator.ibm.com/v3
    name: common-service
    namespace: "{{ cpd_operators_namespace }}"
    kind: CommonService
  register: commonservices_operators_output
  until:
    - commonservices_operators_output.resources is defined
    - commonservices_operators_output.resources | length > 0
    - commonservices_operators_output.resources[0].status.overallStatus is defined
    - commonservices_operators_output.resources[0].status.overallStatus == "Succeeded"
    - commonservices_operators_output.resources[0].status.phase is defined
    - commonservices_operators_output.resources[0].status.phase == "Succeeded"
  retries: 60 # approx 30 minutes
  delay: 30 # seconds
