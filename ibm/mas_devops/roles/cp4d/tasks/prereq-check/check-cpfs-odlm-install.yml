---
# 2. Check whether IBM Common Services are already installed
# -----------------------------------------------------------------------------
- name: "prereq-check : Check if ibm-common-services-operator is installed"
  k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    name: ibm-common-service-operator
    namespace: ibm-common-services
  register: common_services_sub_info

- name: "prereq-check : Check if ODLM is installed"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    name: operand-deployment-lifecycle-manager
    namespace: "ibm-common-services"
    kind: Deployment
  register: odlm_lookup

- name: "prereq-check : Assert that IBM Cloud Pak Foundational Services is installed"
  assert:
    that:
      - common_services_sub_info.resources is defined
      - common_services_sub_info.resources | length > 0
      - common_services_sub_info.resources[0].status is defined
      - common_services_sub_info.resources[0].status.installedCSV is defined
    fail_msg: "Failed! IBM Cloud Pak Foundation Services must be installed before installing CloudPak for Data v{{ cpd_product_version }}. Run 'common_services' role to install it."

- set_fact:
    cpfs_installed_version: "{{ common_services_sub_info.resources[0].status.installedCSV | regex_search(regex) }}"
  vars:
    regex: '(?<=ibm-common-service-operator.v)(.*)'

- name: "prereq-check : Assert that ODLM is installed"
  assert:
    that:
      - odlm_lookup.resources is defined
      - odlm_lookup.resources | length >= 0
      - odlm_lookup.resources[0].status.availableReplicas is defined
    fail_msg: "Failed! Operand Deployment Lifecycle Manager must be installed before installing CloudPak for Data vv{{ cpd_product_version }}. Run 'common_services' role to install it."
