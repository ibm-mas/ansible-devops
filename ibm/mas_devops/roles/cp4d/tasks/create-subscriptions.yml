---
# 2. Create Operator Subscriptions
# -----------------------------------------------------------------------------
# 2.2 Install the IBM Cloud Pak for Data platform operator
#
# This will result in two operators being installed into the cpd operator namespace:
# - cpd-platform-operator-manager
# - ibm-common-service-operator
# - ibm-namespace-scope-operator

- debug:
    msg:
      - "Cloud Pak For Data channel ................ {{ cpd_channel }}"
      - "Catalog source name ....................... {{ cpd_catalog_source_name }}"
      - "Catalog source namespace .................. {{ cpd_catalog_source_namespace }}"

# TODO : For now, we'll need to install CPD 4.8 subscription using cpd-platform catalog source until they're all into ibm-operator-catalog
- name: "create-subscriptions : Create CP4D Platform & Namespace Scope Operator subscriptions using channel: {{ cpd_channel }}"
  vars:
    catalog_source_name: "{{ (cpd_minor_version is version('4.6','<=')) | ternary('ibm-operator-catalog', 'cpd-platform') }}"
    catalog_source_namespace: "{{ (cpd_minor_version is version('4.6','<=')) | ternary('openshift-marketplace', cpd_operators_namespace) }}"
  kubernetes.core.k8s:
    apply: yes
    template: 'templates/cpd_platform/subscription.yml.j2'

- name: "create-subscriptions : Wait for cpd-platform-operator-manager to be ready (60s delay)"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    name: cpd-platform-operator-manager
    namespace: "{{ cpd_operators_namespace }}"
    kind: Deployment
  register: cpd_subscription
  until: cpd_subscription.resources[0].status.availableReplicas is defined
  retries: 10 # Approximately 10 minutes before we give up
  delay: 60 # 1 minute

# This is just a validation step to prevent the "wait tasks" to run before it gives enough time for the new cpd service operator version
# to start reconciling in case of an upgrade, otherwise it might not have given enough time for it to process the new version to be upgrade
# while its status' cr might still show 'completed'.
# With this, we ensure the new cpd service csv version operator is up and running with the new cr version before we check the cpd cr status
- name: "Wait CP4D subscription installedCSV version at {{ expected_installed_csv }}"
  vars:
    expected_installed_csv: "cpd-platform-operator.v{{ cpd_csv_version }}"
  kubernetes.core.k8s_info:
    api_version: operators.coreos.com/v1alpha1
    kind: Subscription
    namespace: "{{ cpd_operators_namespace }}"
    name: "cpd-operator"
  register: cpd_sub_info
  retries: 20
  delay: 60 # Retry for approx 20 minutes (60s * 20 attempts) before giving up
  until:
    - cpd_sub_info.resources is defined
    - cpd_sub_info.resources | length > 0
    - cpd_sub_info.resources[0].status is defined
    - cpd_sub_info.resources[0].status.installedCSV is defined
    - cpd_sub_info.resources[0].status.installedCSV == expected_installed_csv

# TODO: Delete this if tests passes, NamespaceScope will be installed earlier
# # 2.3 Enabling services to use namespace scoping with third-party operators
# - name: "create-subscriptions : Create NamespaceScope for CP4D Operators"
#   kubernetes.core.k8s:
#     apply: yes
#     template: 'templates/namespaceScope.yml.j2'
