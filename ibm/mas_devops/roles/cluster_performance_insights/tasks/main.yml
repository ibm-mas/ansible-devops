---

# 1. Check required properties
# -----------------------------------------------------------------------------
- assert:
    that:
      - cpi_namespace is defined and cpi_namespace != ""


# 2. Create CPI namespace
# -----------------------------------------------------------------------------
- name: "Create CPI namespace"
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: '{{ cpi_namespace }}'

# 3. Create CPI Service Account
# -----------------------------------------------------------------------------
- name: Create CPI service account
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-serviceaccount.yml.j2

# 3. Create CPI ClusterRoleBinding
# -----------------------------------------------------------------------------
- name: Create CPI ClusterRoleBinding
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-clusterrolebinding.yml.j2

# 3. Create CPI SecurityContextConstraints
# -----------------------------------------------------------------------------
- name: Create CPI SecurityContextConstraints
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-securitycontextconstraints.yml.j2

# 3. Create CPI Deployment
# -----------------------------------------------------------------------------
- name: Create CPI Deployment
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-deployment.yml.j2

# 3. Create CPI Service
# -----------------------------------------------------------------------------
- name: Create CPI Service
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-service.yml.j2

# 3. Create CPI Route
# -----------------------------------------------------------------------------
- name: Create CPI Route
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-route.yml.j2

# 3. Create CPI Log Service
# -----------------------------------------------------------------------------
- name: Create CPI Log Service
  no_log: true
  kubernetes.core.k8s:
    state: present
    namespace: "{{ kubeturbo_namespace }}"
    template: templates/cpi-logservice.yml.j2














