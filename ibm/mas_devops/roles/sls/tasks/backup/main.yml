---
- name: "Fail if require variables for SLS backup are not provided"
  ibm.mas_devops.verify_backup_restore_vars:
    mas_backup_dir: "{{ mas_backup_dir }}"
    sls_namespace: "{{ sls_namespace }}"
    sls_instance_name: "{{ sls_instance_name }}"
    action: "backup"
    component: "sls"

- name: "Check if SLS_BACKUP_VERSION is provided, if not set to default 'YYMMDD-HHMMSS' format"
  set_fact:
    sls_backup_version: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
  when: sls_backup_version is not defined or sls_backup_version == "" or sls_backup_version == "None"

- name: "Set fact: SLS backup base directory path"
  set_fact:
    sls_backup_path: "{{ mas_backup_dir }}/backup-{{ sls_backup_version }}-sls"

- name: "Set fact: SLS backup resources"
  set_fact:
    sls_backup_resources:
      - namespace: "{{ sls_namespace }}"
        resources:
          # project
          - kind: Project
            api_version: project.openshift.io/v1
            name: "{{ sls_namespace }}"
          # secret
          - kind: Secret
            api_version: v1
            name: ibm-entitlement
          - kind: Secret
            api_version: v1
            name: ibm-sls-mongo-credentials
          - kind: Secret
            api_version: v1
            name: "{{ sls_instance_name }}-bootstrap"
          - kind: Secret
            api_version: v1
            name: "ibm-sls-{{ sls_instance_name }}-entitlement"
          # configmap
          - kind: ConfigMap
            api_version: v1
            name: "{{ sls_instance_name }}-suite-registration"
          # subscription
          - kind: Subscription
            api_version: operators.coreos.com/v1alpha1
            name: ibm-sls
          # operator group
          - kind: OperatorGroup
            api_version: operators.coreos.com/v1
            name: operatorgroup
          # Licenseservice CR
          - kind: LicenseService
            api_version: sls.ibm.com/v1
            name: "{{ sls_instance_name }}"
          # Issuers
          - kind: Issuer
            api_version: cert-manager.io/v1
            name: "{{ sls_instance_name }}-issuer"
          - kind: Issuer
            api_version: cert-manager.io/v1
            name: "{{ sls_instance_name }}-ca-issuer"
          # Certificates
          - kind: Certificate
            api_version: cert-manager.io/v1
            name: "{{ sls_instance_name }}-cert-ca"

# Call the backup_resources plugin to execute the backup to the path provided
# -----------------------------------------------------------------------------
- name: "Backup sls resources (referenced secrets are auto-discovered)"
  ibm.mas_devops.backup_resource:
    backup_resources: "{{ sls_backup_resources }}"
    backup_path: "{{ sls_backup_path }}"
  register: backup_result

# Show the results
# -----------------------------------------------------------------------------
- name: "Display backup results"
  debug:
    msg:
      - "Backup completed{{ ' with failures' if backup_result.failed_count > 0 else ' successfully' }}"
      - "Total resources backed up: {{ backup_result.backed_up_count }}"
      - "Total resources failed: {{ backup_result.failed_count }}"
      - "Resources not found: {{ backup_result.not_found_count }}"
      - "Secrets auto-discovered: {{ backup_result.discovered_secrets_count }}"
      - "Backup location: {{ sls_backup_path }}"

# Fail task if any errors occurred.
# -----------------------------------------------------------------------------
- name: "Display failed resources"
  debug:
    msg:
      - "Failed resources:"
      - "{{ backup_result.failed_resources | to_nice_yaml }}"
  when: backup_result.failed_count > 0

- name: "Fail if backup had errors"
  fail:
    msg: |
      Backup failed for {{ backup_result.failed_count }} resource(s):
      {% for resource in backup_result.failed_resources %}
      - {{ resource.description }} in {{ resource.scope }}
      {% endfor %}
  when: backup_result.failed_count > 0

- name: "Store SLS registration details"
  ibm.mas_devops.save_sls_registration_info:
    namespace: "{{ sls_namespace }}"
    name: "{{ sls_instance_name }}"
    sls_backup_path: "{{ sls_backup_path }}"
  register: sls_registration_result

- name: "Fail if storing SLS registration details has failed."
  fail:
    msg: "{{ sls_registration_result.msg }}"
  when: sls_registration_result.failed
