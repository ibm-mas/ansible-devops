---
# Configure Manage report bundle servers
# -----------------------------------------------------------------------------
- name: Check if report bundle is already configured
  when:
    - managews_output.resources[0].spec.settings.deployment.serverBundles is defined
    - managews_output.resources[0].spec.settings.deployment.serverBundles | selectattr('bundleType', 'equalto', 'report')| map(attribute='name') | list | length > 0
  set_fact:
    existing_manage_report_name: "{{ managews_output.resources[0].spec.settings.deployment.serverBundles | selectattr('bundleType', 'equalto', 'report')| map(attribute='name') | list | first }}"

- debug:
    var: existing_manage_report_name

- name: "Get Suite Instance Domain"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Suite
    name: "{{ mas_instance_id }}"
    namespace: "mas-{{mas_instance_id}}-core"
  register: suite_instance

- name: "Assert Suite instance exists and domain is valid"
  assert:
    that:
      - suite_instance.resources is defined
      - suite_instance.resources | length > 0
      - suite_instance.resources[0].spec.domain != ''

# When report bundle exists, we'll use existing report name to define the manage report route.
# When report bundle does not exist, then we'll use the 'manage_report_bundle_server_name' property to define its name.
- name: "Configure Manage report route"
  set_fact:
    manage_report_route: "https://{{ mas_workspace_id}}-{{ existing_manage_report_name | default(manage_report_bundle_server_name, true) }}.manage.{{ suite_instance.resources[0].spec.domain }}"

- debug:
    var: manage_report_route

- name: Set Manage bundle server properties
  set_fact:
    birtServerBundles: "{{ managews_output.resources[0].spec.settings.deployment.serverBundles | default([]) | ibm.mas_devops.setManageBirtProperties(manage_report_route, existing_manage_report_name | default(manage_report_bundle_server_name, true) )}}"

- debug:
    var: birtServerBundles

# Configure Server bundle properties into Manage Workspace
# -----------------------------------------------------------------------------
- name: "Add the Server Bundle birt properties in ManageWorkspace CR"
  kubernetes.core.k8s:
    definition:
      apiVersion: apps.mas.ibm.com/v1
      kind: ManageWorkspace
      metadata:
        name: "{{ manage_workspace_cr_name }}"
        namespace: "mas-{{ mas_instance_id }}-manage"
      spec:
        settings:
          deployment:
            serverBundles: |
              {{ birtServerBundles }}
  register: managews_sb_output

- name: "Debug information"
  debug:
    msg:
      - "ManageWorkspace Changed ............... {{ managews_sb_output.changed }}"
