---
# Detect which Db2 CR type exists in the namespace
# This task supports both Db2uCluster (deprecated) and Db2uInstance (current)
#
# Usage:
# - name: "Detect Db2 CR type"
#   include_tasks: "{{ role_path }}/../../common_tasks/detect_db2_cr_type.yml"
#
# Required variables:
#   - db2_instance_name: Name of the Db2 instance
#   - db2_namespace: Namespace where Db2 is deployed
#
# Sets the following facts:
#   - db2_cr_type: Either 'Db2uCluster' or 'Db2uInstance'
#   - db2_cr_exists: Boolean indicating if a CR was found
#   - db2_cr_resource: The full CR resource object
#   - db2_cr_api_version: API version (db2u.databases.ibm.com/v1)

- name: "detect-db2-cr-type : Lookup Db2uCluster instance"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    kind: Db2uCluster
    name: "{{ db2_instance_name | lower }}"
    namespace: "{{ db2_namespace }}"
  register: _db2_cluster_lookup
  failed_when: false

- name: "detect-db2-cr-type : Lookup Db2uInstance instance"
  kubernetes.core.k8s_info:
    api_version: db2u.databases.ibm.com/v1
    kind: Db2uInstance
    name: "{{ db2_instance_name | lower }}"
    namespace: "{{ db2_namespace }}"
  register: _db2_instance_lookup
  failed_when: false

- name: "detect-db2-cr-type : Determine CR type and validate"
  set_fact:
    db2_cr_type: >-
      {%- if _db2_cluster_lookup.resources | default([]) | length > 0 and _db2_instance_lookup.resources | default([]) | length > 0 -%}
        both
      {%- elif _db2_cluster_lookup.resources | default([]) | length > 0 -%}
        Db2uCluster
      {%- elif _db2_instance_lookup.resources | default([]) | length > 0 -%}
        Db2uInstance
      {%- else -%}
        none
      {%- endif -%}
    db2_cr_exists: >-
      {{ (_db2_cluster_lookup.resources | default([]) | length > 0) or
         (_db2_instance_lookup.resources | default([]) | length > 0) }}

- name: "detect-db2-cr-type : Fail if both CR types exist"
  fail:
    msg: |
      ERROR: Both Db2uCluster and Db2uInstance resources exist for '{{ db2_instance_name }}'.
      This is an invalid state. Please ensure only one CR type exists.
      - Db2uCluster: {{ _db2_cluster_lookup.resources | length }} found
      - Db2uInstance: {{ _db2_instance_lookup.resources | length }} found

      To resolve this issue:
      1. Determine which CR type you want to keep (Db2uInstance is recommended)
      2. Delete the other CR type:
         oc delete db2ucluster {{ db2_instance_name | lower }} -n {{ db2_namespace }}
         OR
         oc delete db2uinstance {{ db2_instance_name | lower }} -n {{ db2_namespace }}
  when: db2_cr_type == "both"

- name: "detect-db2-cr-type : Fail if no CR exists"
  fail:
    msg: |
      ERROR: No Db2 instance found with name '{{ db2_instance_name }}' in namespace '{{ db2_namespace }}'.
      Expected either Db2uCluster or Db2uInstance resource to exist.

      To resolve this issue:
      1. Verify the instance name: oc get db2ucluster,db2uinstance -n {{ db2_namespace }}
      2. Check if the instance exists in a different namespace
      3. Ensure the Db2 instance has been created before running this role
  when: db2_cr_type == "none"

- name: "detect-db2-cr-type : Set CR-specific facts"
  set_fact:
    db2_cr_resource: >-
      {{ _db2_cluster_lookup.resources[0] if db2_cr_type == 'Db2uCluster' 
         else _db2_instance_lookup.resources[0] }}
    db2_cr_api_version: "db2u.databases.ibm.com/v1"

- name: "detect-db2-cr-type : Display detected CR type"
  debug:
    msg:
      - "Detected Db2 CR Type .................. {{ db2_cr_type }}"
      - "CR Name ............................... {{ db2_instance_name | lower }}"
      - "CR Namespace .......................... {{ db2_namespace }}"
      - "CR Status ............................. {{ db2_cr_resource.status.state | default('Unknown') }}"

# Made with Bob
