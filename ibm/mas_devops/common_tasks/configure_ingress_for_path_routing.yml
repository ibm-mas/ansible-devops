---
# Configure IngressController for Path-Based Routing
# -----------------------------------------------------------------------------
# This task configures the OpenShift IngressController to support path-based routing by setting namespaceOwnership to InterNamespaceAllowed.
# This is required when mas_routing_mode is set to "path".
#
# Parameters:
# mas_ingress_controller_name (optional): Specific IngressController name to use If not provided, defaults to 'default'

- name: "Determine which IngressController to configure"
  block:
    - name: "Check if IngressController name is explicitly provided"
      set_fact:
        active_ingress_controller: "{{ mas_ingress_controller_name }}"
      when:
        - mas_ingress_controller_name is defined
        - mas_ingress_controller_name | length > 0

    - name: "Use 'default' IngressController if not specified"
      set_fact:
        active_ingress_controller: "default"
      when: active_ingress_controller is not defined

    - name: "Display selected IngressController"
      debug:
        msg: "Using IngressController: {{ active_ingress_controller }}"

- name: "Get current IngressController configuration"
  kubernetes.core.k8s_info:
    api_version: operator.openshift.io/v1
    kind: IngressController
    name: "{{ active_ingress_controller }}"
    namespace: openshift-ingress-operator
  register: ingress_controller_info
  failed_when: false

- name: "Check current IngressController namespaceOwnership setting"
  set_fact:
    route_admission_policy: "{{ ingress_controller_info.resources[0].spec.routeAdmission.namespaceOwnership | default('') }}"
  when:
    - ingress_controller_info.resources is defined
    - ingress_controller_info.resources | length > 0

- name: "Display current route admission policy"
  debug:
    msg:
      - "IngressController ................. {{ active_ingress_controller }}"
      - "Current namespaceOwnership ........ {{ route_admission_policy | default('Not set') }}"

- name: "Configure IngressController for path-based routing"
  when:
    - route_admission_policy != "InterNamespaceAllowed"
  block:
    - name: "Patch IngressController to enable InterNamespaceAllowed"
      kubernetes.core.k8s:
        api_version: operator.openshift.io/v1
        kind: IngressController
        name: "{{ active_ingress_controller }}"
        namespace: openshift-ingress-operator
        state: present
        merge_type: merge
        definition:
          spec:
            routeAdmission:
              namespaceOwnership: InterNamespaceAllowed
      register: ingress_patch_result

    - name: "Display IngressController patch result"
      debug:
        msg:
          - "IngressController patched ......... {{ ingress_patch_result.changed }}"

    - name: "Wait for IngressController to reconcile"
      kubernetes.core.k8s_info:
        api_version: operator.openshift.io/v1
        kind: IngressController
        name: "{{ active_ingress_controller }}"
        namespace: openshift-ingress-operator
      register: ingress_verify
      until:
        - ingress_verify.resources is defined
        - ingress_verify.resources | length > 0
        - ingress_verify.resources[0].spec.routeAdmission.namespaceOwnership == "InterNamespaceAllowed"
      retries: 10
      delay: 5

  rescue:
    - name: "Failed to configure IngressController"
      fail:
        msg:
          - "Failed to configure IngressController '{{ active_ingress_controller }}' for path-based routing"
          - "Please configure it manually by running:"
          - ""
          - "  oc patch ingresscontroller {{ active_ingress_controller }} -n openshift-ingress-operator \\"
          - "    --type=merge \\"
          - "    --patch='{\"spec\":{\"routeAdmission\":{\"namespaceOwnership\":\"InterNamespaceAllowed\"}}}'"
          - ""
          - "Alternatively, you can use subdomain routing mode by setting:"
          - "  mas_routing_mode=subdomain"

- name: "IngressController already configured for path-based routing"
  debug:
    msg: "IngressController is already configured with namespaceOwnership: InterNamespaceAllowed - no changes needed"
  when:
    - route_admission_policy is defined
    - route_admission_policy == "InterNamespaceAllowed"
