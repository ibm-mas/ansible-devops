---
# Backup kubernetes Issuers resource
# -----------------------------------------------------------------------------

- name: "Get Kubernetes {{ item }} Issuer"
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Issuer
    name: "{{ item }}"
    namespace: "{{ namespace }}"
  register: issuer_data

- name: Construct new Issuer yaml with minimal metadata and spec
  set_fact:
    issuer_filtered:
      apiVersion: "{{ issuer_data.resources[0].apiVersion }}"
      kind: "{{ issuer_data.resources[0].kind }}"
      metadata:
        name: "{{ issuer_data.resources[0].metadata.name }}"
        namespace: "{{ issuer_data.resources[0].metadata.namespace }}"
      spec: "{{ issuer_data.resources[0].spec }}"
      when:
        - issuer_data is defined
        - issuer_data.resources[0] is defined

- name: "Save Issuer resource to file"
  copy:
    content: "{{ issuer_filtered | to_nice_yaml }}"
    dest: "{{ backup_issuers_path }}/{{ item }}.yaml"
  when:
    - backup_issuers_path is defined
    - issuer_filtered is defined
