---
# Backup kubernetes Deployments resource
# -----------------------------------------------------------------------------

- name: "Get Kubernetes {{ item }} Deployment"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: "{{ item }}"
    namespace: "{{ namespace }}"
  register: deployment_data

- name: Construct new Deployment yaml with minimal metadata and spec
  set_fact:
    deployment_filtered:
      apiVersion: "{{ deployment_data.resources[0].apiVersion }}"
      kind: "{{ deployment_data.resources[0].kind }}"
      metadata:
        name: "{{ deployment_data.resources[0].metadata.name }}"
        namespace: "{{ deployment_data.resources[0].metadata.namespace }}"
      spec: "{{ deployment_data.resources[0].spec }}"
      when:
        - deployment_data is defined
        - deployment_data.resources[0] is defined

- name: "Save Deployment resource to file"
  copy:
    content: "{{ deployment_filtered | to_nice_yaml }}"
    dest: "{{ backup_deployments_path }}/{{ item }}.yaml"
  when:
    - backup_deployments_path is defined
    - deployment_filtered is defined
