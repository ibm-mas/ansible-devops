---
# 1. Check if and where cert-manager is installed
# -----------------------------------------------------------------------------
# oc get pods -A | grep cert-manager-cainjector| awk '{print $1}' should return the namespace where the cert-manager instance is running i.e cert-manager-operator
- name: Lookup Certificate Manager installations
  shell: oc get pods -A | grep cert-manager-cainjector | awk '{print $1}'
  register: cert_manager_webhook_lookup

- name: Assert Certificate Manager is installed
  assert:
    that: cert_manager_webhook_lookup.stdout_lines | length > 0
    fail_msg: "Certificate Manager was not found in the cluster. Make sure you run 'cert_manager' role prior trying to install MAS"

- name: Assert there is just one Certificate Manager running
  assert:
    that: cert_manager_webhook_lookup.stdout_lines | length == 1
    fail_msg: 
      - "There are multiple instances of Certificate Manager running in the cluster."
      - "Make sure you just have one Certificate Manager instance running."
      - "Certificate Manager namespaces identified: {{ cert_manager_webhook_lookup.stdout_lines }}"

# 2. Check if Certificate Manager Cluster Resource Namespace is defined
# -----------------------------------------------------------------------------
- name: "Lookup CertManager CR"
  kubernetes.core.k8s_info:
    api_version: operator.openshift.io/v1alpha1
    name: cluster
    kind: CertManager
  register: certmanager_cr

- set_fact:
    cert_manager_args: "{{ certmanager_cr.resources[0].spec.unsupportedConfigOverrides.controller.args }}"
  when: certmanager_cr.resources[0].spec.unsupportedConfigOverrides.controller.args is defined

- name: Set cert_manager_cluster_resource_namespace from CertManager CR
  when: cert_manager_args is defined and item | regex_search(regex)
  vars:
    regex: '(?<=\--cluster-resource-namespace=).*'
  set_fact:
    cert_manager_cluster_resource_namespace: "{{ item | regex_search(regex) }}"
  with_items: "{{ cert_manager_args }}"

# - debug:
#     var: cert_manager_cluster_resource_namespace

# 3. Set cert-manager variables
# -----------------------------------------------------------------------------
- name: Set Certificate Manager namespace
  set_fact:
    cert_manager_namespace: "{{ cert_manager_webhook_lookup.stdout }}"

- name: Set Certificate Manager Cluster Resource namespace (if not set)
  set_fact:
    cert_manager_cluster_resource_namespace: "{{ cert_manager_namespace }}"
  when: cert_manager_cluster_resource_namespace is not defined or cert_manager_cluster_resource_namespace == ''

- debug:
    msg:
      - "Certificate Manager namespace ............................... {{ cert_manager_namespace }}"
      - "Certificate Manager cluster resource namespace .............. {{ cert_manager_cluster_resource_namespace }}"
