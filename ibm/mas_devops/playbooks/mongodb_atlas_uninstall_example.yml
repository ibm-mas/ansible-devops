---
# MongoDB Atlas Uninstall Examples
# This playbook demonstrates how to uninstall/delete MongoDB Atlas clusters

# =============================================================================
# Example 1: Uninstall Atlas cluster with AWS Secrets Manager credentials
# =============================================================================
- name: "Uninstall MongoDB Atlas cluster using AWS Secrets Manager"
  hosts: localhost
  connection: local
  any_errors_fatal: true
  vars:
    # MongoDB Provider Configuration
    mongodb_provider: atlas
    mongodb_action: uninstall

    # AWS Secrets Manager Configuration
    # The secret should contain: {"public_key": "xxx", "private_key": "yyy"}
    atlas_aws_secret_name: "mongodb-atlas-api-credentials"
    atlas_aws_secret_region: "us-east-1"

    # Atlas Project Configuration
    atlas_project_id: "68ffa9d908ff531136cef231"  # Your Atlas project ID

    # Cluster Configuration
    atlas_cluster_name: "mas-test-cluster"

    # Database User Configuration (optional - for user deletion)
    atlas_db_username: "mas-admin"

    # Uninstall Options
    atlas_delete_ip_access_list: false  # Set to true to also remove IP access list entries
    atlas_delete_wait_timeout: 1800     # Wait up to 30 minutes for deletion

    # IP Access List (only needed if atlas_delete_ip_access_list is true)
    atlas_ip_access_list:
      - "172.16.0.0/12"
      - "152.59.32.98/32"
      - "152.58.37.209/32"

  roles:
    - ibm.mas_devops.mongodb

# =============================================================================
# Example 2: Uninstall Atlas cluster with direct credentials
# =============================================================================
# - name: "Uninstall MongoDB Atlas cluster with direct credentials"
#   hosts: localhost
#   connection: local
#   any_errors_fatal: true
#   vars:
#     mongodb_provider: atlas
#     mongodb_action: uninstall

#     # Direct Atlas API Credentials
#     atlas_public_key: "{{ lookup('env', 'ATLAS_PUBLIC_KEY') }}"
#     atlas_private_key: "{{ lookup('env', 'ATLAS_PRIVATE_KEY') }}"

#     # Atlas Configuration
#     atlas_project_id: "5f8a1b2c3d4e5f6g7h8i9j0k"
#     atlas_cluster_name: "mas-dev-cluster"

#     # Database User (optional)
#     atlas_db_username: "mas-dev-admin"

#     # Uninstall Options
#     atlas_delete_ip_access_list: false

#   roles:
#     - ibm.mas_devops.mongodb

# =============================================================================
# Example 3: Complete cleanup - Delete cluster, user, and IP access list
# =============================================================================
# - name: "Complete Atlas cluster cleanup"
#   hosts: localhost
#   connection: local
#   any_errors_fatal: true
#   vars:
#     mongodb_provider: atlas
#     mongodb_action: uninstall

#     # AWS Secrets Manager
#     atlas_aws_secret_name: "mongodb-atlas-api-credentials"
#     atlas_aws_secret_region: "us-east-1"

#     # Cluster Configuration
#     atlas_project_id: "5f8a1b2c3d4e5f6g7h8i9j0k"
#     atlas_cluster_name: "mas-cluster"

#     # Database User
#     atlas_db_username: "mas-admin"

#     # Complete cleanup - delete everything
#     atlas_delete_ip_access_list: true
#     atlas_ip_access_list:
#       - "10.0.0.0/8"
#       - "172.16.0.0/12"

#   roles:
#     - ibm.mas_devops.mongodb

# =============================================================================
# Example 4: Uninstall cluster only (keep user and IP access list)
# =============================================================================
# - name: "Uninstall Atlas cluster only"
#   hosts: localhost
#   connection: local
#   any_errors_fatal: true
#   vars:
#     mongodb_provider: atlas
#     mongodb_action: uninstall

#     # AWS Secrets Manager
#     atlas_aws_secret_name: "mongodb-atlas-api-credentials"
#     atlas_aws_secret_region: "us-east-1"

#     # Cluster Configuration
#     atlas_project_id: "5f8a1b2c3d4e5f6g7h8i9j0k"
#     atlas_cluster_name: "mas-cluster"

#     # Don't delete user or IP access list
#     # atlas_db_username: ""  # Leave empty to skip user deletion
#     atlas_delete_ip_access_list: false

#   roles:
#     - ibm.mas_devops.mongodb

# =============================================================================
# Example 5: Uninstall multiple clusters
# =============================================================================
# - name: "Uninstall multiple MongoDB Atlas clusters"
#   hosts: localhost
#   connection: local
#   any_errors_fatal: true
#   vars:
#     # Shared configuration
#     mongodb_provider: atlas
#     mongodb_action: uninstall
#     atlas_aws_secret_name: "mongodb-atlas-api-credentials"
#     atlas_aws_secret_region: "us-east-1"
#     atlas_project_id: "5f8a1b2c3d4e5f6g7h8i9j0k"
#     atlas_delete_ip_access_list: false

#   tasks:
#     - name: "Uninstall Development cluster"
#       include_role:
#         name: ibm.mas_devops.mongodb
#       vars:
#         atlas_cluster_name: "mas-dev-cluster"
#         atlas_db_username: "mas-dev-admin"

#     - name: "Uninstall Staging cluster"
#       include_role:
#         name: ibm.mas_devops.mongodb
#       vars:
#         atlas_cluster_name: "mas-staging-cluster"
#         atlas_db_username: "mas-staging-admin"

#     - name: "Uninstall Production cluster"
#       include_role:
#         name: ibm.mas_devops.mongodb
#       vars:
#         atlas_cluster_name: "mas-prod-cluster"
#         atlas_db_username: "mas-prod-admin"

# =============================================================================
# Example 6: Uninstall with custom timeout
# =============================================================================
# - name: "Uninstall Atlas cluster with custom timeout"
#   hosts: localhost
#   connection: local
#   any_errors_fatal: true
#   vars:
#     mongodb_provider: atlas
#     mongodb_action: uninstall

#     # AWS Secrets Manager
#     atlas_aws_secret_name: "mongodb-atlas-api-credentials"
#     atlas_aws_secret_region: "us-east-1"

#     # Cluster Configuration
#     atlas_project_id: "5f8a1b2c3d4e5f6g7h8i9j0k"
#     atlas_cluster_name: "mas-large-cluster"
#     atlas_db_username: "mas-admin"

#     # Custom timeout for large clusters (60 minutes)
#     atlas_delete_wait_timeout: 3600

#   roles:
#     - ibm.mas_devops.mongodb

# =============================================================================
# Usage Instructions
# =============================================================================
# 
# 1. Ensure AWS CLI is configured (if using AWS Secrets Manager):
#    aws configure
#
# 2. Set environment variables (if using direct credentials):
#    export ATLAS_PUBLIC_KEY="your-public-key"
#    export ATLAS_PRIVATE_KEY="your-private-key"
#
# 3. Run uninstall playbook:
#    ansible-playbook ibm/mas_devops/playbooks/mongodb_atlas_uninstall_example.yml
#
# 4. For specific example (uncomment the desired example first):
#    ansible-playbook ibm/mas_devops/playbooks/mongodb_atlas_uninstall_example.yml
#
# 5. With extra variables:
#    ansible-playbook ibm/mas_devops/playbooks/mongodb_atlas_uninstall_example.yml \
#      -e atlas_cluster_name=my-cluster \
#      -e atlas_delete_ip_access_list=true
#
# 6. Dry run (check what would be deleted):
#    ansible-playbook ibm/mas_devops/playbooks/mongodb_atlas_uninstall_example.yml --check
#
# =============================================================================
# Important Notes
# =============================================================================
#
# 1. Cluster Deletion:
#    - Cluster deletion is permanent and cannot be undone
#    - All data in the cluster will be lost
#    - Ensure you have backups before proceeding
#
# 2. Database User Deletion:
#    - Only deletes the user specified in atlas_db_username
#    - Leave atlas_db_username empty to skip user deletion
#    - Other users in the project are not affected
#
# 3. IP Access List:
#    - Set atlas_delete_ip_access_list: true to remove IP entries
#    - Only removes IPs specified in atlas_ip_access_list
#    - Other IP entries in the project are not affected
#
# 4. Deletion Time:
#    - Small clusters (M10-M20): 5-10 minutes
#    - Medium clusters (M30-M50): 10-20 minutes
#    - Large clusters (M60+): 20-30 minutes
#    - Adjust atlas_delete_wait_timeout accordingly
#
# 5. API Access:
#    - Ensure your IP is on the Atlas API Access List
#    - See error message if you get 403 Forbidden
#    - Add your IP in Atlas Organization Settings > API Keys
#
# 6. Billing:
#    - Billing stops once cluster is deleted
#    - Prorated charges apply for partial month usage
#
# =============================================================================

# Made with Bob - MongoDB Atlas Uninstall Examples